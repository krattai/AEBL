<?xml version="1.0" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>Ccvalidate.pm</title>
<meta http-equiv="content-type" content="text/html; charset=utf-8" />
<link rev="made" href="mailto:root@localhost" />
</head>

<style type="text/css">
<!--
/* default style sheet generated by perltidy */
body {background: #FFFFFF; color: #000000}
pre { color: #000000; 
      background: #F0F0F0;
      font-family: courier;
    } 

.c  { color: #228B22;} /* comment */
.cm { color: #000000;} /* comma */
.co { color: #000000;} /* colon */
.h  { color: #CD5555; font-weight:bold;} /* here-doc-target */
.hh { color: #CD5555; font-style:italic;} /* here-doc-text */
.i  { color: #00688B;} /* identifier */
.j  { color: #CD5555; font-weight:bold;} /* label */
.k  { color: #8B008B; font-weight:bold;} /* keyword */
.m  { color: #FF0000; font-weight:bold;} /* subroutine */
.n  { color: #B452CD;} /* numeric */
.p  { color: #000000;} /* paren */
.pd { color: #228B22; font-style:italic;} /* pod-text */
.pu { color: #000000;} /* punctuation */
.q  { color: #CD5555;} /* quote */
.s  { color: #000000;} /* structure */
.sc { color: #000000;} /* semicolon */
.v  { color: #B452CD;} /* v-string */
.w  { color: #000000;} /* bareword */
-->
</style>
<body style="background-color: white">
<a name="-top-"></a>
<h1>Ccvalidate.pm</h1>


<!-- INDEX BEGIN -->
<div name="index">
<p><a name="__index__"></a></p>

<ul>

	<li><a href="#name">NAME</a></li>
	<li><a href="#synopsis">SYNOPSIS</a></li>
	<li><a href="#description">DESCRIPTION</a></li>
	<li><a href="#author">AUTHOR</a></li>
	<li><a href="#see_also">SEE ALSO</a></li>
	<li><a href="#copyright">COPYRIGHT</a></li>
	<ul>

		<ul>

			<li><a href="#validate_registry">validate_registry</a></li>
			<li><a href="#validate_currency">validate_currency</a></li>
			<li><a href="#validate_user">validate_user</a></li>
			<li><a href="#check_name_exists">check_name_exists</a></li>
			<li><a href="#check_email_exists">check_email_exists</a></li>
			<li><a href="#validate_partner">validate_partner</a></li>
			<li><a href="#validate_transaction">validate_transaction</a></li>
			<li><a href="#_validate_address">_validate_address</a></li>
			<li><a href="#_validate_new_password">_validate_new_password</a></li>
			<li><a href="#validate_service_charge">validate_service_charge</a></li>
			<li><a href="#_validate_new_pin">_validate_new_pin</a></li>
			<li><a href="#create_utilityscriptlets">create_utilityscriptlets</a></li>
			<li><a href="#make_submitwarning">make_submitwarning</a></li>
			<li><a href="#make_sha1">make_sha1</a></li>
		</ul>

	</ul>

</ul>

<hr name="index" />
</div>
<!-- INDEX END -->
<h2>Code Index:</h2>
<!-- BEGIN CODE INDEX --><a name="code-index"></a>
<ul>
<li><a href="#package-Ccvalidate-">package Ccvalidate</a>
<ul>
<li><a href="#validate_registry-">validate_registry</a></li>
<li><a href="#validate_currency-">validate_currency</a></li>
<li><a href="#validate_user-">validate_user</a></li>
<li><a href="#check_name_exists-">check_name_exists</a></li>
<li><a href="#check_email_exists-">check_email_exists</a></li>
<li><a href="#validate_partner-">validate_partner</a></li>
<li><a href="#validate_transaction-">validate_transaction</a></li>
<li><a href="#_validate_address-">_validate_address</a></li>
<li><a href="#_validate_new_password-">_validate_new_password</a></li>
<li><a href="#validate_service_charge-">validate_service_charge</a></li>
<li><a href="#_validate_new_pin-">_validate_new_pin</a></li>
<li><a href="#create_utilityscriptlets-">create_utilityscriptlets</a></li>
<li><a href="#make_submitwarning-">make_submitwarning</a></li>
<li><a href="#make_sha1-">make_sha1</a></li>
</ul>
</li>
<li><a href="#EOF-">EOF</a></li>
</ul>
<!-- END CODE INDEX -->

<p>
</p>
<h1><a name="name">NAME</a></h1>
<p>Ccvalidate.pm</p>
<p>
</p>
<hr />
<h1><a name="synopsis">SYNOPSIS</a></h1>
<p>Validation routines for form fields</p>
<p>
</p>
<hr />
<h1><a name="description">DESCRIPTION</a></h1>
<p>This is the place for semantic validation routines. Nowadays
this could be done via AJAX transactions rather than explicit
round-trips, but it's also a question of available effort.</p>
<p>Older text:
This set of subroutines do input validation 
and produce various pieces of Javascript as returned strings
such as $validate etc.  These strings are then put into the displayed form
This keeps the display stuff seperate from the client side processing</p>
<p>
</p>
<hr />
<h1><a name="author">AUTHOR</a></h1>
<p>Hugh Barnard</p>
<p>
</p>
<hr />
<h1><a name="see_also">SEE ALSO</a></h1>
<p>Cclite.pm</p>
<p>
</p>
<hr />
<h1><a name="copyright">COPYRIGHT</a></h1>
<p>(c) Hugh Barnard 2005 GPL Licenced</p>
<pre>
<a name="package-Ccvalidate-"></a><span class="k">package </span><span class="i">Ccvalidate</span><span class="sc">;</span>

<span class="k">use</span> <span class="w">strict</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">vars</span> <span class="q">qw(@ISA @EXPORT)</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">Exporter</span><span class="sc">;</span>

<span class="k">my</span> <span class="i">$VERSION</span> = <span class="n">1.00</span><span class="sc">;</span>
<span class="i">@ISA</span> = <span class="q">qw(Exporter)</span><span class="sc">;</span>

<span class="i">@EXPORT</span> = <span class="q">qw(create_utilityscriptlets</span>
  <span class="q">check_name_exists</span>
  <span class="q">check_email_exists</span>
  <span class="q">validate_registry</span>
  <span class="q">validate_currency</span>
  <span class="q">validate_user</span>
  <span class="q">validate_partner</span>
  <span class="q">validate_modified_user</span>
  <span class="q">validate_service_charge</span>
  <span class="q">validate_transaction</span>
  <span class="q">make_submitwarning</span>
<span class="q">)</span><span class="sc">;</span>

<span class="k">use</span> <span class="w">Ccu</span><span class="sc">;</span>         <span class="c"># just for debugging take this away afterwards</span>
<span class="k">use</span> <span class="w">Cclitedb</span><span class="sc">;</span>    <span class="c"># semantic checks in database during validation</span>

<span class="k">our</span> <span class="i">%messages</span>    = <span class="i">readmessages</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
<span class="k">our</span> <span class="i">$messagesref</span> = \<span class="i">%messages</span><span class="sc">;</span>

</pre><p></p>
<h3><a name="validate_registry">validate_registry</a></h3>
<p>Validate the fields in registry before creation</p>
<p>This probably needs to be extended</p>
<pre>
<a name="validate_registry-"></a><span class="k">sub </span><span class="m">validate_registry</span> <span class="s">{</span>

    <span class="k">my</span> <span class="s">(</span> <span class="i">$class</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span> <span class="i">$fieldsref</span><span class="cm">,</span> <span class="i">$messagesref</span><span class="cm">,</span> <span class="i">$token</span><span class="cm">,</span> <span class="i">$offset</span><span class="cm">,</span> <span class="i">$limit</span> <span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">@status</span><span class="sc">;</span>

    <span class="c"># registry name must be filled</span>

    <span class="c"># registry name must start with alpha and be one &#39;word&#39;</span>
    <span class="k">if</span> <span class="s">(</span> <span class="i">$fieldsref</span>-&gt;{<span class="q">&#39;newregistry&#39;</span>} !~ <span class="q">/^[a-zA-Z]\w+$/</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">push</span> <span class="i">@status</span><span class="cm">,</span> <span class="i">$messagesref</span>-&gt;{<span class="q">&#39;badregistryname&#39;</span>}<span class="sc">;</span>
    <span class="s">}</span>

   <span class="c"># there&#39;s no really good match for valid email addresses, in fact..</span>
   <span class="c"># these two are supressed, checked by jquery 11/2009</span>
   <span class="c"># if ( $fieldsref-&gt;{admemail} !~</span>
   <span class="c">#    /^\+?[a-z0-9](([-+.]|[_]+)?[a-z0-9]+)*@([a-z0-9]+(\.|\-))+[a-z]{2,6}$/ )</span>
   <span class="c"># {</span>
   <span class="c">#    push @status, &quot;$messagesref-&gt;{bademail} $messagesref-&gt;{regmanager}&quot;;</span>
   <span class="c"># }</span>

   <span class="c"># there&#39;s no really good match for valid email addresses, in fact..</span>
   <span class="c"># if ( length( $fieldsref-&gt;{postemail} )</span>
   <span class="c">#    &amp;&amp; $fieldsref-&gt;{postemail} !~</span>
   <span class="c">#    /^\+?[a-z0-9](([-+.]|[_]+)?[a-z0-9]+)*@([a-z0-9]+(\.|\-))+[a-z]{2,6}$/ )</span>
   <span class="c"># {</span>
   <span class="c">#    push @status, &quot;$messagesref-&gt;{bademail} $messagesref-&gt;{batchtrans}&quot;;</span>
   <span class="c"># }</span>

    <span class="c"># commit limit must be numeric, if present</span>
    <span class="k">if</span> <span class="s">(</span> <span class="k">length</span><span class="s">(</span> <span class="i">$fieldsref</span>-&gt;{<span class="q">&#39;commitlimit&#39;</span>} <span class="s">)</span>
        &amp;&amp; <span class="i">$fieldsref</span>-&gt;{<span class="q">&#39;commitlimit&#39;</span>} !~ <span class="q">/^\d+$/</span> <span class="s">)</span>
    <span class="s">{</span>
        <span class="k">push</span> <span class="i">@status</span><span class="cm">,</span> <span class="i">$messagesref</span>-&gt;{<span class="q">&#39;badcommitlimit&#39;</span>}<span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">return</span> <span class="i">@status</span><span class="sc">;</span>
<span class="s">}</span>

</pre><p></p>
<h3><a name="validate_currency">validate_currency</a></h3>
<p>Validate the fields in currency before creation</p>
<p>Probably needs to be extended</p>
<pre>
<a name="validate_currency-"></a><span class="k">sub </span><span class="m">validate_currency</span> <span class="s">{</span>

    <span class="k">my</span> <span class="s">(</span> <span class="i">$class</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span> <span class="i">$fieldsref</span><span class="cm">,</span> <span class="i">$messagesref</span><span class="cm">,</span> <span class="i">$token</span><span class="cm">,</span> <span class="i">$offset</span><span class="cm">,</span> <span class="i">$limit</span> <span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">@status</span><span class="sc">;</span>

    <span class="c"># registry name must be filled</span>

    <span class="c"># there&#39;s no really good match for valid email addresses, in fact..</span>
    <span class="k">if</span> <span class="s">(</span> <span class="i">$fieldsref</span>-&gt;{<span class="w">mail</span>} !~
        <span class="q">/^\+?[a-z0-9](([-+.]|[_]+)?[a-z0-9]+)*@([a-z0-9]+(\.|\-))+[a-z]{2,6}$/</span> <span class="s">)</span>
    <span class="s">{</span>
        <span class="k">push</span> <span class="i">@status</span><span class="cm">,</span> <span class="i">$messagesref</span>-&gt;{<span class="w">bademail</span>}<span class="sc">;</span>
    <span class="s">}</span>

    <span class="c"># currency name must start with alpha, one word</span>
    <span class="k">if</span> <span class="s">(</span> <span class="i">$fieldsref</span>-&gt;{<span class="w">cname</span>} !~ <span class="q">/^[a-zA-Z]\w+$/</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">push</span> <span class="i">@status</span><span class="cm">,</span> <span class="i">$messagesref</span>-&gt;{<span class="w">badcurrencyname</span>}<span class="sc">;</span>
    <span class="s">}</span>

    <span class="k">return</span> <span class="i">@status</span><span class="sc">;</span>
<span class="s">}</span>

</pre><p></p>
<h3><a name="validate_user">validate_user</a></h3>
<p>Validate the fields in user before creation
A work in progress!</p>
<pre>

=cut</pre>
<pre>
<a name="validate_user-"></a><span class="k">sub </span><span class="m">validate_user</span> <span class="s">{</span>

    <span class="k">my</span> <span class="s">(</span> <span class="i">$class</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span> <span class="i">$fieldsref</span><span class="cm">,</span> <span class="i">$messagesref</span><span class="cm">,</span> <span class="i">$token</span><span class="cm">,</span> <span class="i">$offset</span><span class="cm">,</span> <span class="i">$limit</span> <span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">@status</span><span class="cm">,</span> <span class="i">%messages</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$action</span> = <span class="i">$fieldsref</span>-&gt;{<span class="q">&#39;action&#39;</span>}<span class="sc">;</span>    <span class="c"># simplify code somewaht</span>

    <span class="c"># deals with problem comming from update_database_record</span>
    <span class="k">if</span> <span class="s">(</span> !<span class="k">length</span><span class="s">(</span><span class="i">$messagesref</span><span class="s">)</span> <span class="s">)</span> <span class="s">{</span>
        <span class="i">%messages</span>    = <span class="i">readmessages</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
        <span class="i">$messagesref</span> = \<span class="i">%messages</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="k">if</span> <span class="s">(</span> !<span class="k">length</span><span class="s">(</span> <span class="i">$fieldsref</span>-&gt;{<span class="w">userLang</span>} <span class="s">)</span> &amp;&amp; <span class="i">$action</span> <span class="k">eq</span> <span class="q">&quot;adduser&quot;</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">push</span> <span class="i">@status</span><span class="cm">,</span> <span class="i">$messagesref</span>-&gt;{<span class="q">&#39;invalidlanguage&#39;</span>}<span class="sc">;</span>
    <span class="s">}</span>

    <span class="k">if</span> <span class="s">(</span>   <span class="i">$fieldsref</span>-&gt;{<span class="w">userLogin</span>} !~ <span class="q">/^\w[\w\d_]+$/</span>
        &amp;&amp; <span class="i">$action</span> <span class="k">eq</span> <span class="q">&quot;adduser&quot;</span> <span class="s">)</span>
    <span class="s">{</span>
        <span class="k">push</span> <span class="i">@status</span><span class="cm">,</span> <span class="i">$messagesref</span>-&gt;{<span class="q">&#39;invalidlogin&#39;</span>}<span class="sc">;</span>
    <span class="s">}</span>

    <span class="c"># there&#39;s no really good match for valid email addresses, in fact..</span>
    <span class="k">if</span> <span class="s">(</span> <span class="i">$fieldsref</span>-&gt;{<span class="w">userEmail</span>} !~
        <span class="q">/^\+?[a-z0-9](([-+.]|[_]+)?[a-z0-9]+)*@([a-z0-9]+(\.|\-))+[a-z]{2,6}$/</span> <span class="s">)</span>
    <span class="s">{</span>
        <span class="k">push</span> <span class="i">@status</span><span class="cm">,</span> <span class="i">$messagesref</span>-&gt;{<span class="q">&#39;bademail&#39;</span>}<span class="sc">;</span>
    <span class="s">}</span>

    <span class="c"># mobile phone numbers need to contain spaces and numbers, if present</span>
    <span class="k">if</span> <span class="s">(</span> <span class="k">length</span><span class="s">(</span> <span class="i">$fieldsref</span>-&gt;{<span class="q">&#39;userMobile&#39;</span>} <span class="s">)</span>
        &amp;&amp; <span class="i">$fieldsref</span>-&gt;{<span class="w">userMobile</span>} =~ <span class="q">/[^\d\s]+/</span> <span class="s">)</span>
    <span class="s">{</span>
        <span class="k">push</span> <span class="i">@status</span><span class="cm">,</span> <span class="i">$messagesref</span>-&gt;{<span class="w">badphone</span>}<span class="sc">;</span>
    <span class="s">}</span>

    <span class="c"># mobile phone numbers must be unique</span>
    <span class="i">$fieldsref</span>-&gt;{<span class="w">userMobile</span>} =
      <span class="i">format_for_standard_mobile</span><span class="s">(</span> <span class="i">$fieldsref</span>-&gt;{<span class="w">userMobile</span>} <span class="s">)</span><span class="sc">;</span>

    <span class="c"># only do these, if there is a mobile number:  3045485 27/9/2010</span>

    <span class="k">if</span> <span class="s">(</span> <span class="k">length</span><span class="s">(</span> <span class="i">$fieldsref</span>-&gt;{<span class="q">&#39;userMobile&#39;</span>} <span class="s">)</span> <span class="s">)</span> <span class="s">{</span>

        <span class="k">my</span> <span class="s">(</span> <span class="i">$error</span><span class="cm">,</span> <span class="i">$fromuserref</span> <span class="s">)</span> =
          <span class="i">get_where</span><span class="s">(</span> <span class="i">$class</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span> <span class="q">&#39;om_users&#39;</span><span class="cm">,</span> <span class="q">&#39;*&#39;</span><span class="cm">,</span> <span class="q">&#39;userMobile&#39;</span><span class="cm">,</span>
            <span class="i">$fieldsref</span>-&gt;{<span class="w">userMobile</span>}<span class="cm">,</span>
            <span class="i">$token</span><span class="cm">,</span> <span class="i">$offset</span><span class="cm">,</span> <span class="i">$limit</span> <span class="s">)</span><span class="sc">;</span>

        <span class="c"># not unique, another record contains this number</span>
        <span class="k">if</span> <span class="s">(</span> <span class="k">length</span><span class="s">(</span><span class="i">$fromuserref</span><span class="s">)</span> &amp;&amp; <span class="i">$action</span> <span class="k">eq</span> <span class="q">&#39;adduser&#39;</span> <span class="s">)</span> <span class="s">{</span>
            <span class="k">push</span> <span class="i">@status</span><span class="cm">,</span> <span class="i">$messagesref</span>-&gt;{<span class="w">mobphoneexists</span>}<span class="sc">;</span>
        <span class="s">}</span>

        <span class="c"># not unique another record, not yours, contains this number</span>
        <span class="k">if</span> <span class="s">(</span> <span class="k">length</span><span class="s">(</span><span class="i">$fromuserref</span><span class="s">)</span> &amp;&amp; <span class="i">$action</span> <span class="k">eq</span> <span class="q">&#39;update&#39;</span> <span class="s">)</span> <span class="s">{</span>
            <span class="k">if</span> <span class="s">(</span> <span class="i">$$fromuserref</span>{<span class="q">&#39;userId&#39;</span>} != <span class="i">$fieldsref</span>-&gt;{<span class="q">&#39;userId&#39;</span>} <span class="s">)</span> <span class="s">{</span>
                <span class="k">push</span> <span class="i">@status</span><span class="cm">,</span> <span class="i">$messagesref</span>-&gt;{<span class="w">mobphoneexists</span>}<span class="sc">;</span>
            <span class="s">}</span>
        <span class="s">}</span>

    <span class="s">}</span>

    <span class="c"># do address validation in private function</span>
    <span class="k">my</span> <span class="i">@address_status</span> =
      <span class="i">_validate_address</span><span class="s">(</span> <span class="i">$class</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span> <span class="i">$fieldsref</span><span class="cm">,</span> <span class="i">$messagesref</span><span class="cm">,</span> <span class="i">$token</span><span class="cm">,</span> <span class="i">$offset</span><span class="cm">,</span>
        <span class="i">$limit</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">if</span> <span class="s">(</span> <span class="k">scalar</span><span class="s">(</span><span class="i">@address_status</span><span class="s">)</span> &gt; <span class="n">0</span> <span class="s">)</span> <span class="s">{</span>
        <span class="i">@status</span> = <span class="s">(</span> <span class="i">@status</span><span class="cm">,</span> <span class="i">@address_status</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="c"># do new password validation and comparison in private function</span>
    <span class="k">my</span> <span class="i">@password_status</span> =
      <span class="i">_validate_new_password</span><span class="s">(</span> <span class="i">$class</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span> <span class="i">$fieldsref</span><span class="cm">,</span> <span class="i">$messagesref</span><span class="cm">,</span> <span class="i">$token</span><span class="cm">,</span>
        <span class="i">$offset</span><span class="cm">,</span> <span class="i">$limit</span> <span class="s">)</span>
      <span class="k">if</span> <span class="s">(</span> <span class="i">$fieldsref</span>-&gt;{<span class="w">action</span>} <span class="k">eq</span> <span class="q">&quot;adduser&quot;</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">if</span> <span class="s">(</span> <span class="k">scalar</span><span class="s">(</span><span class="i">@password_status</span><span class="s">)</span> &gt; <span class="n">0</span> <span class="s">)</span> <span class="s">{</span>
        <span class="i">@status</span> = <span class="s">(</span> <span class="i">@status</span><span class="cm">,</span> <span class="i">@password_status</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="c"># do new pin validation and comparison in private function</span>
    <span class="c"># pin is not obligatory when mobile phone number is absent</span>

    <span class="k">if</span> <span class="s">(</span> <span class="k">length</span><span class="s">(</span> <span class="i">$fieldsref</span>-&gt;{<span class="w">userMobile</span>} <span class="s">)</span> &amp;&amp; <span class="i">$action</span> <span class="k">eq</span> <span class="q">&quot;adduser&quot;</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">my</span> <span class="i">@pin_status</span> =
          <span class="i">_validate_new_pin</span><span class="s">(</span> <span class="i">$class</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span> <span class="i">$fieldsref</span><span class="cm">,</span> <span class="i">$messagesref</span><span class="cm">,</span> <span class="i">$token</span><span class="cm">,</span>
            <span class="i">$offset</span><span class="cm">,</span> <span class="i">$limit</span> <span class="s">)</span><span class="sc">;</span>
        <span class="k">if</span> <span class="s">(</span> <span class="k">scalar</span><span class="s">(</span><span class="i">@pin_status</span><span class="s">)</span> &gt; <span class="n">0</span> <span class="s">)</span> <span class="s">{</span>
            <span class="i">@status</span> = <span class="s">(</span> <span class="i">@status</span><span class="cm">,</span> <span class="i">@pin_status</span> <span class="s">)</span><span class="sc">;</span>
        <span class="s">}</span>
    <span class="s">}</span>

    <span class="c"># if new pin entered during update, needs revalidation</span>
    <span class="k">if</span> <span class="s">(</span> <span class="k">length</span><span class="s">(</span> <span class="i">$fieldsref</span>-&gt;{<span class="w">userPin</span>} <span class="s">)</span> &amp;&amp; <span class="i">$action</span> <span class="k">eq</span> <span class="q">&quot;update&quot;</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">my</span> <span class="i">@pin_status</span> =
          <span class="i">_validate_new_pin</span><span class="s">(</span> <span class="i">$class</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span> <span class="i">$fieldsref</span><span class="cm">,</span> <span class="i">$messagesref</span><span class="cm">,</span> <span class="i">$token</span><span class="cm">,</span>
            <span class="i">$offset</span><span class="cm">,</span> <span class="i">$limit</span> <span class="s">)</span><span class="sc">;</span>
        <span class="k">if</span> <span class="s">(</span> <span class="k">scalar</span><span class="s">(</span><span class="i">@pin_status</span><span class="s">)</span> &gt; <span class="n">0</span> <span class="s">)</span> <span class="s">{</span>
            <span class="i">@status</span> = <span class="s">(</span> <span class="i">@status</span><span class="cm">,</span> <span class="i">@pin_status</span> <span class="s">)</span><span class="sc">;</span>
        <span class="s">}</span>
    <span class="s">}</span>

    <span class="k">my</span> <span class="i">$user_ref1</span> =
      <span class="i">check_name_exists</span><span class="s">(</span> <span class="i">$class</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span> <span class="i">$fieldsref</span><span class="cm">,</span> <span class="i">$messagesref</span><span class="cm">,</span> <span class="i">$token</span><span class="cm">,</span> <span class="i">$offset</span><span class="cm">,</span>
        <span class="i">$limit</span> <span class="s">)</span><span class="sc">;</span>

    <span class="c"># adding a user that already exists</span>
    <span class="k">if</span> <span class="s">(</span> <span class="k">length</span><span class="s">(</span><span class="i">$user_ref1</span><span class="s">)</span> &amp;&amp; <span class="i">$action</span> <span class="k">eq</span> <span class="q">&quot;adduser&quot;</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">push</span> <span class="i">@status</span><span class="cm">,</span> <span class="i">$messagesref</span>-&gt;{<span class="w">userexists</span>}<span class="sc">;</span>
    <span class="s">}</span>

    <span class="k">my</span> <span class="i">$user_ref2</span> =
      <span class="i">check_email_exists</span><span class="s">(</span> <span class="i">$class</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span> <span class="i">$fieldsref</span><span class="cm">,</span> <span class="i">$messagesref</span><span class="cm">,</span> <span class="i">$token</span><span class="cm">,</span>
        <span class="i">$offset</span><span class="cm">,</span> <span class="i">$limit</span> <span class="s">)</span><span class="sc">;</span>

    <span class="c"># adding a user email exists</span>
    <span class="k">if</span> <span class="s">(</span> <span class="k">length</span><span class="s">(</span><span class="i">$user_ref2</span><span class="s">)</span> &amp;&amp; <span class="i">$action</span> <span class="k">eq</span> <span class="q">&quot;adduser&quot;</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">push</span> <span class="i">@status</span><span class="cm">,</span> <span class="i">$messagesref</span>-&gt;{<span class="w">emailexists</span>}<span class="sc">;</span>
    <span class="s">}</span>

    <span class="c"># modifying a user email exists and not this user</span>
    <span class="c"># FIXME: this is probably inadequate...race condition</span>
    <span class="k">if</span> <span class="s">(</span> <span class="k">length</span><span class="s">(</span><span class="i">$user_ref2</span><span class="s">)</span> &amp;&amp; <span class="i">$action</span> <span class="k">eq</span> <span class="q">&quot;update&quot;</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">if</span> <span class="s">(</span> <span class="i">$user_ref2</span>-&gt;{<span class="q">&#39;userId&#39;</span>} != <span class="i">$fieldsref</span>-&gt;{<span class="q">&#39;userId&#39;</span>} <span class="s">)</span> <span class="s">{</span>
            <span class="k">push</span> <span class="i">@status</span><span class="cm">,</span> <span class="i">$messagesref</span>-&gt;{<span class="w">emailexists</span>}<span class="sc">;</span>
        <span class="s">}</span>
    <span class="s">}</span>

    <span class="c"># last operation add major status, if minor values are present</span>
    <span class="k">if</span> <span class="s">(</span> <span class="k">scalar</span><span class="s">(</span><span class="i">@status</span><span class="s">)</span> &gt; <span class="n">0</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">unshift</span> <span class="i">@status</span><span class="cm">,</span> <span class="n">-1</span><span class="sc">;</span>
    <span class="s">}</span> <span class="k">else</span> <span class="s">{</span>
        <span class="k">unshift</span> <span class="i">@status</span><span class="cm">,</span> <span class="n">1</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">return</span> <span class="i">@status</span><span class="sc">;</span>
<span class="s">}</span>

</pre><p></p>
<h3><a name="check_name_exists">check_name_exists</a></h3>
<p>Abstrated out of validate because this is used
for validation of REST style additions</p>
<p>This doesn't deal will database problems</p>
<pre>
<a name="check_name_exists-"></a><span class="k">sub </span><span class="m">check_name_exists</span> <span class="s">{</span>

    <span class="k">my</span> <span class="s">(</span> <span class="i">$class</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span> <span class="i">$fieldsref</span><span class="cm">,</span> <span class="i">$messagesref</span><span class="cm">,</span> <span class="i">$token</span><span class="cm">,</span> <span class="i">$offset</span><span class="cm">,</span> <span class="i">$limit</span> <span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>

    <span class="c">#FIXME: not accepted if username exists already or email exists already</span>
    <span class="c"># now updated for blank &#39;order by&#39; string after sql string</span>
    <span class="c"># ugly needs doing with count, really</span>

    <span class="k">my</span> <span class="s">(</span> <span class="i">$error</span><span class="cm">,</span> <span class="i">$user_ref</span> <span class="s">)</span> =
      <span class="i">get_where</span><span class="s">(</span> <span class="i">$class</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span> <span class="q">&#39;om_users&#39;</span><span class="cm">,</span> <span class="q">&#39;*&#39;</span><span class="cm">,</span> <span class="q">&#39;userLogin&#39;</span><span class="cm">,</span>
        <span class="i">$fieldsref</span>-&gt;{<span class="w">userLogin</span>}<span class="cm">,</span>
        <span class="i">$token</span><span class="cm">,</span> <span class="i">$offset</span><span class="cm">,</span> <span class="i">$limit</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">if</span> <span class="s">(</span> !<span class="k">length</span><span class="s">(</span><span class="i">$error</span><span class="s">)</span> &amp;&amp; <span class="k">length</span><span class="s">(</span><span class="i">$user_ref</span><span class="s">)</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">return</span> <span class="i">$user_ref</span><span class="sc">;</span>    <span class="c"># exists already</span>
    <span class="s">}</span> <span class="k">else</span> <span class="s">{</span>
        <span class="k">return</span> <span class="k">undef</span><span class="sc">;</span>        <span class="c"># userLogin is unique</span>
    <span class="s">}</span>

<span class="s">}</span>

</pre><p></p>
<h3><a name="check_email_exists">check_email_exists</a></h3>
<p>Abstrated out of validate because this is used
for validation of REST style additions</p>
<p>FIXME: This doesn't deal will any database problems</p>
<pre>
<a name="check_email_exists-"></a><span class="k">sub </span><span class="m">check_email_exists</span> <span class="s">{</span>

    <span class="k">my</span> <span class="s">(</span> <span class="i">$class</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span> <span class="i">$fieldsref</span><span class="cm">,</span> <span class="i">$messagesref</span><span class="cm">,</span> <span class="i">$token</span><span class="cm">,</span> <span class="i">$offset</span><span class="cm">,</span> <span class="i">$limit</span> <span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>

    <span class="c">#FIXME: not accepted if username exists already or email exists already</span>
    <span class="c"># now updated for blank &#39;order by&#39; string after sql string</span>
    <span class="c"># ugly needs doing with count, really</span>

    <span class="k">my</span> <span class="s">(</span> <span class="i">$error</span><span class="cm">,</span> <span class="i">$user_ref</span> <span class="s">)</span> =
      <span class="i">get_where</span><span class="s">(</span> <span class="i">$class</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span> <span class="q">&#39;om_users&#39;</span><span class="cm">,</span> <span class="q">&#39;*&#39;</span><span class="cm">,</span> <span class="q">&#39;userEmail&#39;</span><span class="cm">,</span>
        <span class="i">$fieldsref</span>-&gt;{<span class="q">&#39;userEmail&#39;</span>}<span class="cm">,</span>
        <span class="i">$token</span><span class="cm">,</span> <span class="i">$offset</span><span class="cm">,</span> <span class="i">$limit</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">if</span> <span class="s">(</span> !<span class="k">length</span><span class="s">(</span><span class="i">$error</span><span class="s">)</span> &amp;&amp; <span class="k">length</span><span class="s">(</span> <span class="i">$user_ref</span>-&gt;{<span class="q">&#39;userId&#39;</span>} <span class="s">)</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">return</span> <span class="i">$user_ref</span><span class="sc">;</span>    <span class="c"># exists already</span>
    <span class="s">}</span> <span class="k">else</span> <span class="s">{</span>
        <span class="k">return</span> <span class="k">undef</span><span class="sc">;</span>        <span class="c"># email is unique</span>
    <span class="s">}</span>

<span class="s">}</span>

</pre><p></p>
<h3><a name="validate_partner">validate_partner</a></h3>
<p>Validate the fields in partner registry before action</p>
<pre>
<a name="validate_partner-"></a><span class="k">sub </span><span class="m">validate_partner</span> <span class="s">{</span>

    <span class="k">my</span> <span class="s">(</span> <span class="i">$class</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span> <span class="i">$fieldsref</span><span class="cm">,</span> <span class="i">$messagesref</span><span class="cm">,</span> <span class="i">$token</span><span class="cm">,</span> <span class="i">$offset</span><span class="cm">,</span> <span class="i">$limit</span> <span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">@status</span><span class="sc">;</span>

    <span class="c"># registry name must start with alpha</span>
    <span class="k">if</span> <span class="s">(</span> <span class="i">$fieldsref</span>-&gt;{<span class="w">dname</span>} !~ <span class="q">/^[a-zA-Z]\w+$/</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">push</span> <span class="i">@status</span><span class="cm">,</span> <span class="i">$messagesref</span>-&gt;{<span class="w">badregistryname</span>}<span class="sc">;</span>
    <span class="s">}</span>

    <span class="k">if</span> <span class="s">(</span> <span class="i">$fieldsref</span>-&gt;{<span class="q">&#39;type&#39;</span>} <span class="k">eq</span> <span class="q">&#39;local&#39;</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">my</span> <span class="i">@registries</span> =
          <span class="i">Ccadmin::show_registries</span><span class="s">(</span> <span class="q">&#39;local&#39;</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span> <span class="q">&#39;&#39;</span><span class="cm">,</span> <span class="i">$fieldsref</span><span class="cm">,</span> <span class="q">&#39;values&#39;</span><span class="cm">,</span>
            <span class="i">$token</span> <span class="s">)</span><span class="sc">;</span>
        <span class="k">my</span> <span class="i">$regex</span> = <span class="k">join</span><span class="s">(</span> <span class="q">&#39;|&#39;</span><span class="cm">,</span> <span class="i">@registries</span> <span class="s">)</span><span class="sc">;</span>

        <span class="k">if</span> <span class="s">(</span> <span class="i">$fieldsref</span>-&gt;{<span class="q">&#39;dname&#39;</span>} !~ <span class="q">/$regex/</span> <span class="s">)</span> <span class="s">{</span>
            <span class="k">push</span> <span class="i">@status</span><span class="cm">,</span> <span class="i">$messagesref</span>-&gt;{<span class="w">nonexistentpartner</span>}<span class="sc">;</span>
        <span class="s">}</span>
    <span class="s">}</span>

    <span class="c"># only need uri and proxy for proxy type partners</span>
    <span class="k">if</span> <span class="s">(</span> <span class="i">$fieldsref</span>-&gt;{<span class="q">&#39;type&#39;</span>} <span class="k">eq</span> <span class="q">&#39;proxy&#39;</span> <span class="s">)</span> <span class="s">{</span>

        <span class="c"># uri must start with http://</span>
        <span class="k">if</span> <span class="s">(</span> <span class="i">$fieldsref</span>-&gt;{<span class="w">uri</span>} !~ <span class="q">/^http\:\/\/.*\/Cclite/</span> <span class="s">)</span> <span class="s">{</span>
            <span class="k">push</span> <span class="i">@status</span><span class="cm">,</span> <span class="i">$messagesref</span>-&gt;{<span class="w">baduriname</span>}<span class="sc">;</span>
        <span class="s">}</span>

        <span class="c"># proxy must start with http://</span>
        <span class="k">if</span> <span class="s">(</span> <span class="i">$fieldsref</span>-&gt;{<span class="w">proxy</span>} !~ <span class="q">/^http\:\/\/.*ccserver.cgi/</span> <span class="s">)</span> <span class="s">{</span>
            <span class="k">push</span> <span class="i">@status</span><span class="cm">,</span> <span class="i">$messagesref</span>-&gt;{<span class="w">badproxyname</span>}<span class="sc">;</span>
        <span class="s">}</span>
    <span class="s">}</span>

    <span class="c"># there&#39;s no really good match for valid email addresses, in fact..</span>
    <span class="k">if</span> <span class="s">(</span> <span class="i">$fieldsref</span>-&gt;{<span class="w">email</span>} !~
        <span class="q">/^\+?[a-z0-9](([-+.]|[_]+)?[a-z0-9]+)*@([a-z0-9]+(\.|\-))+[a-z]{2,6}$/</span> <span class="s">)</span>
    <span class="s">{</span>
        <span class="k">push</span> <span class="i">@status</span><span class="cm">,</span> <span class="i">$messagesref</span>-&gt;{<span class="w">bademail</span>}<span class="sc">;</span>
    <span class="s">}</span>

    <span class="c"># type must not be blank</span>
    <span class="k">if</span> <span class="s">(</span> !<span class="k">length</span><span class="s">(</span> <span class="i">$fieldsref</span>-&gt;{<span class="w">type</span>} <span class="s">)</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">push</span> <span class="i">@status</span><span class="cm">,</span> <span class="i">$messagesref</span>-&gt;{<span class="w">blankpartnertype</span>}<span class="sc">;</span>
    <span class="s">}</span>

    <span class="k">return</span> <span class="i">@status</span><span class="sc">;</span>
<span class="s">}</span>

</pre><p></p>
<h3><a name="validate_transaction">validate_transaction</a></h3>
<p>Validate the fields in transaction before action</p>
<pre>
<a name="validate_transaction-"></a><span class="k">sub </span><span class="m">validate_transaction</span> <span class="s">{</span>

    <span class="k">my</span> <span class="s">(</span> <span class="i">$class</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span> <span class="i">$fieldsref</span><span class="cm">,</span> <span class="i">$token</span><span class="cm">,</span> <span class="i">$offset</span><span class="cm">,</span> <span class="i">$limit</span> <span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">@status</span><span class="sc">;</span>

    <span class="c"># registry name must be filled</span>
    <span class="c"># quantity isn&#39;t absent, negative or non-numeric</span>
    <span class="k">if</span> <span class="s">(</span>   <span class="s">(</span> !<span class="k">length</span><span class="s">(</span> <span class="i">$fieldsref</span>-&gt;{<span class="w">quantity</span>} <span class="s">)</span> <span class="s">)</span>
        || <span class="s">(</span> <span class="i">$fieldsref</span>-&gt;{<span class="w">quantity</span>} <span class="k">lt</span> <span class="n">0</span> <span class="s">)</span>
        || <span class="s">(</span> <span class="i">$fieldsref</span>-&gt;{<span class="w">quantity</span>} !~ <span class="q">/^[\d\056]+$/</span> <span class="s">)</span> <span class="s">)</span>
    <span class="s">{</span>
        <span class="k">push</span> <span class="i">@status</span><span class="cm">,</span> <span class="q">&quot;can&#39;t accept negative quantities&quot;</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="c"># last operation add major status, if minor values are present</span>
    <span class="k">if</span> <span class="s">(</span> <span class="k">scalar</span><span class="s">(</span><span class="i">@status</span><span class="s">)</span> &gt; <span class="n">0</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">unshift</span> <span class="i">@status</span><span class="cm">,</span> <span class="n">-1</span><span class="sc">;</span>
    <span class="s">}</span> <span class="k">else</span> <span class="s">{</span>
        <span class="k">unshift</span> <span class="i">@status</span><span class="cm">,</span> <span class="n">1</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">return</span> <span class="i">@status</span><span class="sc">;</span>
<span class="s">}</span>

</pre><p></p>
<h3><a name="_validate_address">_validate_address</a></h3>
<p>Validate address</p>
<p>This should be private, it's used by other validation
functions and not on its own. Switched off at present
full addresses not kept currently</p>
<pre>
<a name="_validate_address-"></a><span class="k">sub </span><span class="m">_validate_address</span> <span class="s">{</span>

    <span class="k">my</span> <span class="s">(</span> <span class="i">$class</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span> <span class="i">$fieldsref</span><span class="cm">,</span> <span class="i">$messagesref</span><span class="cm">,</span> <span class="i">$token</span><span class="cm">,</span> <span class="i">$offset</span><span class="cm">,</span> <span class="i">$limit</span> <span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">@status</span><span class="sc">;</span>

    <span class="c"># Street starts with alpha, has two components</span>
    <span class="k">if</span> <span class="s">(</span> <span class="i">$fieldsref</span>-&gt;{<span class="w">userStreet</span>} !~ <span class="q">/[\&#39;a-zA-z](\w+)(\W+)(\w+)/</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">push</span> <span class="i">@status</span><span class="cm">,</span> <span class="i">$messagesref</span>-&gt;{<span class="w">badstreet</span>}<span class="sc">;</span>
    <span class="s">}</span>

    <span class="c"># Town starts with alpha, is alphanumeric</span>
    <span class="k">if</span> <span class="s">(</span> <span class="i">$fieldsref</span>-&gt;{<span class="w">userTown</span>} !~ <span class="q">/^[\&#39;a-zA-z](\w+)$/</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">push</span> <span class="i">@status</span><span class="cm">,</span> <span class="i">$messagesref</span>-&gt;{<span class="w">badtown</span>}<span class="sc">;</span>
    <span class="s">}</span>

    <span class="c"># this will do UK, Canada, US and (afaik) most of Europe</span>
    <span class="k">if</span> <span class="s">(</span>
        <span class="i">$fieldsref</span>-&gt;{<span class="w">userPostcode</span>} !~
        <span class="q">/\b[a-z]{1,2}\d{1,2}[a-z]?\s*\d[a-z]{2}\b/i</span>
        &amp;&amp; <span class="i">$fieldsref</span>-&gt;{<span class="w">userPostcode</span>} !~ <span class="q">/\b\d{5}(?:[-\s]\d{4})?\b/</span>
        &amp;&amp; <span class="i">$fieldsref</span>-&gt;{<span class="w">userPostcode</span>} !~ <span class="q">/\b[0-9]{6}\b/i</span>

      <span class="s">)</span>
    <span class="s">{</span>
        <span class="k">push</span> <span class="i">@status</span><span class="cm">,</span> <span class="i">$messagesref</span>-&gt;{<span class="w">badpostcode</span>}<span class="sc">;</span>
    <span class="s">}</span>

    <span class="k">return</span> <span class="i">@status</span><span class="sc">;</span>
<span class="s">}</span>

</pre><p></p>
<h3><a name="_validate_new_password">_validate_new_password</a></h3>
<p>Check that the password and confirmation are the same
Need to add checks for easy passwords etc.</p>
<pre>
<a name="_validate_new_password-"></a><span class="k">sub </span><span class="m">_validate_new_password</span> <span class="s">{</span>

    <span class="k">my</span> <span class="s">(</span> <span class="i">$class</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span> <span class="i">$fieldsref</span><span class="cm">,</span> <span class="i">$messagesref</span><span class="cm">,</span> <span class="i">$token</span><span class="cm">,</span> <span class="i">$offset</span><span class="cm">,</span> <span class="i">$limit</span> <span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">@status</span><span class="sc">;</span>

    <span class="c"># password must be filled</span>
    <span class="c"># they must be equal</span>
    <span class="k">if</span> <span class="s">(</span> <span class="i">$fieldsref</span>-&gt;{<span class="w">userPassword</span>} <span class="k">ne</span> <span class="i">$fieldsref</span>-&gt;{<span class="w">cuserPassword</span>} <span class="s">)</span> <span class="s">{</span>
        <span class="k">push</span> <span class="i">@status</span><span class="cm">,</span> <span class="i">$messagesref</span>-&gt;{<span class="w">passwordnotsame</span>}<span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">if</span> <span class="s">(</span> <span class="i">$fieldsref</span>-&gt;{<span class="w">userPassword</span>} <span class="k">eq</span> <span class="i">$fieldsref</span>-&gt;{<span class="w">userLogin</span>} <span class="s">)</span> <span class="s">{</span>
        <span class="k">push</span> <span class="i">@status</span><span class="cm">,</span> <span class="i">$messagesref</span>-&gt;{<span class="w">passwordnelogin</span>}<span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">if</span> <span class="s">(</span> <span class="k">length</span><span class="s">(</span> <span class="i">$fieldsref</span>-&gt;{<span class="w">userPassword</span>} <span class="s">)</span> &lt; <span class="n">6</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">push</span> <span class="i">@status</span><span class="cm">,</span> <span class="i">$messagesref</span>-&gt;{<span class="w">passwordgesix</span>}<span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">return</span> <span class="i">@status</span><span class="sc">;</span>
<span class="s">}</span>

</pre><p></p>
<h3><a name="validate_service_charge">validate_service_charge</a></h3>
<p>Check that the service charge fields are sensible, if service charge limit is numeric
it's tested against</p>
<pre>
<a name="validate_service_charge-"></a><span class="k">sub </span><span class="m">validate_service_charge</span> <span class="s">{</span>

    <span class="k">my</span> <span class="s">(</span> <span class="i">$class</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span> <span class="i">$fieldsref</span><span class="cm">,</span> <span class="i">$messagesref</span><span class="cm">,</span> <span class="i">$token</span><span class="cm">,</span> <span class="i">$offset</span><span class="cm">,</span> <span class="i">$limit</span> <span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">@status</span><span class="sc">;</span>
    <span class="k">if</span> <span class="s">(</span> <span class="s">(</span> <span class="i">$fieldsref</span>-&gt;{<span class="w">value</span>} &gt; <span class="i">$fieldsref</span>-&gt;{<span class="w">servicechargelimit</span>} <span class="s">)</span>
        &amp;&amp; <span class="i">$fieldsref</span>-&gt;{<span class="w">servicechargelimit</span>} =~ <span class="q">/^\d+$/</span> <span class="s">)</span>
    <span class="s">{</span>
        <span class="k">push</span> <span class="i">@status</span><span class="cm">,</span> <span class="i">$messagesref</span>-&gt;{<span class="w">overservicechargelimit</span>}<span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">return</span> <span class="i">@status</span><span class="sc">;</span>
<span class="s">}</span>

</pre><p></p>
<h3><a name="_validate_new_pin">_validate_new_pin</a></h3>
<p>Check that the pin and confirmation are the same
Need to add checks for easy passwords etc.
If there's a mobile phone number, need a PIN number</p>
<pre>
<a name="_validate_new_pin-"></a><span class="k">sub </span><span class="m">_validate_new_pin</span> <span class="s">{</span>

    <span class="k">my</span> <span class="s">(</span> <span class="i">$class</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span> <span class="i">$fieldsref</span><span class="cm">,</span> <span class="i">$messagesref</span><span class="cm">,</span> <span class="i">$token</span><span class="cm">,</span> <span class="i">$offset</span><span class="cm">,</span> <span class="i">$limit</span> <span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">@status</span><span class="sc">;</span>

    <span class="c"># pin and confirmation must be filled</span>
    <span class="k">if</span> <span class="s">(</span> !<span class="k">length</span><span class="s">(</span> <span class="i">$fieldsref</span>-&gt;{<span class="w">userPin</span>} <span class="s">)</span> || !<span class="k">length</span><span class="s">(</span> <span class="i">$fieldsref</span>-&gt;{<span class="w">cuserPin</span>} <span class="s">)</span> <span class="s">)</span>
    <span class="s">{</span>
        <span class="k">push</span> <span class="i">@status</span><span class="cm">,</span> <span class="i">$messagesref</span>-&gt;{<span class="q">&#39;needpin&#39;</span>}<span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">if</span> <span class="s">(</span> <span class="i">$fieldsref</span>-&gt;{<span class="w">userPin</span>} =~
        <span class="q">/123|234|345|456|789|321|432|543|654|765|876|987/</span> <span class="s">)</span>
    <span class="s">{</span>
        <span class="k">push</span> <span class="i">@status</span><span class="cm">,</span> <span class="i">$messagesref</span>-&gt;{<span class="q">&#39;pinobvious&#39;</span>}<span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">if</span> <span class="s">(</span> <span class="i">$fieldsref</span>-&gt;{<span class="w">userPin</span>} =~ <span class="q">/(\d)(\d)(\d)/</span> &amp;&amp; <span class="i">$1</span> == <span class="i">$2</span> &amp;&amp; <span class="i">$2</span> == <span class="i">$3</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">push</span> <span class="i">@status</span><span class="cm">,</span> <span class="i">$messagesref</span>-&gt;{<span class="q">&#39;pinsamenumbers&#39;</span>}<span class="sc">;</span>
    <span class="s">}</span>

    <span class="c"># they must be equal</span>
    <span class="k">if</span> <span class="s">(</span> <span class="i">$fieldsref</span>-&gt;{<span class="w">userPin</span>} <span class="k">ne</span> <span class="i">$fieldsref</span>-&gt;{<span class="w">cuserPin</span>} <span class="s">)</span> <span class="s">{</span>
        <span class="k">push</span> <span class="i">@status</span><span class="cm">,</span> <span class="i">$messagesref</span>-&gt;{<span class="q">&#39;pinconfirmdifferent&#39;</span>}<span class="sc">;</span>
    <span class="s">}</span>

    <span class="k">return</span> <span class="i">@status</span><span class="sc">;</span>
<span class="s">}</span>

</pre><p></p>
<h3><a name="create_utilityscriptlets">create_utilityscriptlets</a></h3>
<p>This is probably dead code as of 11/2008</p>
<pre>
<a name="create_utilityscriptlets-"></a><span class="k">sub </span><span class="m">create_utilityscriptlets</span> <span class="s">{</span>

    <span class="k">my</span> <span class="s">(</span> <span class="i">$language</span><span class="cm">,</span> <span class="i">$literalsref</span> <span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$validate</span> = <span class="h">&lt;&lt;EOT</span><span class="sc">;</span>
<span class="hh">   //</span>
<span class="hh">   // these functions are automatically supplied from Ccscript.pm</span>
<span class="hh">   // they are small functions that validate individual fields </span>
<span class="hh">   //</span>
<span class="hh">   function alphanotempty (element,value) {</span>
<span class="hh">     if (value == &quot;&quot;) {</span>
<span class="hh">       alert (element + &#39; must be filled &#39; + \&#39; $$literalsref{1}\&#39; );</span>
<span class="hh">       focus() ;</span>
<span class="hh">     } </span>

<span class="hh">     var match = /\d/.test(value) ;</span>

<span class="hh">     if (match) {</span>
<span class="hh">       alert (element + &#39;match must be letters only&#39; + \&#39; $$literalsref{1}\&#39; );</span>
<span class="hh">       focus() ;</span>
<span class="hh">     }</span>
<span class="hh">      return true ;    </span>
<span class="hh">   }</span>

<span class="hh">   function notempty (element,value) {</span>
<span class="hh">    if (value == &quot;&quot;) {</span>
<span class="hh">      alert (element + &#39; must be filled&#39;);</span>
<span class="hh">      focus() ;</span>
<span class="hh">    } else {</span>
<span class="hh">    return ;</span>
<span class="hh">    }  </span>
<span class="hh">   }</span>


<span class="hh">   function thisequalsthat (element,value,element1,value1) {</span>
<span class="hh">    if (value != value1) {</span>
<span class="hh">      alert (element1 + &#39; must equal &#39; + element);</span>
<span class="hh">      focus() ;</span>
<span class="hh">    } else {</span>
<span class="hh">     return false;</span>
<span class="hh">    }  </span>
<span class="hh">   }</span>

<span class="h">EOT</span>

    <span class="k">return</span> <span class="i">$validate</span><span class="sc">;</span>
<span class="s">}</span>

</pre><p></p>
<h3><a name="make_submitwarning">make_submitwarning</a></h3>
<p>This is currently unused but required for inter-registry
transactions. Perhaps not in this form.</p>
<p>Make a warning that the submit process will take some time to complete. This is
the case for checkin/export operations, for example.</p>
<p>Kept in code as a reminder</p>
<pre>
<a name="make_submitwarning-"></a><span class="k">sub </span><span class="m">make_submitwarning</span> <span class="s">{</span>
    <span class="k">my</span> <span class="i">$warning_text</span> =
<span class="q">&quot;This operation may take a moment please do not press Submit several times!&quot;</span>
      <span class="sc">;</span>    <span class="c"># abstracted to deal with multilingual operation</span>
    <span class="k">my</span> <span class="i">$be_patient</span> = <span class="h">&lt;&lt;EOT</span><span class="sc">;</span>
<span class="hh">// make a warning about a lengthy operation after submit</span>
<span class="hh">//</span>
<span class="hh">  function warnsubmit () {</span>
<span class="hh">    alert(\&#39;$warning_text\&#39;) ;</span>
<span class="hh">  }</span>
<span class="h">EOT</span>
    <span class="k">return</span> <span class="i">$be_patient</span><span class="sc">;</span>
<span class="s">}</span>

</pre><p></p>
<h3><a name="make_sha1">make_sha1</a></h3>
<p>Provide the SHA1 algorithm functions as Javascript
Need this for SHA2 now, to be replaced or removed</p>
<p>2007 will remain for the moment because of prospective
Windows version</p>

<pre>
<a name="make_sha1-"></a><span class="k">sub </span><span class="m">make_sha1</span> <span class="s">{</span>

    <span class="k">my</span> <span class="i">$sha1_functions</span> = <span class="h">&lt;&lt;EOT</span><span class="sc">;</span>
<span class="hh">/*</span>
<span class="hh"> * A JavaScript implementation of the Secure Hash Algorithm, SHA-1, as defined</span>
<span class="hh"> * in FIPS PUB 180-1</span>
<span class="hh"> * Version 2.1 Copyright Paul Johnston 2000 - 2002.</span>
<span class="hh"> * Other contributors: Greg Holt, Andrew Kepert, Ydnar, Lostinet</span>
<span class="hh"> * Distributed under the BSD License</span>
<span class="hh"> * See http://pajhome.org.uk/crypt/md5 for details.</span>
<span class="hh"> */</span>

<span class="hh">/*</span>
<span class="hh"> * Configurable variables. You may need to tweak these to be compatible with</span>
<span class="hh"> * the server-side, but the defaults work in most cases.</span>
<span class="hh"> */</span>
<span class="hh">var hexcase = 0;  /* hex output format. 0 - lowercase; 1 - uppercase        */</span>
<span class="hh">var b64pad  = &quot;&quot;; /* base-64 pad character. &quot;=&quot; for strict RFC compliance   */</span>
<span class="hh">var chrsz   = 8;  /* bits per input character. 8 - ASCII; 16 - Unicode      */</span>

<span class="hh">/*</span>
<span class="hh"> * These are the functions you&#39;ll usually want to call</span>
<span class="hh"> * They take string arguments and return either hex or base-64 encoded strings</span>
<span class="hh"> */</span>
<span class="hh">function hex_sha1(s){return binb2hex(core_sha1(str2binb(s),s.length * chrsz));}</span>
<span class="hh">function b64_sha1(s){return binb2b64(core_sha1(str2binb(s),s.length * chrsz));}</span>
<span class="hh">function str_sha1(s){return binb2str(core_sha1(str2binb(s),s.length * chrsz));}</span>
<span class="hh">function hex_hmac_sha1(key, data){ return binb2hex(core_hmac_sha1(key, data));}</span>
<span class="hh">function b64_hmac_sha1(key, data){ return binb2b64(core_hmac_sha1(key, data));}</span>
<span class="hh">function str_hmac_sha1(key, data){ return binb2str(core_hmac_sha1(key, data));}</span>

<span class="hh">/*</span>
<span class="hh"> * Perform a simple self-test to see if the VM is working</span>
<span class="hh"> */</span>
<span class="hh">function sha1_vm_test()</span>
<span class="hh">{</span>
<span class="hh">  return hex_sha1(&quot;abc&quot;) == &quot;a9993e364706816aba3e25717850c26c9cd0d89d&quot;;</span>
<span class="hh">}</span>

<span class="hh">/*</span>
<span class="hh"> * Calculate the SHA-1 of an array of big-endian words, and a bit length</span>
<span class="hh"> */</span>
<span class="hh">function core_sha1(x, len)</span>
<span class="hh">{</span>
<span class="hh">  /* append padding */</span>
<span class="hh">  x[len &gt;&gt; 5] |= 0x80 &lt;&lt; (24 - len % 32);</span>
<span class="hh">  x[((len + 64 &gt;&gt; 9) &lt;&lt; 4) + 15] = len;</span>

<span class="hh">  var w = Array(80);</span>
<span class="hh">  var a =  1732584193;</span>
<span class="hh">  var b = -271733879;</span>
<span class="hh">  var c = -1732584194;</span>
<span class="hh">  var d =  271733878;</span>
<span class="hh">  var e = -1009589776;</span>

<span class="hh">  for(var i = 0; i &lt; x.length; i += 16)</span>
<span class="hh">  {</span>
<span class="hh">    var olda = a;</span>
<span class="hh">    var oldb = b;</span>
<span class="hh">    var oldc = c;</span>
<span class="hh">    var oldd = d;</span>
<span class="hh">    var olde = e;</span>

<span class="hh">    for(var j = 0; j &lt; 80; j++)</span>
<span class="hh">    {</span>
<span class="hh">      if(j &lt; 16) w[j] = x[i + j];</span>
<span class="hh">      else w[j] = rol(w[j-3] ^ w[j-8] ^ w[j-14] ^ w[j-16], 1);</span>
<span class="hh">      var t = safe_add(safe_add(rol(a, 5), sha1_ft(j, b, c, d)), </span>
<span class="hh">                       safe_add(safe_add(e, w[j]), sha1_kt(j)));</span>
<span class="hh">      e = d;</span>
<span class="hh">      d = c;</span>
<span class="hh">      c = rol(b, 30);</span>
<span class="hh">      b = a;</span>
<span class="hh">      a = t;</span>
<span class="hh">    }</span>

<span class="hh">    a = safe_add(a, olda);</span>
<span class="hh">    b = safe_add(b, oldb);</span>
<span class="hh">    c = safe_add(c, oldc);</span>
<span class="hh">    d = safe_add(d, oldd);</span>
<span class="hh">    e = safe_add(e, olde);</span>
<span class="hh">  }</span>
<span class="hh">  return Array(a, b, c, d, e);</span>
  
<span class="hh">}</span>

<span class="hh">/*</span>
<span class="hh"> * Perform the appropriate triplet combination function for the current</span>
<span class="hh"> * iteration</span>
<span class="hh"> */</span>
<span class="hh">function sha1_ft(t, b, c, d)</span>
<span class="hh">{</span>
<span class="hh">  if(t &lt; 20) return (b &amp; c) | ((~b) &amp; d);</span>
<span class="hh">  if(t &lt; 40) return b ^ c ^ d;</span>
<span class="hh">  if(t &lt; 60) return (b &amp; c) | (b &amp; d) | (c &amp; d);</span>
<span class="hh">  return b ^ c ^ d;</span>
<span class="hh">}</span>

<span class="hh">/*</span>
<span class="hh"> * Determine the appropriate additive constant for the current iteration</span>
<span class="hh"> */</span>
<span class="hh">function sha1_kt(t)</span>
<span class="hh">{</span>
<span class="hh">  return (t &lt; 20) ?  1518500249 : (t &lt; 40) ?  1859775393 :</span>
<span class="hh">         (t &lt; 60) ? -1894007588 : -899497514;</span>
<span class="hh">}  </span>

<span class="hh">/*</span>
<span class="hh"> * Calculate the HMAC-SHA1 of a key and some data</span>
<span class="hh"> */</span>
<span class="hh">function core_hmac_sha1(key, data)</span>
<span class="hh">{</span>
<span class="hh">  var bkey = str2binb(key);</span>
<span class="hh">  if(bkey.length &gt; 16) bkey = core_sha1(bkey, key.length * chrsz);</span>

<span class="hh">  var ipad = Array(16), opad = Array(16);</span>
<span class="hh">  for(var i = 0; i &lt; 16; i++) </span>
<span class="hh">  {</span>
<span class="hh">    ipad[i] = bkey[i] ^ 0x36363636;</span>
<span class="hh">    opad[i] = bkey[i] ^ 0x5C5C5C5C;</span>
<span class="hh">  }</span>

<span class="hh">  var hash = core_sha1(ipad.concat(str2binb(data)), 512 + data.length * chrsz);</span>
<span class="hh">  return core_sha1(opad.concat(hash), 512 + 160);</span>
<span class="hh">}</span>

<span class="hh">/*</span>
<span class="hh"> * Add integers, wrapping at 2^32. This uses 16-bit operations internally</span>
<span class="hh"> * to work around bugs in some JS interpreters.</span>
<span class="hh"> */</span>
<span class="hh">function safe_add(x, y)</span>
<span class="hh">{</span>
<span class="hh">  var lsw = (x &amp; 0xFFFF) + (y &amp; 0xFFFF);</span>
<span class="hh">  var msw = (x &gt;&gt; 16) + (y &gt;&gt; 16) + (lsw &gt;&gt; 16);</span>
<span class="hh">  return (msw &lt;&lt; 16) | (lsw &amp; 0xFFFF);</span>
<span class="hh">}</span>

<span class="hh">/*</span>
<span class="hh"> * Bitwise rotate a 32-bit number to the left.</span>
<span class="hh"> */</span>
<span class="hh">function rol(num, cnt)</span>
<span class="hh">{</span>
<span class="hh">  return (num &lt;&lt; cnt) | (num &gt;&gt;&gt; (32 - cnt));</span>
<span class="hh">}</span>

<span class="hh">/*</span>
<span class="hh"> * Convert an 8-bit or 16-bit string to an array of big-endian words</span>
<span class="hh"> * In 8-bit function, characters &gt;255 have their hi-byte silently ignored.</span>
<span class="hh"> */</span>
<span class="hh">function str2binb(str)</span>
<span class="hh">{</span>
<span class="hh">  var bin = Array();</span>
<span class="hh">  var mask = (1 &lt;&lt; chrsz) - 1;</span>
<span class="hh">  for(var i = 0; i &lt; str.length * chrsz; i += chrsz)</span>
<span class="hh">    bin[i&gt;&gt;5] |= (str.charCodeAt(i / chrsz) &amp; mask) &lt;&lt; (24 - i%32);</span>
<span class="hh">  return bin;</span>
<span class="hh">}</span>

<span class="hh">/*</span>
<span class="hh"> * Convert an array of big-endian words to a string</span>
<span class="hh"> */</span>
<span class="hh">function binb2str(bin)</span>
<span class="hh">{</span>
<span class="hh">  var str = &quot;&quot;;</span>
<span class="hh">  var mask = (1 &lt;&lt; chrsz) - 1;</span>
<span class="hh">  for(var i = 0; i &lt; bin.length * 32; i += chrsz)</span>
<span class="hh">    str += String.fromCharCode((bin[i&gt;&gt;5] &gt;&gt;&gt; (24 - i%32)) &amp; mask);</span>
<span class="hh">  return str;</span>
<span class="hh">}</span>

<span class="hh">/*</span>
<span class="hh"> * Convert an array of big-endian words to a hex string.</span>
<span class="hh"> */</span>
<span class="hh">function binb2hex(binarray)</span>
<span class="hh">{</span>
<span class="hh">  var hex_tab = hexcase ? &quot;0123456789ABCDEF&quot; : &quot;0123456789abcdef&quot;;</span>
<span class="hh">  var str = &quot;&quot;;</span>
<span class="hh">  for(var i = 0; i &lt; binarray.length * 4; i++)</span>
<span class="hh">  {</span>
<span class="hh">    str += hex_tab.charAt((binarray[i&gt;&gt;2] &gt;&gt; ((3 - i%4)*8+4)) &amp; 0xF) +</span>
<span class="hh">           hex_tab.charAt((binarray[i&gt;&gt;2] &gt;&gt; ((3 - i%4)*8  )) &amp; 0xF);</span>
<span class="hh">  }</span>
<span class="hh">  return str;</span>
<span class="hh">}</span>

<span class="hh">/*</span>
<span class="hh"> * Convert an array of big-endian words to a base-64 string</span>
<span class="hh"> */</span>
<span class="hh">function binb2b64(binarray)</span>
<span class="hh">{</span>
<span class="hh">  var tab = &quot;ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/&quot;;</span>
<span class="hh">  var str = &quot;&quot;;</span>
<span class="hh">  for(var i = 0; i &lt; binarray.length * 4; i += 3)</span>
<span class="hh">  {</span>
<span class="hh">    var triplet = (((binarray[i   &gt;&gt; 2] &gt;&gt; 8 * (3 -  i   %4)) &amp; 0xFF) &lt;&lt; 16)</span>
<span class="hh">                | (((binarray[i+1 &gt;&gt; 2] &gt;&gt; 8 * (3 - (i+1)%4)) &amp; 0xFF) &lt;&lt; 8 )</span>
<span class="hh">                |  ((binarray[i+2 &gt;&gt; 2] &gt;&gt; 8 * (3 - (i+2)%4)) &amp; 0xFF);</span>
<span class="hh">    for(var j = 0; j &lt; 4; j++)</span>
<span class="hh">    {</span>
<span class="hh">      if(i * 8 + j * 6 &gt; binarray.length * 32) str += b64pad;</span>
<span class="hh">      else str += tab.charAt((triplet &gt;&gt; 6*(3-j)) &amp; 0x3F);</span>
<span class="hh">    }</span>
<span class="hh">  }</span>
<span class="hh">  return str;</span>
<span class="hh">}</span>

<span class="h">EOT</span>

    <span class="k">return</span> <span class="i">$sha1_functions</span><span class="sc">;</span>

<span class="s">}</span>

<span class="n">1</span><span class="sc">;</span>
<a name="EOF-"></a></pre></body>

</html>
