<?xml version="1.0" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>Cccrypto.pm</title>
<meta http-equiv="content-type" content="text/html; charset=utf-8" />
<link rev="made" href="mailto:root@localhost" />
</head>

<style type="text/css">
<!--
/* default style sheet generated by perltidy */
body {background: #FFFFFF; color: #000000}
pre { color: #000000; 
      background: #F0F0F0;
      font-family: courier;
    } 

.c  { color: #228B22;} /* comment */
.cm { color: #000000;} /* comma */
.co { color: #000000;} /* colon */
.h  { color: #CD5555; font-weight:bold;} /* here-doc-target */
.hh { color: #CD5555; font-style:italic;} /* here-doc-text */
.i  { color: #00688B;} /* identifier */
.j  { color: #CD5555; font-weight:bold;} /* label */
.k  { color: #8B008B; font-weight:bold;} /* keyword */
.m  { color: #FF0000; font-weight:bold;} /* subroutine */
.n  { color: #B452CD;} /* numeric */
.p  { color: #000000;} /* paren */
.pd { color: #228B22; font-style:italic;} /* pod-text */
.pu { color: #000000;} /* punctuation */
.q  { color: #CD5555;} /* quote */
.s  { color: #000000;} /* structure */
.sc { color: #000000;} /* semicolon */
.v  { color: #B452CD;} /* v-string */
.w  { color: #000000;} /* bareword */
-->
</style>
<body style="background-color: white">
<a name="-top-"></a>
<h1>Cccrypto.pm</h1>


<!-- INDEX BEGIN -->
<div name="index">
<p><a name="__index__"></a></p>

<ul>

	<li><a href="#name">NAME</a></li>
	<li><a href="#synopsis">SYNOPSIS</a></li>
	<li><a href="#description">DESCRIPTION</a></li>
	<li><a href="#author">AUTHOR</a></li>
	<li><a href="#copyright">COPYRIGHT</a></li>
	<ul>

		<ul>

			<li><a href="#decode_decryot_reformat">decode_decryot_reformat</a></li>
			<li><a href="#encrypt_and_sign_notifications">encrypt_and_sign_notifications</a></li>
			<li><a href="#send_notifications">send_notifications</a></li>
		</ul>

	</ul>

</ul>

<hr name="index" />
</div>
<!-- INDEX END -->
<h2>Code Index:</h2>
<!-- BEGIN CODE INDEX --><a name="code-index"></a>
<ul>
<li><a href="#package-Cccrypto-">package Cccrypto</a>
<ul>
<li><a href="#decode_decrypt_reformat-">decode_decrypt_reformat</a></li>
<li><a href="#encrypt_and_sign_notifications-">encrypt_and_sign_notifications</a></li>
<li><a href="#send_notifications-">send_notifications</a></li>
</ul>
</li>
<li><a href="#EOF-">EOF</a></li>
</ul>
<!-- END CODE INDEX -->

<p>
</p>
<h1><a name="name">NAME</a></h1>
<p>Cccyrpto.pm</p>
<p>
</p>
<hr />
<h1><a name="synopsis">SYNOPSIS</a></h1>
<p>Open GPG amd support functions for email and jabber transactions</p>
<p>
</p>
<hr />
<h1><a name="description">DESCRIPTION</a></h1>
<p>
</p>
<hr />
<h1><a name="author">AUTHOR</a></h1>
<p>Hugh Barnard</p>
<p>
</p>
<hr />
<h1><a name="copyright">COPYRIGHT</a></h1>
<p>(c) Hugh Barnard 2004-2007 GPL Licenced</p>
<pre>
<a name="package-Cccrypto-"></a><span class="k">package </span><span class="i">Cccrypto</span><span class="sc">;</span>

<span class="k">my</span> <span class="i">$VERSION</span> = <span class="n">1.00</span><span class="sc">;</span>

<span class="i">@ISA</span>    = <span class="q">qw(Exporter)</span><span class="sc">;</span>
<span class="i">@EXPORT</span> = <span class="q">qw(decode_decrypt_reformat</span>
  <span class="q">encrypt_and_sign_notifications</span>
  <span class="q">send_notifications )</span><span class="sc">;</span>

<span class="c"># these are decryption, transcoding etc. etc.</span>
<span class="k">use</span> <span class="w">MIME::Base64</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">MIME::Decoder</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">GnuPG</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">Ccu</span><span class="sc">;</span>

<span class="c"># jabber client library</span>
<span class="k">use</span> <span class="w">Net::XMPP</span><span class="sc">;</span>

<span class="k">use</span> <span class="w">strict</span><span class="sc">;</span>

<span class="c"># for notify_by_mail, at the least</span>
<span class="k">use</span> <span class="w">Cclite</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">Ccconfiguration</span><span class="sc">;</span>

<span class="k">my</span> <span class="i">%configuration</span> = <span class="i">readconfiguration</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>

</pre><p></p>
<h3><a name="decode_decryot_reformat">decode_decryot_reformat</a></h3>
<p>decode from quoted-printable (Yahoo), decrypt (verfiy signature) and reformat from base64 (Gmail)
there's probably quite a few variations of this, therefore systems are going to have choose/restrict
mail providers or face a lot of complexity in this bit.</p>
<p>The jabber etc. doesn't need the mime decoding, but I've kept for the moment, since all the logic is
pretty much roughed out anyway...everything should really take place /tmp and be cleared out asap,
since there are currently plaintext transactions in there...</p>
<p>Currently tested for Yahoo and Gmail, for obvious reasons, I don't care about hotmail</p>
<pre>
<a name="decode_decrypt_reformat-"></a><span class="k">sub </span><span class="m">decode_decrypt_reformat</span> <span class="s">{</span>

    <span class="k">my</span> <span class="s">(</span> <span class="i">$passphrase</span><span class="cm">,</span> <span class="i">$message</span><span class="cm">,</span> <span class="i">$reformat</span><span class="cm">,</span> <span class="i">$decrypt</span><span class="cm">,</span> <span class="i">$logfile</span><span class="cm">,</span> <span class="i">$trace</span> <span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>

    <span class="k">open</span> <span class="w">STDERR</span><span class="cm">,</span> <span class="q">&quot;&gt;&gt;$logfile&quot;</span> <span class="k">if</span> <span class="s">(</span> <span class="k">length</span><span class="s">(</span><span class="i">$logfile</span><span class="s">)</span> <span class="s">)</span><span class="sc">;</span>

    <span class="c"># test whether there&#39;s actually a transaction in the mail message...</span>
    <span class="k">my</span> <span class="i">$transaction_found</span> = <span class="n">0</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$gpg</span> = <span class="w">new</span> <span class="i">GnuPG</span><span class="s">(</span> <span class="q">&#39;trace&#39;</span> <span class="cm">=&gt;</span> <span class="i">$trace</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$decoder</span> = <span class="w">new</span> <span class="w">MIME::Decoder</span> <span class="q">&#39;quoted-printable&#39;</span> <span class="k">or</span> <span class="k">die</span> <span class="q">&quot;unsupported&quot;</span><span class="sc">;</span>

    <span class="c"># decode quoted printable for Yahoo, shouldn&#39;t change Gmail content?</span>
    <span class="k">open</span><span class="s">(</span> <span class="w">MAIL</span><span class="cm">,</span>     <span class="i">$message</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">open</span><span class="s">(</span> <span class="w">REFORMAT</span><span class="cm">,</span> <span class="q">&quot;&gt;$reformat&quot;</span> <span class="s">)</span><span class="sc">;</span>
    <span class="i">$decoder</span><span class="i">-&gt;decode</span><span class="s">(</span> \<span class="i">*MAIL</span><span class="cm">,</span> \<span class="i">*REFORMAT</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">close</span><span class="s">(</span><span class="w">REFORMAT</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">close</span><span class="s">(</span><span class="w">MAIL</span><span class="s">)</span><span class="sc">;</span>

    <span class="c"># decrypt the message which should also verify signature, goes into logile</span>
    <span class="i">$gpg</span><span class="i">-&gt;decrypt</span><span class="s">(</span>
        <span class="w">ciphertext</span> <span class="cm">=&gt;</span> <span class="i">$reformat</span><span class="cm">,</span>
        <span class="w">output</span>     <span class="cm">=&gt;</span> <span class="i">$decrypt</span><span class="cm">,</span>
        <span class="w">passphrase</span> <span class="cm">=&gt;</span> <span class="i">$passphrase</span><span class="cm">,</span>
    <span class="s">)</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$string</span><span class="sc">;</span>

    <span class="c"># write decrypted message back into string for base64 operation (Gmail)</span>
    <span class="k">open</span><span class="s">(</span> <span class="w">DECRYPT</span><span class="cm">,</span> <span class="i">$decrypt</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">while</span> <span class="s">(</span><span class="q">&lt;DECRYPT&gt;</span><span class="s">)</span> <span class="s">{</span>
        <span class="i">$string</span> .= <span class="i">$_</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">close</span><span class="s">(</span><span class="w">DECRYPT</span><span class="s">)</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$decoded</span><span class="sc">;</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$header</span><span class="cm">,</span> <span class="i">$base64</span> <span class="s">)</span> = <span class="k">split</span><span class="s">(</span> <span class="q">/base64/</span><span class="cm">,</span> <span class="i">$string</span> <span class="s">)</span><span class="sc">;</span>

    <span class="c"># if there&#39;s a base64 header, decode otherwise it&#39;s fine..</span>
    <span class="k">if</span> <span class="s">(</span> <span class="k">length</span><span class="s">(</span><span class="i">$base64</span><span class="s">)</span> <span class="s">)</span> <span class="s">{</span>
        <span class="i">$decoded</span> = <span class="i">decode_base64</span><span class="s">(</span><span class="i">$base64</span><span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span> <span class="k">else</span> <span class="s">{</span>
        <span class="i">$decoded</span> = <span class="i">$string</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="k">my</span> <span class="i">@lines</span> = <span class="k">split</span><span class="s">(</span> <span class="q">/\n/</span><span class="cm">,</span> <span class="i">$decoded</span> <span class="s">)</span><span class="sc">;</span>

<span class="c"># run through decoded lines and look for transaction line starts with send or SEND</span>

    <span class="k">foreach</span> <span class="k">my</span> <span class="i">$line</span> <span class="s">(</span><span class="i">@lines</span><span class="s">)</span> <span class="s">{</span>
        <span class="k">if</span> <span class="s">(</span> <span class="i">$line</span> =~ <span class="q">/send|balance/i</span> <span class="s">)</span> <span class="s">{</span>
            <span class="k">return</span> <span class="s">(</span> <span class="n">1</span><span class="cm">,</span> <span class="i">$line</span> <span class="s">)</span><span class="sc">;</span>
        <span class="s">}</span>    <span class="c"># test for send</span>

    <span class="s">}</span>    <span class="c">#end foreach</span>

    <span class="c"># no transaction line found, return line anyway...</span>
    <span class="k">return</span> <span class="s">(</span> <span class="n">0</span><span class="cm">,</span> <span class="q">&#39;&#39;</span> <span class="s">)</span><span class="sc">;</span>

<span class="s">}</span>

</pre><p></p>
<h3><a name="encrypt_and_sign_notifications">encrypt_and_sign_notifications</a></h3>
<p>FIXME: encrypt and sign the receipt using a public key collected from the id in the originator record...either this key
is on a local keyring (done) or can be accessed from the chosen keyserver (not done or tested). These are implementatation 'gaps' or choices
at present...</p>
<pre>
<a name="encrypt_and_sign_notifications-"></a><span class="k">sub </span><span class="m">encrypt_and_sign_notifications</span> <span class="s">{</span>

    <span class="k">my</span> <span class="s">(</span> <span class="i">$passphrase</span><span class="cm">,</span> <span class="i">$transaction_description_ref</span><span class="cm">,</span> <span class="i">$message</span><span class="cm">,</span> <span class="i">$encrypted</span><span class="cm">,</span>
        <span class="i">$logfile</span><span class="cm">,</span> <span class="i">$trace</span><span class="cm">,</span> <span class="i">$messages_ref</span> <span class="s">)</span>
      = <span class="i">@_</span><span class="sc">;</span>

<span class="c"># need to encrypt with the public key that corresponds to cclite user, via email address, see recipient, below...</span>
    <span class="k">my</span> <span class="i">$encrypted_body</span><span class="sc">;</span>

    <span class="k">if</span> <span class="s">(</span> <span class="k">length</span><span class="s">(</span> <span class="i">$transaction_description_ref</span>-&gt;{<span class="q">&#39;userPublickeyid&#39;</span>} <span class="s">)</span> <span class="s">)</span> <span class="s">{</span>

        <span class="k">open</span><span class="s">(</span> <span class="w">MAIL</span><span class="cm">,</span> <span class="q">&quot;&gt;$message&quot;</span> <span class="s">)</span><span class="sc">;</span>
        <span class="k">print</span> <span class="i">MAIL</span>
<span class="q">&quot;$transaction_description_ref-&gt;{&#39;error&#39;}  $transaction_description_ref-&gt;{&#39;output_message&#39;}&quot;</span><span class="sc">;</span>
        <span class="k">close</span><span class="s">(</span><span class="w">MAIL</span><span class="s">)</span><span class="sc">;</span>
        <span class="k">my</span> <span class="i">$gpg</span> = <span class="w">new</span> <span class="i">GnuPG</span><span class="s">(</span> <span class="q">&#39;trace&#39;</span> <span class="cm">=&gt;</span> <span class="i">$trace</span> <span class="s">)</span><span class="sc">;</span>
        <span class="k">eval</span> <span class="s">{</span>
            <span class="i">$gpg</span><span class="i">-&gt;encrypt</span><span class="s">(</span>
                <span class="w">plaintext</span>  <span class="cm">=&gt;</span> <span class="i">$message</span><span class="cm">,</span>
                <span class="w">output</span>     <span class="cm">=&gt;</span> <span class="i">$encrypted</span><span class="cm">,</span>
                <span class="w">armor</span>      <span class="cm">=&gt;</span> <span class="n">1</span><span class="cm">,</span>
                <span class="w">sign</span>       <span class="cm">=&gt;</span> <span class="n">1</span><span class="cm">,</span>
                <span class="w">recipient</span>  <span class="cm">=&gt;</span> <span class="i">$transaction_description_ref</span>-&gt;{<span class="q">&#39;userPublickeyid&#39;</span>}<span class="cm">,</span>
                <span class="w">passphrase</span> <span class="cm">=&gt;</span> <span class="i">$passphrase</span>
            <span class="s">)</span><span class="sc">;</span>

        <span class="s">}</span><span class="sc">;</span>

        <span class="k">open</span><span class="s">(</span> <span class="w">ENCRYPT</span><span class="cm">,</span> <span class="i">$encrypted</span> <span class="s">)</span><span class="sc">;</span>
        <span class="k">while</span> <span class="s">(</span><span class="q">&lt;ENCRYPT&gt;</span><span class="s">)</span> <span class="s">{</span>
            <span class="i">$encrypted_body</span> .= <span class="i">$_</span><span class="sc">;</span>
        <span class="s">}</span>
        <span class="k">close</span><span class="s">(</span><span class="w">ENCRYPT</span><span class="s">)</span><span class="sc">;</span>

    <span class="s">}</span> <span class="k">else</span> <span class="s">{</span>

        <span class="i">$encrypted_body</span> = <span class="i">$messages_ref</span>-&gt;{<span class="q">&#39;noencryptednotification&#39;</span>}<span class="sc">;</span>
    <span class="s">}</span>

    <span class="k">unlink</span> <span class="i">$message</span><span class="cm">,</span> <span class="i">$encrypted</span><span class="sc">;</span>
    <span class="k">return</span> <span class="i">$encrypted_body</span><span class="sc">;</span>

<span class="s">}</span>

</pre><p></p>
<h3><a name="send_notifications">send_notifications</a></h3>
<p>Send transaction notification to transaction originator</p>

<pre>
<a name="send_notifications-"></a><span class="k">sub </span><span class="m">send_notifications</span> <span class="s">{</span>

    <span class="k">my</span> <span class="s">(</span> <span class="i">$notifications_hash_ref</span><span class="cm">,</span> <span class="i">$passphrase</span><span class="cm">,</span> <span class="i">$message</span><span class="cm">,</span> <span class="i">$encrypted</span><span class="cm">,</span> <span class="i">$logfile</span><span class="cm">,</span>
        <span class="i">$encrypt_notifications</span><span class="cm">,</span> <span class="i">$trace</span><span class="cm">,</span> <span class="i">$messages_ref</span> <span class="s">)</span>
      = <span class="i">@_</span><span class="sc">;</span>

<span class="c"># reference info to the current signature for notify...</span>
<span class="c"># $class (for soap),       $registry(database name),         $name (first name),</span>
<span class="c"># $email (user email),       $systemfrom(not used),       $return_address (not used),</span>
<span class="c"># $accountname (user screen name), $smtp(additional smtp host),             $urlstring (clickable string),</span>
<span class="c"># $text (body text for notification),        $notificationtype(notification code), $hash</span>
    <span class="k">foreach</span> <span class="k">my</span> <span class="i">$transaction_description_ref</span> <span class="s">(</span><span class="i">@$notifications_hash_ref</span><span class="s">)</span> <span class="s">{</span>

        <span class="c"># encrypt and sign notifications, only if requested...</span>
        <span class="k">my</span> <span class="i">$body</span><span class="sc">;</span>
        <span class="k">if</span> <span class="s">(</span><span class="i">$encrypt_notifications</span><span class="s">)</span> <span class="s">{</span>
            <span class="i">$body</span> =
              <span class="i">encrypt_and_sign_notifications</span><span class="s">(</span> <span class="i">$passphrase</span><span class="cm">,</span>
                <span class="i">$transaction_description_ref</span><span class="cm">,</span> <span class="i">$message</span><span class="cm">,</span> <span class="i">$encrypted</span><span class="cm">,</span> <span class="i">$logfile</span><span class="cm">,</span>
                <span class="i">$trace</span><span class="cm">,</span> <span class="i">$messages_ref</span> <span class="s">)</span><span class="sc">;</span>
        <span class="s">}</span> <span class="k">else</span> <span class="s">{</span>
            <span class="i">$body</span> =
<span class="q">&quot;$transaction_description_ref-&gt;{&#39;error&#39;}  $transaction_description_ref-&gt;{&#39;output_message&#39;}&quot;</span><span class="sc">;</span>
        <span class="s">}</span>

        <span class="c">#FIXME: notify_by_mail and these need sorting out, somewhat</span>
        <span class="i">notify_by_mail</span><span class="s">(</span>
            <span class="q">&#39;local&#39;</span><span class="cm">,</span>
            <span class="i">$transaction_description_ref</span>-&gt;{<span class="q">&#39;registry&#39;</span>}<span class="cm">,</span>
            <span class="i">$transaction_description_ref</span>-&gt;{<span class="q">&#39;name&#39;</span>}<span class="cm">,</span>
            <span class="i">$transaction_description_ref</span>-&gt;{<span class="q">&#39;originator_email&#39;</span>}<span class="cm">,</span>
            <span class="q">&#39;&#39;</span><span class="cm">,</span>
            <span class="q">&#39;&#39;</span><span class="cm">,</span>
            <span class="i">$transaction_description_ref</span>-&gt;{<span class="q">&#39;source&#39;</span>}<span class="cm">,</span>
            <span class="q">&#39;&#39;</span><span class="cm">,</span>
            <span class="q">&#39;&#39;</span><span class="cm">,</span>
            <span class="i">$body</span><span class="cm">,</span>
            <span class="n">5</span><span class="cm">,</span>
            <span class="q">&#39;&#39;</span>
        <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="k">undef</span> <span class="i">@$notifications_hash_ref</span><span class="sc">;</span>

    <span class="k">return</span><span class="sc">;</span>
<span class="s">}</span>

<span class="n">1</span><span class="sc">;</span>

<a name="EOF-"></a></pre></body>

</html>
