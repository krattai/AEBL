<?xml version="1.0" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>read_from_jabber.pl</title>
<meta http-equiv="content-type" content="text/html; charset=utf-8" />
<link rev="made" href="mailto:root@localhost" />
</head>

<style type="text/css">
<!--
/* default style sheet generated by perltidy */
body {background: #FFFFFF; color: #000000}
pre { color: #000000; 
      background: #F0F0F0;
      font-family: courier;
    } 

.c  { color: #228B22;} /* comment */
.cm { color: #000000;} /* comma */
.co { color: #000000;} /* colon */
.h  { color: #CD5555; font-weight:bold;} /* here-doc-target */
.hh { color: #CD5555; font-style:italic;} /* here-doc-text */
.i  { color: #00688B;} /* identifier */
.j  { color: #CD5555; font-weight:bold;} /* label */
.k  { color: #8B008B; font-weight:bold;} /* keyword */
.m  { color: #FF0000; font-weight:bold;} /* subroutine */
.n  { color: #B452CD;} /* numeric */
.p  { color: #000000;} /* paren */
.pd { color: #228B22; font-style:italic;} /* pod-text */
.pu { color: #000000;} /* punctuation */
.q  { color: #CD5555;} /* quote */
.s  { color: #000000;} /* structure */
.sc { color: #000000;} /* semicolon */
.v  { color: #B452CD;} /* v-string */
.w  { color: #000000;} /* bareword */
-->
</style>
<body style="background-color: white">
<a name="-top-"></a>
<h1>read_from_jabber.pl</h1>


<!-- INDEX BEGIN -->
<div name="index">
<p><a name="__index__"></a></p>

<ul>

	<ul>

		<ul>

			<li><a href="#stop">stop</a></li>
			<li><a href="#set_signals">set_signals</a></li>
			<li><a href="#in_message">in_message</a></li>
			<li><a href="#in_iq">in_iq</a></li>
			<li><a href="#in_presence">in_presence</a></li>
			<li><a href="#process_cclite_message">process_cclite_message</a></li>
		</ul>

	</ul>

</ul>

<hr name="index" />
</div>
<!-- INDEX END -->
<h2>Code Index:</h2>
<!-- BEGIN CODE INDEX --><a name="code-index"></a>
<ul>
<li><a href="#stop-">package main</a>
<ul>
<li><a href="#stop-">stop</a></li>
<li><a href="#set_signals-">set_signals</a></li>
<li><a href="#in_message-">in_message</a></li>
<li><a href="#in_iq-">in_iq</a></li>
<li><a href="#in_presence-">in_presence</a></li>
<li><a href="#process_cclite_message-">process_cclite_message</a></li>
</ul>
</li>
<li><a href="#EOF-">EOF</a></li>
</ul>
<!-- END CODE INDEX -->

<pre>#!/usr/bin/perl

</pre><p></p>
<h3><a name="stop">stop</a></h3>
<p>stop the script, on signal</p>
<pre>
<a name="stop-"></a><span class="k">sub </span><span class="m">stop</span> <span class="s">{</span>
    <span class="k">print</span> <span class="q">&quot;Exiting...\n&quot;</span><span class="sc">;</span>
    <span class="i">$connection</span><span class="i">-&gt;Disconnect</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">exit</span><span class="s">(</span><span class="n">0</span><span class="s">)</span><span class="sc">;</span>
<span class="s">}</span>

</pre><p></p>
<h3><a name="set_signals">set_signals</a></h3>
<p>Set the signals that will stop the script
This probably needs review for cron etc/</p>
<pre>
<a name="set_signals-"></a><span class="k">sub </span><span class="m">set_signals</span> <span class="s">{</span>

    <span class="i">$SIG</span>{<span class="w">HUP</span>}  = \<span class="i">&amp;stop</span><span class="sc">;</span>
    <span class="i">$SIG</span>{<span class="w">KILL</span>} = \<span class="i">&amp;stop</span><span class="sc">;</span>
    <span class="i">$SIG</span>{<span class="w">TERM</span>} = \<span class="i">&amp;stop</span><span class="sc">;</span>
    <span class="i">$SIG</span>{<span class="w">INT</span>}  = \<span class="i">&amp;stop</span><span class="sc">;</span>

    <span class="k">return</span><span class="sc">;</span>
<span class="s">}</span>

</pre><p></p>
<h3><a name="in_message">in_message</a></h3>
<p>Processing for messages coming in from human
client. All messages processed for cclite</p>
<pre>
<a name="in_message-"></a><span class="k">sub </span><span class="m">in_message</span> <span class="s">{</span>
    <span class="k">my</span> <span class="i">$sid</span>     = <span class="k">shift</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$message</span> = <span class="k">shift</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$type</span>    = <span class="i">$message</span><span class="i">-&gt;GetType</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$fromJID</span> = <span class="i">$message</span><span class="i">-&gt;GetFrom</span><span class="s">(</span><span class="q">&quot;jid&quot;</span><span class="s">)</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$from</span>       = <span class="i">$fromJID</span><span class="i">-&gt;GetUserID</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$originator</span> = <span class="i">$message</span><span class="i">-&gt;GetFrom</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$resource</span>   = <span class="i">$fromJID</span><span class="i">-&gt;GetResource</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$subject</span>    = <span class="i">$message</span><span class="i">-&gt;GetSubject</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$body</span>       = <span class="i">$message</span><span class="i">-&gt;GetBody</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>

    <span class="i">process_cclite_message</span><span class="s">(</span> <span class="i">$body</span><span class="cm">,</span> <span class="i">$fromJID</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">if</span> <span class="s">(</span><span class="i">$debug</span><span class="s">)</span> <span class="s">{</span>
        <span class="k">print</span> <span class="q">&quot;===\n&quot;</span><span class="sc">;</span>
        <span class="k">print</span> <span class="q">&quot;Message ($type)\n&quot;</span><span class="sc">;</span>
        <span class="k">print</span> <span class="q">&quot;  From: $from ($resource) $from\n&quot;</span><span class="sc">;</span>
        <span class="k">print</span> <span class="q">&quot;  Subject: $subject\n&quot;</span><span class="sc">;</span>
        <span class="k">print</span> <span class="q">&quot;  Body: $body\n&quot;</span><span class="sc">;</span>
        <span class="k">print</span> <span class="q">&quot;===\n&quot;</span><span class="sc">;</span>
        <span class="k">print</span> <span class="i">$message</span><span class="i">-&gt;GetXML</span><span class="s">(</span><span class="s">)</span><span class="cm">,</span> <span class="q">&quot;\n&quot;</span><span class="sc">;</span>
        <span class="k">print</span> <span class="q">&quot;===\n&quot;</span><span class="sc">;</span>
    <span class="s">}</span>

<span class="s">}</span>

</pre><p></p>
<h3><a name="in_iq">in_iq</a></h3>
<p>Another message type, not sure what this does?
AOL?</p>
<pre>
<a name="in_iq-"></a><span class="k">sub </span><span class="m">in_iq</span> <span class="s">{</span>
    <span class="k">my</span> <span class="i">$sid</span> = <span class="k">shift</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$iq</span>  = <span class="k">shift</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$from</span>  = <span class="i">$iq</span><span class="i">-&gt;GetFrom</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$type</span>  = <span class="i">$iq</span><span class="i">-&gt;GetType</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$query</span> = <span class="i">$iq</span><span class="i">-&gt;GetQuery</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$xmlns</span> = <span class="i">$query</span><span class="i">-&gt;GetXMLNS</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>

    <span class="k">if</span> <span class="s">(</span><span class="i">$debug</span><span class="s">)</span> <span class="s">{</span>
        <span class="k">print</span> <span class="q">&quot;===\n&quot;</span><span class="sc">;</span>
        <span class="k">print</span> <span class="q">&quot;IQ\n&quot;</span><span class="sc">;</span>
        <span class="k">print</span> <span class="q">&quot;  From $from\n&quot;</span><span class="sc">;</span>
        <span class="k">print</span> <span class="q">&quot;  Type: $type\n&quot;</span><span class="sc">;</span>
        <span class="k">print</span> <span class="q">&quot;  XMLNS: $xmlns&quot;</span><span class="sc">;</span>
        <span class="k">print</span> <span class="q">&quot;===\n&quot;</span><span class="sc">;</span>
        <span class="k">print</span> <span class="i">$iq</span><span class="i">-&gt;GetXML</span><span class="s">(</span><span class="s">)</span><span class="cm">,</span> <span class="q">&quot;\n&quot;</span><span class="sc">;</span>
        <span class="k">print</span> <span class="q">&quot;===\n&quot;</span><span class="sc">;</span>
    <span class="s">}</span>

<span class="s">}</span>

</pre><p></p>
<h3><a name="in_presence">in_presence</a></h3>
<p>Prcoessing presence messages</p>
<pre>
<a name="in_presence-"></a><span class="k">sub </span><span class="m">in_presence</span> <span class="s">{</span>
    <span class="k">my</span> <span class="i">$sid</span>      = <span class="k">shift</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$presence</span> = <span class="k">shift</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$from</span>   = <span class="i">$presence</span><span class="i">-&gt;GetFrom</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$type</span>   = <span class="i">$presence</span><span class="i">-&gt;GetType</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$status</span> = <span class="i">$presence</span><span class="i">-&gt;GetStatus</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>

    <span class="k">if</span> <span class="s">(</span><span class="i">$debug</span><span class="s">)</span> <span class="s">{</span>
        <span class="k">print</span> <span class="q">&quot;===\n&quot;</span><span class="sc">;</span>
        <span class="k">print</span> <span class="q">&quot;Presence\n&quot;</span><span class="sc">;</span>
        <span class="k">print</span> <span class="q">&quot;  From $from\n&quot;</span><span class="sc">;</span>
        <span class="k">print</span> <span class="q">&quot;  Type: $type\n&quot;</span><span class="sc">;</span>
        <span class="k">print</span> <span class="q">&quot;  Status: $status\n&quot;</span><span class="sc">;</span>
        <span class="k">print</span> <span class="q">&quot;===\n&quot;</span><span class="sc">;</span>
        <span class="k">print</span> <span class="i">$presence</span><span class="i">-&gt;GetXML</span><span class="s">(</span><span class="s">)</span><span class="cm">,</span> <span class="q">&quot;\n&quot;</span><span class="sc">;</span>
        <span class="k">print</span> <span class="q">&quot;===\n&quot;</span><span class="sc">;</span>
    <span class="s">}</span>

<span class="s">}</span>

</pre><p></p>
<h3><a name="process_cclite_message">process_cclite_message</a></h3>
<p>A crude first attempt to process GPG encoded Jabber input bodies
containing 'send' or 'balance' transactions. Does not send encrypted
receipts at present...</p>
<pre>
<a name="process_cclite_message-"></a><span class="k">sub </span><span class="m">process_cclite_message</span> <span class="s">{</span>

    <span class="k">my</span> <span class="s">(</span> <span class="i">$body</span><span class="cm">,</span> <span class="i">$fromJID</span> <span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>

    <span class="k">my</span> <span class="s">(</span> <span class="i">$transaction_found</span><span class="cm">,</span> <span class="i">$transaction_line</span><span class="cm">,</span> <span class="i">$transaction_description_ref</span><span class="cm">,</span>
        <span class="i">$parse_type</span> <span class="s">)</span><span class="sc">;</span>

    <span class="c"># originator is mail style address + resource stub, parse</span>
    <span class="i">$originator</span> =~ <span class="q">s/^([^\/]+)\/.*?$/$1/</span><span class="sc">;</span>

    <span class="c"># if encoded, assumed to be a transaction...</span>
    <span class="k">if</span> <span class="s">(</span> <span class="i">$body</span> =~ <span class="q">/BEGIN PGP MESSAGE/</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">open</span><span class="s">(</span> <span class="w">JABBER</span><span class="cm">,</span> <span class="q">&quot;&gt;$message_file&quot;</span> <span class="s">)</span><span class="sc">;</span>
        <span class="k">print</span> <span class="i">JABBER</span> <span class="i">$body</span><span class="sc">;</span>
        <span class="k">close</span><span class="s">(</span><span class="w">JABBER</span><span class="s">)</span><span class="sc">;</span>
        <span class="s">(</span> <span class="i">$transaction_found</span><span class="cm">,</span> <span class="i">$transaction_line</span> <span class="s">)</span> =
          <span class="i">decode_decrypt_reformat</span><span class="s">(</span> <span class="i">$passphrase</span><span class="cm">,</span> <span class="i">$message_file</span><span class="cm">,</span> <span class="i">$reformat</span><span class="cm">,</span>
            <span class="i">$decrypt</span><span class="cm">,</span> <span class="i">$logfile</span><span class="cm">,</span> <span class="i">$trace</span> <span class="s">)</span><span class="sc">;</span>

        <span class="s">(</span> <span class="i">$parse_type</span><span class="cm">,</span> <span class="i">$transaction_description_ref</span> <span class="s">)</span> =
          <span class="i">mail_message_parse</span><span class="s">(</span> <span class="q">&#39;local&#39;</span><span class="cm">,</span> <span class="i">$registry</span><span class="cm">,</span> <span class="i">$originator</span><span class="cm">,</span> <span class="q">&#39;&#39;</span><span class="cm">,</span> <span class="q">&#39;&#39;</span><span class="cm">,</span>
            <span class="i">$transaction_line</span> <span class="s">)</span><span class="sc">;</span>

        <span class="c"># add &#39;via jabber&#39; literal to description of transaction</span>
        <span class="i">$transaction_description_ref</span>-&gt;{<span class="q">&#39;description&#39;</span>} =
          <span class="q">&quot;$messages{&#39;viajabber&#39;} &quot;</span>
          . <span class="i">$transaction_description_ref</span>-&gt;{<span class="q">&#39;description&#39;</span>}<span class="sc">;</span>

<span class="c">#FIXME: we have output, error and text within transaction, needs simplifying</span>
<span class="c"># also add the Via Jabber/Via Email prefix at this stage before transaction processing...</span>
        <span class="k">if</span> <span class="s">(</span> !<span class="k">length</span><span class="s">(</span> <span class="i">$transaction_description_ref</span>-&gt;{<span class="q">&#39;error&#39;</span>} <span class="s">)</span>
            &amp;&amp; <span class="i">$transaction_description_ref</span>-&gt;{<span class="q">&#39;type&#39;</span>} <span class="k">eq</span> <span class="q">&#39;send&#39;</span> <span class="s">)</span>
        <span class="s">{</span>
            <span class="i">$transaction_description_ref</span>-&gt;{<span class="q">&#39;output_message&#39;</span>} =
              <span class="i">mail_transaction</span><span class="s">(</span><span class="i">$transaction_description_ref</span><span class="s">)</span><span class="sc">;</span>
        <span class="s">}</span> <span class="k">elsif</span> <span class="s">(</span> <span class="i">$transaction_description_ref</span>-&gt;{<span class="q">&#39;type&#39;</span>} <span class="k">eq</span> <span class="q">&#39;balance&#39;</span> <span class="s">)</span> <span class="s">{</span>
            <span class="i">$transaction_description_ref</span>-&gt;{<span class="q">&#39;output_message&#39;</span>} =
              <span class="i">$transaction_description_ref</span>-&gt;{<span class="q">&#39;text&#39;</span>}<span class="sc">;</span>
        <span class="s">}</span>

    <span class="s">}</span>

</pre><p>message fields for refereence...</p><pre>
             to=&gt;string|JID,    - set multiple fields in the &lt;message/&gt;
             from=&gt;string|JID,    at one time.  This is a cumulative
             type=&gt;string,        and over writing action.  If you set
             subject=&gt;string,     the &quot;to&quot; attribute twice, the second
             body=&gt;string,        setting is what is used.  If you set
             thread=&gt;string,      the subject, and then set the body
             errorcode=&gt;string,   then both will be in the &lt;message/&gt;
             error=&gt;string</pre>
<pre>
    <span class="k">my</span> <span class="i">$output</span> =
<span class="q">&quot;$transaction_description_ref-&gt;{&#39;error&#39;} $transaction_description_ref-&gt;{&#39;output_message&#39;}&quot;</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$type</span> = <span class="i">$transaction_description_ref</span>-&gt;{<span class="q">&#39;type&#39;</span>}<span class="sc">;</span>

    <span class="k">if</span> <span class="s">(</span> !<span class="i">$transaction_found</span> <span class="s">)</span> <span class="s">{</span>

        <span class="i">$connection</span><span class="i">-&gt;MessageSend</span><span class="s">(</span>
            <span class="q">&#39;to&#39;</span>   <span class="cm">=&gt;</span> <span class="i">$fromJID</span><span class="cm">,</span>
            <span class="q">&#39;type&#39;</span> <span class="cm">=&gt;</span> <span class="q">&#39;chat&#39;</span><span class="cm">,</span>
            <span class="q">&#39;body&#39;</span> <span class="cm">=&gt;</span> <span class="q">&quot;no transaction detected&quot;</span>
        <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span> <span class="k">else</span> <span class="s">{</span>
        <span class="k">my</span> <span class="i">$output</span> =
<span class="q">&quot;$transaction_description_ref-&gt;{&#39;error&#39;} $transaction_description_ref-&gt;{&#39;output_message&#39;}&quot;</span><span class="sc">;</span>
        <span class="i">$connection</span><span class="i">-&gt;MessageSend</span><span class="s">(</span>
            <span class="q">&#39;to&#39;</span>   <span class="cm">=&gt;</span> <span class="i">$fromJID</span><span class="cm">,</span>
            <span class="q">&#39;type&#39;</span> <span class="cm">=&gt;</span> <span class="q">&#39;chat&#39;</span><span class="cm">,</span>
            <span class="q">&#39;body&#39;</span> <span class="cm">=&gt;</span> <span class="i">$output</span>
        <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="k">return</span><span class="sc">;</span>
<span class="s">}</span>

<span class="c">#------------------------------------------------------------------------------------------------------------------</span>
<span class="c"># Start of main script</span>
<span class="c">#------------------------------------------------------------------------------------------------------------------</span>

<span class="k">use</span> <span class="w">strict</span><span class="sc">;</span>

<span class="k">use</span> <span class="w">lib</span> <span class="q">&#39;../../../lib&#39;</span><span class="sc">;</span>

<span class="c"># and cclite support</span>
<span class="k">use</span> <span class="w">Ccconfiguration</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">Ccmailgateway</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">Cclitedb</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">Cclite</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">Cccrypto</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">Cccookie</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">Ccu</span><span class="sc">;</span>

<span class="k">my</span> <span class="i">%configuration</span>          = <span class="w">readconfiguration</span><span class="sc">;</span>
<span class="k">my</span> <span class="i">$configuration_hash_ref</span> = \<span class="i">%configuration</span><span class="sc">;</span>

<span class="c"># message language now decided by decide_language 08/2011</span>
<span class="k">our</span> <span class="i">%messages</span> = <span class="i">readmessages</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>

<span class="c"># don&#39;t need at present run from command line...</span>
<span class="k">my</span> <span class="i">$cookieref</span> = <span class="i">get_cookie</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>

<span class="c"># specific configuration file for this, for the moment...</span>
<span class="k">my</span> <span class="i">%jabber_configuration</span> = <span class="i">readconfiguration</span><span class="s">(</span><span class="q">&#39;../../../config/readjabber.cf&#39;</span><span class="s">)</span><span class="sc">;</span>

<span class="k">my</span> <span class="i">$server</span>   = <span class="i">$jabber_configuration</span>{<span class="q">&#39;server&#39;</span>}<span class="sc">;</span>
<span class="k">my</span> <span class="i">$port</span>     = <span class="i">$jabber_configuration</span>{<span class="q">&#39;port&#39;</span>}<span class="sc">;</span>
<span class="k">my</span> <span class="i">$username</span> = <span class="i">$jabber_configuration</span>{<span class="q">&#39;username&#39;</span>}<span class="sc">;</span>
<span class="k">my</span> <span class="i">$password</span> = <span class="i">$jabber_configuration</span>{<span class="q">&#39;password&#39;</span>}<span class="sc">;</span>

<span class="c"># this is experimental, multiple cclite bots, distinguished by registry name</span>
<span class="k">my</span> <span class="i">$resource</span> = <span class="i">$jabber_configuration</span>{<span class="q">&#39;hardcoded_registry&#39;</span>}<span class="sc">;</span>

<span class="k">my</span> <span class="i">$temp_directory</span> = <span class="i">$jabber_configuration</span>{<span class="q">&#39;temp_directory&#39;</span>}<span class="sc">;</span>

<span class="k">our</span> <span class="i">$message_file</span> =
  <span class="q">&quot;$jabber_configuration{&#39;temp_directory&#39;}/$jabber_configuration{&#39;message&#39;}&quot;</span><span class="sc">;</span>
<span class="k">our</span> <span class="i">$reformat</span> =
  <span class="q">&quot;$jabber_configuration{&#39;temp_directory&#39;}/$jabber_configuration{&#39;reformat&#39;}&quot;</span><span class="sc">;</span>
<span class="k">our</span> <span class="i">$decrypt</span> =
  <span class="q">&quot;$jabber_configuration{&#39;temp_directory&#39;}/$jabber_configuration{&#39;decrypt&#39;}&quot;</span><span class="sc">;</span>
<span class="k">our</span> <span class="i">$encrypted</span> =
  <span class="q">&quot;$jabber_configuration{&#39;temp_directory&#39;}/$jabber_configuration{&#39;encrypted&#39;}&quot;</span><span class="sc">;</span>

<span class="c"># STDERR for gpg operations, if specified...</span>
<span class="k">our</span> <span class="i">$logfile</span> =
  <span class="q">&quot;$jabber_configuration{&#39;temp_directory&#39;}/$jabber_configuration{&#39;logfile&#39;}&quot;</span><span class="sc">;</span>

<span class="c"># turns gpg trace on and off, prints to STDOUT (or STDERR?)</span>
<span class="k">our</span> <span class="i">$trace</span> = <span class="i">$jabber_configuration</span>{<span class="q">&#39;trace&#39;</span>}<span class="sc">;</span>

<span class="c"># sleep in seconds for processing loop, not needed...</span>
<span class="k">our</span> <span class="i">$sleep</span> = <span class="i">$jabber_configuration</span>{<span class="q">&#39;sleep&#39;</span>}<span class="sc">;</span>

<span class="c"># clearly this is very insecure, should be held as a smartcard token for example, this</span>
<span class="c"># passphrase unlocks the private key for decrpyting the incoming transactions</span>
<span class="c"># users private key on client is used to sign transactions</span>

<span class="c"># note the key and the running user must correspond, otherwise the key won&#39;t get released by gpg</span>
<span class="k">our</span> <span class="i">$passphrase</span> = <span class="i">$jabber_configuration</span>{<span class="q">&#39;passphrase&#39;</span>}<span class="sc">;</span>

<span class="c"># this will leave data in the intermediate files and mail in the mailbox, if set to 1, avoids</span>
<span class="c"># resetting/resending etc. when debugging</span>
<span class="k">my</span> <span class="i">$debug</span> = <span class="i">$jabber_configuration</span>{<span class="q">&#39;debug&#39;</span>}<span class="sc">;</span>

<span class="c"># for cron, replace these with hardcoded registry name</span>
<span class="k">our</span> <span class="i">$registry</span> = <span class="i">$jabber_configuration</span>{<span class="q">&#39;hardcoded_registry&#39;</span>}
  || <span class="i">$$cookieref</span>{<span class="w">registry</span>}<span class="sc">;</span>

<span class="c"># print out all the values in the configuration file, if debugging...</span>
<span class="k">if</span> <span class="s">(</span><span class="i">$debug</span><span class="s">)</span> <span class="s">{</span>
    <span class="k">foreach</span> <span class="k">my</span> <span class="i">$key</span> <span class="s">(</span> <span class="k">keys</span> <span class="i">%jabber_configuration</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">print</span> <span class="q">&quot;$key = $jabber_configuration{$key}\n&quot;</span><span class="sc">;</span>

    <span class="s">}</span>
<span class="s">}</span>

<span class="c"># validate the current registry</span>
<span class="c">#FIXME: this routine is repeated needs to go into a library</span>
<span class="k">my</span> <span class="s">(</span> <span class="i">$class</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span><span class="sc">;</span>
<span class="k">my</span> <span class="s">(</span> <span class="i">$error</span><span class="cm">,</span> <span class="i">$registryref</span> <span class="s">)</span> = <span class="i">get_where</span><span class="s">(</span>
    <span class="i">$class</span><span class="cm">,</span> <span class="i">$registry</span><span class="cm">,</span> <span class="q">&#39;om_registry&#39;</span><span class="cm">,</span> <span class="q">&#39;*&#39;</span><span class="cm">,</span>
    <span class="q">&#39;name&#39;</span><span class="cm">,</span> <span class="i">$registry</span><span class="cm">,</span> <span class="i">$token</span><span class="cm">,</span>        <span class="q">&#39;&#39;</span><span class="cm">,</span>
    <span class="q">&#39;&#39;</span>
<span class="s">)</span><span class="sc">;</span>

<span class="k">if</span> <span class="s">(</span> <span class="k">length</span><span class="s">(</span><span class="i">$error</span><span class="s">)</span> <span class="s">)</span> <span class="s">{</span>
    <span class="i">log_entry</span><span class="s">(</span> <span class="i">$class</span><span class="cm">,</span> <span class="i">$registry</span><span class="cm">,</span> <span class="q">&#39;fatal&#39;</span><span class="cm">,</span>
        <span class="q">&quot;database error for $registry: $error&quot;</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">exit</span> <span class="n">0</span><span class="sc">;</span>
<span class="s">}</span>

<span class="c"># set the stop signals, probably needs review, depending on how run...</span>
<span class="i">set_signals</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>

<span class="k">our</span> <span class="i">$connection</span> = <span class="w">new</span> <span class="i">Net::XMPP::Client</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>

<span class="i">$connection</span><span class="i">-&gt;SetCallBacks</span><span class="s">(</span>
    <span class="w">message</span>  <span class="cm">=&gt;</span> \<span class="i">&amp;in_message</span><span class="cm">,</span>
    <span class="w">presence</span> <span class="cm">=&gt;</span> \<span class="i">&amp;in_presence</span><span class="cm">,</span>
    <span class="w">iq</span>       <span class="cm">=&gt;</span> \<span class="i">&amp;in_iq</span>
<span class="s">)</span><span class="sc">;</span>

<span class="k">my</span> <span class="i">$status</span> = <span class="i">$connection</span><span class="i">-&gt;Connect</span><span class="s">(</span>
    <span class="w">hostname</span> <span class="cm">=&gt;</span> <span class="i">$server</span><span class="cm">,</span>
    <span class="w">port</span>     <span class="cm">=&gt;</span> <span class="i">$port</span>
<span class="s">)</span><span class="sc">;</span>

<span class="k">if</span> <span class="s">(</span> !<span class="s">(</span> <span class="k">defined</span><span class="s">(</span><span class="i">$status</span><span class="s">)</span> <span class="s">)</span> <span class="s">)</span> <span class="s">{</span>
    <span class="k">print</span> <span class="q">&quot;ERROR:  Jabber server is down or connection was not allowed.\n&quot;</span><span class="sc">;</span>
    <span class="k">print</span> <span class="q">&quot;        ($!)\n&quot;</span><span class="sc">;</span>
    <span class="k">exit</span><span class="s">(</span><span class="n">0</span><span class="s">)</span><span class="sc">;</span>
<span class="s">}</span>

</pre><p>signed_presence_not_working</p><p>#my $gpg = new GnuPG( 'trace' =&gt; $trace );</p>
<p>#FIXME: Signed prssence to be sorted out, something in the Perl libraries
# input but not put into the presence XML stanza</p>
<p>$gpg-&gt;sign(
    plaintext  =&gt; &quot;/tmp/online.txt&quot;,
    passphrase =&gt; $passphrase,
    output     =&gt; &quot;/tmp/sign.txt&quot;,
    'armor'    =&gt; 1
);</p>

<pre>
<span class="k">my</span> <span class="i">$signature</span> = <span class="q">&#39;dummy signature for testing&#39;</span><span class="sc">;</span>

<span class="k">my</span> <span class="i">@result</span> = <span class="i">$connection</span><span class="i">-&gt;AuthSend</span><span class="s">(</span>
    <span class="w">username</span> <span class="cm">=&gt;</span> <span class="i">$username</span><span class="cm">,</span>
    <span class="w">password</span> <span class="cm">=&gt;</span> <span class="i">$password</span><span class="cm">,</span>

    <span class="c"># registry is used as resource at present...</span>
    <span class="w">resource</span> <span class="cm">=&gt;</span> <span class="i">$resource</span>

<span class="s">)</span><span class="sc">;</span>

<span class="k">if</span> <span class="s">(</span> <span class="i">$result</span>[<span class="n">0</span>] <span class="k">ne</span> <span class="q">&quot;ok&quot;</span> <span class="s">)</span> <span class="s">{</span>
    <span class="k">print</span> <span class="q">&quot;ERROR: Authorization failed: $result[0] - $result[1]\n&quot;</span><span class="sc">;</span>
    <span class="k">exit</span><span class="s">(</span><span class="n">0</span><span class="s">)</span><span class="sc">;</span>
<span class="s">}</span>

<span class="k">print</span> <span class="q">&quot;Logged in to $server:$port...\n&quot;</span><span class="sc">;</span>

<span class="i">$connection</span><span class="i">-&gt;RosterGet</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>

<span class="k">print</span> <span class="q">&quot;Getting Roster to tell server to send presence info...\n&quot;</span><span class="sc">;</span>
<span class="k">my</span> <span class="i">%x</span><span class="sc">;</span>

<span class="c">###my $pres = new Net::XMPP::Presence(%x, &#39;signature&#39; =&gt; $signature) ;</span>

<span class="c"># this doesn&#39;t seem to send anything in the signature stanza though...</span>
<span class="i">$connection</span><span class="i">-&gt;PresenceSend</span><span class="s">(</span> <span class="q">&#39;signature&#39;</span> <span class="cm">=&gt;</span> <span class="i">$signature</span> <span class="s">)</span><span class="sc">;</span>

<span class="k">print</span> <span class="q">&quot;Sending presence to tell world that we are logged in...\n&quot;</span><span class="sc">;</span>

<span class="k">while</span> <span class="s">(</span> <span class="k">defined</span><span class="s">(</span> <span class="i">$connection</span><span class="i">-&gt;Process</span><span class="s">(</span><span class="s">)</span> <span class="s">)</span> <span class="s">)</span> <span class="s">{</span> <span class="s">}</span>

<span class="k">print</span> <span class="q">&quot;ERROR: The connection was killed...\n&quot;</span><span class="sc">;</span>

<span class="k">exit</span><span class="s">(</span><span class="n">0</span><span class="s">)</span><span class="sc">;</span>

<a name="EOF-"></a></pre></body>

</html>
