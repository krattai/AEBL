<?xml version="1.0" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>Ccu.pm</title>
<meta http-equiv="content-type" content="text/html; charset=utf-8" />
<link rev="made" href="mailto:root@localhost" />
</head>

<style type="text/css">
<!--
/* default style sheet generated by perltidy */
body {background: #FFFFFF; color: #000000}
pre { color: #000000; 
      background: #F0F0F0;
      font-family: courier;
    } 

.c  { color: #228B22;} /* comment */
.cm { color: #000000;} /* comma */
.co { color: #000000;} /* colon */
.h  { color: #CD5555; font-weight:bold;} /* here-doc-target */
.hh { color: #CD5555; font-style:italic;} /* here-doc-text */
.i  { color: #00688B;} /* identifier */
.j  { color: #CD5555; font-weight:bold;} /* label */
.k  { color: #8B008B; font-weight:bold;} /* keyword */
.m  { color: #FF0000; font-weight:bold;} /* subroutine */
.n  { color: #B452CD;} /* numeric */
.p  { color: #000000;} /* paren */
.pd { color: #228B22; font-style:italic;} /* pod-text */
.pu { color: #000000;} /* punctuation */
.q  { color: #CD5555;} /* quote */
.s  { color: #000000;} /* structure */
.sc { color: #000000;} /* semicolon */
.v  { color: #B452CD;} /* v-string */
.w  { color: #000000;} /* bareword */
-->
</style>
<body style="background-color: white">
<a name="-top-"></a>
<h1>Ccu.pm</h1>


<!-- INDEX BEGIN -->
<div name="index">
<p><a name="__index__"></a></p>

<ul>

	<li><a href="#name">NAME</a></li>
	<li><a href="#synopsis">SYNOPSIS</a></li>
	<li><a href="#description">DESCRIPTION</a></li>
	<li><a href="#author">AUTHOR</a></li>
	<li><a href="#copyright">COPYRIGHT</a></li>
	<ul>

		<ul>

			<li><a href="#cgiparse">cgiparse</a></li>
			<li><a href="#debug_soap">debug_soap</a></li>
			<li><a href="#display_template">display_template</a></li>
			<li><a href="#getdateandtime">getdateandtime</a></li>
			<li><a href="#error">error</a></li>
			<li><a href="#make_page_links">make_page_links</a></li>
			<li><a href="#printhead">printhead</a></li>
			<li><a href="#readmessages">readmessages</a></li>
			<li><a href="#format_for_uk_mobile">format_for_uk_mobile</a></li>
			<li><a href="#format_for_standard_mobile">format_for_standard_mobile</a></li>
			<li><a href="#get_os_and_distribution">get_os_and_distribution</a></li>
			<li><a href="#check_paths">check_paths</a></li>
			<li><a href="#make_html_row_contents">make_html_row_contents</a></li>
			<li><a href="#make_html_transaction_totals">make_html_transaction_totals</a></li>
			<li><a href="#deliver_remote_data">deliver_remote_data</a></li>
			<li><a href="#sql_timestamp">sql_timestamp</a></li>
			<li><a href="#decide_language">decide_language</a></li>
			<li><a href="#debug_hash_contents">debug_hash_contents</a></li>
			<li><a href="#debug_message">debug_message</a></li>
			<li><a href="#deliver_datatables_data">deliver_datatables_data</a></li>
			<li><a href="#pretty_status">pretty_status</a></li>
		</ul>

	</ul>

</ul>

<hr name="index" />
</div>
<!-- INDEX END -->
<h2>Code Index:</h2>
<!-- BEGIN CODE INDEX --><a name="code-index"></a>
<ul>
<li><a href="#package-Ccu-">package Ccu</a>
<ul>
<li><a href="#cgiparse-">cgiparse</a></li>
<li><a href="#debug_soap-">debug_soap</a></li>
<li><a href="#display_template-">display_template</a></li>
<li><a href="#getdateandtime-">getdateandtime</a></li>
<li><a href="#error-">error</a></li>
<li><a href="#make_page_links-">make_page_links</a></li>
<li><a href="#printhead-">printhead</a></li>
<li><a href="#readmessages-">readmessages</a></li>
<li><a href="#format_for_uk_mobile-">format_for_uk_mobile</a></li>
<li><a href="#format_for_standard_mobile-">format_for_standard_mobile</a></li>
<li><a href="#get_os_and_distribution-">get_os_and_distribution</a></li>
<li><a href="#check_paths-">check_paths</a></li>
<li><a href="#make_html_row_contents-">make_html_row_contents</a></li>
<li><a href="#make_html_transaction_totals-">make_html_transaction_totals</a></li>
<li><a href="#deliver_remote_data-">deliver_remote_data</a></li>
<li><a href="#sql_timestamp-">sql_timestamp</a></li>
<li><a href="#decide_language-">decide_language</a></li>
<li><a href="#debug_hash_contents-">debug_hash_contents</a></li>
<li><a href="#debug_message-">debug_message</a></li>
<li><a href="#deliver_datatables_data-">deliver_datatables_data</a></li>
<li><a href="#pretty_status-">pretty_status</a></li>
</ul>
</li>
<li><a href="#EOF-">EOF</a></li>
</ul>
<!-- END CODE INDEX -->

<p>
</p>
<h1><a name="name">NAME</a></h1>
<p>Ccu.pm</p>
<p>
</p>
<hr />
<h1><a name="synopsis">SYNOPSIS</a></h1>
<p>Utility routines for Cclite</p>
<p>
</p>
<hr />
<h1><a name="description">DESCRIPTION</a></h1>
<p>This is package of utilities for the Cclite package 
stuff to read configuration files, literals files, lightweight cgi parser
read in and localise web forms etc.</p>
<p>Problem with collect_items, in Cclite currently, should be moved...1/12/2005</p>
<p>
</p>
<hr />
<h1><a name="author">AUTHOR</a></h1>
<p>Hugh Barnard</p>
<p>
</p>
<hr />
<h1><a name="copyright">COPYRIGHT</a></h1>
<p>(c) Hugh Barnard 2005 GPL Licenced</p>
<pre>
<a name="package-Ccu-"></a><span class="k">package </span><span class="i">Ccu</span><span class="sc">;</span>

<span class="k">use</span> <span class="w">strict</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">Cccookie</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">Cwd</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">vars</span> <span class="q">qw(@ISA @EXPORT)</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">Exporter</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">Data::Dumper</span><span class="sc">;</span>

<span class="c">#use Log::Message::Simple qw[msg error debug carp croak cluck confess];</span>
<span class="c"># removed pretty_caller 24/01/2014</span>

<span class="k">my</span> <span class="i">$VERSION</span> = <span class="n">1.00</span><span class="sc">;</span>
<span class="i">@ISA</span> = <span class="q">qw(Exporter)</span><span class="sc">;</span>

<span class="i">@EXPORT</span> = <span class="q">qw(debug</span>
  <span class="q">cgiparse</span>
  <span class="q">readmessages</span>
  <span class="q">debug_soap</span>
  <span class="q">debug_hash_contents</span>
  <span class="q">debug_message</span>
  <span class="q">decide_language</span>
  <span class="q">deliver_remote_data</span>
  <span class="q">display_template</span>
  <span class="q">make_page_links</span>
  <span class="q">make_html_row_contents</span>
  <span class="q">make_html_transaction_totals</span>
  <span class="q">edit_column_display</span>
  <span class="q">getdirectoryentries</span>
  <span class="q">checkstatus</span>
  <span class="q">getdateandtime</span>
  <span class="q">functiondoc</span>
  <span class="q">error</span>
  <span class="q">result</span>
  <span class="q">printhead</span>
  <span class="q">sql_timestamp</span>
  <span class="q">get_os_and_distribution</span>
  <span class="q">check_paths</span>
  <span class="q">format_for_uk_mobile</span>
  <span class="q">format_for_standard_mobile)</span><span class="sc">;</span>

<span class="i">$ENV</span>{<span class="w">IFS</span>} = <span class="q">&#39;&#39;</span><span class="sc">;</span>

</pre><p></p>
<h3><a name="cgiparse">cgiparse</a></h3>
<p>Lightweight cgi parser routine. Can be modified to not accept html,
possible system commands etc.</p>
<pre>
<a name="cgiparse-"></a><span class="k">sub </span><span class="m">cgiparse</span> <span class="s">{</span>
    <span class="k">my</span> <span class="i">$key</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$value</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">%fields</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$query</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">@query</span><span class="sc">;</span>

    <span class="k">if</span> <span class="s">(</span> <span class="i">$ENV</span>{<span class="q">&#39;REQUEST_METHOD&#39;</span>} <span class="k">eq</span> <span class="q">&#39;POST&#39;</span> || <span class="i">$ENV</span>{<span class="q">&#39;REQUEST_METHOD&#39;</span>} <span class="k">eq</span> <span class="q">&#39;post&#39;</span> <span class="s">)</span>
    <span class="s">{</span>
        <span class="k">sysread</span><span class="s">(</span> <span class="w">STDIN</span><span class="cm">,</span> <span class="i">$query</span><span class="cm">,</span> <span class="i">$ENV</span>{<span class="q">&#39;CONTENT_LENGTH&#39;</span>} <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span> <span class="k">else</span> <span class="s">{</span>
        <span class="i">$query</span> = <span class="i">$ENV</span>{<span class="q">&#39;QUERY_STRING&#39;</span>}<span class="sc">;</span>
    <span class="s">}</span>
    <span class="i">@query</span> = <span class="k">split</span><span class="s">(</span> <span class="q">/&amp;/</span><span class="cm">,</span> <span class="i">$query</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">foreach</span> <span class="s">(</span><span class="i">@query</span><span class="s">)</span> <span class="s">{</span>
        <span class="q">s/\+/ /g</span><span class="sc">;</span>
        <span class="q">s/%(..)/pack(&quot;c&quot;,hex($1))/ge</span><span class="sc">;</span>
        <span class="s">(</span> <span class="i">$key</span><span class="cm">,</span> <span class="i">$value</span> <span class="s">)</span> = <span class="k">split</span><span class="s">(</span><span class="q">/=/</span><span class="s">)</span><span class="sc">;</span>
        <span class="i">$value</span> =~ <span class="q">s/[\&lt;\&gt;\,\;]//g</span><span class="sc">;</span>    <span class="c"># remove command separators etc.</span>
        <span class="i">$fields</span>{<span class="i">$key</span>} = <span class="i">$value</span><span class="sc">;</span>

    <span class="s">}</span>
    <span class="k">return</span> <span class="i">%fields</span><span class="sc">;</span>
<span class="s">}</span>

</pre><p></p>
<h3><a name="debug_soap">debug_soap</a></h3>
<p>Debug SOAP calls. This doesn't seem to work very well?
Why o why!</p>
<pre>
<a name="debug_soap-"></a><span class="k">sub </span><span class="m">debug_soap</span> <span class="s">{</span>
    <span class="k">my</span> <span class="s">(</span><span class="i">$str</span><span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>
    <span class="k">open</span><span class="s">(</span> <span class="w">LOG</span><span class="cm">,</span> <span class="q">&quot;&gt;&gt;../debug/debug.soap&quot;</span> <span class="s">)</span><span class="sc">;</span>
    <span class="c">###if (class($str) eq &quot;HTTP::Request&quot;) {</span>
    <span class="c">### print LOG $str-&gt;contents if (length($str));</span>
    <span class="c">###}</span>
    <span class="k">close</span> <span class="w">LOG</span><span class="sc">;</span>
<span class="s">}</span>

</pre><p></p>
<h3><a name="display_template">display_template</a></h3>
<p>display html from template...
uses HTML::Template included with the package
note that the $html variable is badly named, it should be 'message' or something</p>
<pre>
<a name="display_template-"></a><span class="k">sub </span><span class="m">display_template</span> <span class="s">{</span>

    <span class="k">my</span> <span class="s">(</span>
        <span class="i">$refresh</span><span class="cm">,</span>  <span class="i">$metarefresh</span><span class="cm">,</span> <span class="i">$error</span><span class="cm">,</span>   <span class="i">$html</span><span class="cm">,</span> <span class="i">$pages</span><span class="cm">,</span>
        <span class="i">$pagename</span><span class="cm">,</span> <span class="i">$fieldsref</span><span class="cm">,</span>   <span class="i">$cookies</span><span class="cm">,</span> <span class="i">$token</span>
    <span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">%configuration</span><span class="sc">;</span>

    <span class="c">#FIXME: hack to deal with cpanel database names....</span>
    <span class="k">if</span> <span class="s">(</span> <span class="i">$0</span> !~ <span class="q">/ccinstall/</span> <span class="s">)</span> <span class="s">{</span>

        <span class="i">%configuration</span> = <span class="i">Ccconfiguration::readconfiguration</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>

        <span class="k">foreach</span> <span class="k">my</span> <span class="i">$key</span> <span class="s">(</span><span class="i">%$fieldsref</span><span class="s">)</span> <span class="s">{</span>
            <span class="k">if</span> <span class="s">(</span> <span class="i">$key</span> =~ <span class="q">/registry/</span> <span class="s">)</span> <span class="s">{</span>
                <span class="i">$fieldsref</span>-&gt;{<span class="i">$key</span>} =~ <span class="q">s/$configuration{&#39;cpanelprefix&#39;}_//</span><span class="sc">;</span>
            <span class="s">}</span>
        <span class="s">}</span>
    <span class="s">}</span>

<span class="c"># only refresh is [mis]used to carry json payload if json is being returned 2/2011</span>
<span class="c"># prints the cookies, if any, the json and exits..</span>
    <span class="k">if</span> <span class="s">(</span> <span class="i">$fieldsref</span>-&gt;{<span class="q">&#39;mode&#39;</span>} <span class="k">eq</span> <span class="q">&#39;json&#39;</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">print</span> <span class="h">&lt;&lt;EOT</span><span class="sc">;</span>
<span class="hh">Content-type: application/json</span>
<span class="hh">$cookies</span>
<span class="hh">$refresh</span>
<span class="h">EOT</span>

        <span class="k">return</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="k">if</span> <span class="s">(</span><span class="i">$refresh</span><span class="s">)</span> <span class="s">{</span>
        <span class="i">$metarefresh</span> = <span class="h">&lt;&lt;EOT</span><span class="sc">;</span>
<span class="hh">&lt;meta http-equiv=&quot;refresh&quot; content=&quot;2;URL=$metarefresh&quot;&gt;</span>
<span class="h">EOT</span>

    <span class="s">}</span>

    <span class="c"># this is to generalise the passing of $fieldsref to the template</span>
    <span class="c"># under many circumstances it&#39;ll include all the field data</span>
    <span class="c"># probably need a convention to separate the two name spaces somewhat</span>

    <span class="i">$fieldsref</span>-&gt;{<span class="q">&#39;metarefresh&#39;</span>} = <span class="i">$metarefresh</span><span class="sc">;</span>
    <span class="i">$fieldsref</span>-&gt;{<span class="q">&#39;error&#39;</span>}       = <span class="i">$error</span><span class="sc">;</span>
    <span class="i">$fieldsref</span>-&gt;{<span class="q">&#39;html&#39;</span>}        = <span class="i">$html</span><span class="sc">;</span>

    <span class="c">###debug_hash_contents($fieldsref) ;</span>

    <span class="c"># display logon registry and language information</span>
    <span class="k">my</span> <span class="i">$cookieref</span> = <span class="i">get_cookie</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$date</span><span class="cm">,</span> <span class="i">$time</span> <span class="s">)</span> = <span class="i">getdateandtime</span><span class="s">(</span> <span class="k">time</span><span class="s">(</span><span class="s">)</span> <span class="s">)</span><span class="sc">;</span>

    <span class="c"># if not logging off, now transferred to cclite</span>
    <span class="k">if</span> <span class="s">(</span> <span class="i">$fieldsref</span>-&gt;{<span class="w">action</span>} <span class="k">ne</span> <span class="q">&quot;logoff&quot;</span> <span class="s">)</span> <span class="s">{</span>

        <span class="i">$fieldsref</span>-&gt;{<span class="w">language</span>} = <span class="i">$cookieref</span>-&gt;{<span class="w">language</span>}
          <span class="k">if</span> <span class="s">(</span> <span class="k">length</span><span class="s">(</span> <span class="i">$cookieref</span>-&gt;{<span class="w">language</span>} <span class="s">)</span> <span class="s">)</span><span class="sc">;</span>

        <span class="i">$fieldsref</span>-&gt;{<span class="w">registry</span>} = <span class="i">$cookieref</span>-&gt;{<span class="w">registry</span>}
          <span class="k">if</span> <span class="s">(</span> <span class="k">length</span><span class="s">(</span> <span class="i">$cookieref</span>-&gt;{<span class="w">registry</span>} <span class="s">)</span> <span class="s">)</span><span class="sc">;</span>

        <span class="i">$fieldsref</span>-&gt;{<span class="w">date</span>} = <span class="i">$date</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="c"># display logon if not logged on, otherwise display the trades form</span>
    <span class="c"># needs modification to allow/disallow certain actions</span>
    <span class="k">if</span> <span class="s">(</span> <span class="k">length</span><span class="s">(</span><span class="i">$pagename</span><span class="s">)</span> <span class="s">)</span> <span class="s">{</span>
        <span class="i">$fieldsref</span>-&gt;{<span class="w">pagename</span>} = <span class="i">$pagename</span><span class="sc">;</span>

        <span class="c"># simple gatekeeper against cash trades if not admin</span>
        <span class="c"># FIXME: a little ugly really....</span>
        <span class="k">if</span> <span class="s">(</span>   <span class="i">$fieldsref</span>-&gt;{<span class="w">pagename</span>} <span class="k">eq</span> <span class="q">&quot;admintrades.html&quot;</span>
            &amp;&amp; <span class="i">$cookieref</span>-&gt;{<span class="w">userLevel</span>} <span class="k">ne</span> <span class="q">&#39;admin&#39;</span> <span class="s">)</span>
        <span class="s">{</span>
            <span class="i">$fieldsref</span>-&gt;{<span class="w">pagename</span>} = <span class="q">&quot;trades.html&quot;</span><span class="sc">;</span>
        <span class="s">}</span> <span class="k">elsif</span> <span class="s">(</span> <span class="i">$fieldsref</span>-&gt;{<span class="w">pagename</span>} <span class="k">eq</span> <span class="q">&quot;trades.html&quot;</span>
            &amp;&amp; <span class="i">$cookieref</span>-&gt;{<span class="w">userLevel</span>} <span class="k">eq</span> <span class="q">&#39;admin&#39;</span> <span class="s">)</span>
        <span class="s">{</span>
            <span class="i">$fieldsref</span>-&gt;{<span class="w">pagename</span>} = <span class="q">&quot;admintrades.html&quot;</span><span class="sc">;</span>
        <span class="s">}</span>

    <span class="s">}</span> <span class="k">elsif</span> <span class="s">(</span> !<span class="k">length</span><span class="s">(</span> <span class="i">$cookieref</span>-&gt;{<span class="w">userLogin</span>} <span class="s">)</span> <span class="s">)</span> <span class="s">{</span>
        <span class="i">$fieldsref</span>-&gt;{<span class="w">pagename</span>} = <span class="q">&quot;logon.html&quot;</span><span class="sc">;</span>
    <span class="s">}</span> <span class="k">else</span> <span class="s">{</span>

        <span class="c"># new cash functions etc. for admins (tellers) only</span>
        <span class="k">if</span> <span class="s">(</span> <span class="i">$cookieref</span>-&gt;{<span class="w">userLevel</span>} <span class="k">eq</span> <span class="q">&#39;admin&#39;</span> <span class="s">)</span> <span class="s">{</span>
            <span class="i">$fieldsref</span>-&gt;{<span class="w">pagename</span>} = <span class="q">&quot;admintrades.html&quot;</span><span class="sc">;</span>
        <span class="s">}</span> <span class="k">else</span> <span class="s">{</span>
            <span class="i">$fieldsref</span>-&gt;{<span class="w">pagename</span>} = <span class="q">&quot;trades.html&quot;</span><span class="sc">;</span>
        <span class="s">}</span>

    <span class="s">}</span>

    <span class="k">my</span> <span class="i">%messages</span><span class="sc">;</span>

    <span class="k">if</span> <span class="s">(</span> <span class="k">length</span><span class="s">(</span> <span class="i">$cookieref</span>-&gt;{<span class="w">token</span>} <span class="s">)</span> <span class="s">)</span> <span class="s">{</span>

        <span class="k">my</span> <span class="i">$login</span> = <span class="i">$cookieref</span>-&gt;{<span class="q">&#39;userLogin&#39;</span>} || <span class="i">$fieldsref</span>-&gt;{<span class="q">&#39;userLogin&#39;</span>}<span class="sc">;</span>
        <span class="i">%messages</span>                  = <span class="i">readmessages</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
        <span class="i">$fieldsref</span>-&gt;{<span class="q">&#39;youare&#39;</span>}     = <span class="q">&quot;$messages{youare} $login&quot;</span><span class="sc">;</span>
        <span class="i">$fieldsref</span>-&gt;{<span class="q">&#39;atregistry&#39;</span>} = <span class="q">&quot;$messages{at} $fieldsref-&gt;{registry}&quot;</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="c"># collect currencies and partners, if a trade operation</span>
    <span class="c"># always add a blank option as first to prevent unconscious defaults</span>
    <span class="c"># don&#39;t do these unless registry defined,</span>
    <span class="c">#</span>

    <span class="k">my</span> <span class="i">$blank_option</span> = <span class="q">&quot;&lt;option value=\&quot;\&quot;&gt;&lt;/option&gt;&quot;</span><span class="sc">;</span>

    <span class="c"># not done for install, blocked &#39;new&#39; installer 6/4/2011</span>
    <span class="k">if</span> <span class="s">(</span> <span class="i">$pagename</span> !~ <span class="q">/logon/</span>
        &amp;&amp; <span class="k">length</span><span class="s">(</span> <span class="i">$cookieref</span>-&gt;{<span class="q">&#39;registry&#39;</span>} &amp;&amp; <span class="i">$0</span> !~ <span class="q">/ccinstall/</span> <span class="s">)</span> <span class="s">)</span>
    <span class="s">{</span>
        <span class="k">my</span> <span class="s">(</span> <span class="i">$option_string</span><span class="cm">,</span> <span class="i">$count</span> <span class="s">)</span> =
          <span class="i">Cclite::collect_items</span><span class="s">(</span> <span class="q">&#39;local&#39;</span><span class="cm">,</span> <span class="i">$fieldsref</span>-&gt;{<span class="w">registry</span>}<span class="cm">,</span>
            <span class="q">&#39;om_currencies&#39;</span><span class="cm">,</span> <span class="i">$fieldsref</span><span class="cm">,</span> <span class="q">&#39;name&#39;</span><span class="cm">,</span> <span class="q">&#39;select&#39;</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span><span class="sc">;</span>

        <span class="c"># get the latest news field from the registry for front page display</span>
        <span class="i">$fieldsref</span>-&gt;{<span class="q">&#39;latest_news&#39;</span>} =
          <span class="i">Cclite::get_news</span><span class="s">(</span> <span class="q">&#39;local&#39;</span><span class="cm">,</span> <span class="i">$fieldsref</span>-&gt;{<span class="q">&#39;registry&#39;</span>}<span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span>
          <span class="k">if</span> <span class="s">(</span> <span class="k">length</span><span class="s">(</span> <span class="i">$cookieref</span>-&gt;{<span class="w">registry</span>} <span class="s">)</span> <span class="s">)</span><span class="sc">;</span>

        <span class="c"># format it for user level users, admin needs to edit it</span>
        <span class="i">$fieldsref</span>-&gt;{<span class="q">&#39;latest_news&#39;</span>} =
          <span class="q">&quot;&lt;span class=\&quot;news\&quot;&gt;$fieldsref-&gt;{latest_news}&lt;\/span&gt;&quot;</span>
          <span class="k">if</span> <span class="s">(</span> <span class="i">$cookieref</span>-&gt;{<span class="w">userLevel</span>} <span class="k">ne</span> <span class="q">&quot;admin&quot;</span>
            &amp;&amp; <span class="k">length</span><span class="s">(</span> <span class="i">$fieldsref</span>-&gt;{<span class="w">latest_news</span>} <span class="s">)</span> <span class="s">)</span><span class="sc">;</span>

        <span class="c"># this is the primary currency or the &#39;only&#39; one</span>
        <span class="i">$fieldsref</span>-&gt;{<span class="w">selectcurrency</span>} = <span class="h">&lt;&lt;EOT</span> <span class="sc">;</span>
<span class="hh">&lt;select class=&quot;required&quot; name=&quot;tradeCurrency&quot;&gt;$blank_option$option_string&lt;/select&gt;\n    </span>
<span class="h">EOT</span>

        <span class="c"># this is the secondary currency in a split transaction operation</span>

        <span class="i">$fieldsref</span>-&gt;{<span class="w">sselectcurrency</span>} = <span class="h">&lt;&lt;EOT</span> <span class="sc">;</span>
<span class="hh">&lt;select class=&quot;required&quot; name=&quot;stradeCurrency&quot;&gt;$blank_option$option_string&lt;/select&gt;\n    </span>
<span class="h">EOT</span>

        <span class="c"># collect partners for registry operations, if multiregistry</span>
        <span class="c"># add local registry to option string!</span>
        <span class="c"># otherwise just present local registry as readonly field</span>
        <span class="c"># not quite right 04/2012 since local multiregistry does NOT</span>
        <span class="c"># need SOAP, corrected and collect_items modified...</span>
        <span class="k">my</span> <span class="i">$count</span> = <span class="n">0</span><span class="sc">;</span>

        <span class="k">if</span> <span class="s">(</span> <span class="k">length</span><span class="s">(</span> <span class="i">$cookieref</span>-&gt;{<span class="q">&#39;registry&#39;</span>} <span class="s">)</span> <span class="s">)</span> <span class="s">{</span>
            <span class="s">(</span> <span class="i">$option_string</span><span class="cm">,</span> <span class="i">$count</span> <span class="s">)</span> =
              <span class="i">Cclite::collect_items</span><span class="s">(</span> <span class="q">&#39;local&#39;</span><span class="cm">,</span> <span class="i">$fieldsref</span>-&gt;{<span class="w">registry</span>}<span class="cm">,</span>
                <span class="q">&#39;om_partners&#39;</span><span class="cm">,</span> <span class="i">$fieldsref</span><span class="cm">,</span> <span class="q">&#39;name&#39;</span><span class="cm">,</span> <span class="q">&#39;select&#39;</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span><span class="sc">;</span>
            <span class="k">if</span> <span class="s">(</span> <span class="i">$count</span> &gt; <span class="n">0</span> <span class="s">)</span> <span class="s">{</span>
                <span class="i">$option_string</span> .=
<span class="q">&quot;&lt;option value=\&quot;$fieldsref-&gt;{registry}\&quot;&gt;\u$fieldsref-&gt;{registry}&lt;/option&gt;&quot;</span><span class="sc">;</span>
                <span class="i">$fieldsref</span>-&gt;{<span class="w">selectpartners</span>} = <span class="h">&lt;&lt;EOT</span> <span class="sc">;</span>
<span class="hh">&lt;select class=&quot;required&quot; name=&quot;toregistry&quot;&gt;$blank_option$option_string&lt;/select&gt;    </span>
<span class="h">EOT</span>

            <span class="s">}</span> <span class="k">else</span> <span class="s">{</span>

                <span class="i">$fieldsref</span>-&gt;{<span class="w">selectpartners</span>} = <span class="h">&lt;&lt;EOT</span> <span class="sc">;</span>
<span class="hh">&lt;input class=&quot;grey&quot;</span>
<span class="hh"> name=&quot;toregistry&quot; class=&quot;required&quot; readonly=&quot;readonly&quot; size=&quot;30&quot; maxlength=&quot;255&quot; value=&quot;$fieldsref-&gt;{registry}&quot; type=&quot;text&quot;&gt;   </span>
<span class="h">EOT</span>
            <span class="s">}</span>

        <span class="s">}</span>

    <span class="s">}</span>

    <span class="c"># this is now changed to use om_categories, based on Camden LETS</span>
    <span class="c"># rather than the SIC codes. should become &#39;pluggable&#39; eventually.</span>
    <span class="c"># the codes now have a tree structure, category and parent (category).</span>
    <span class="c"># as of 07/2011 this is switched off, if free form tags are allowed</span>

    <span class="k">if</span> <span class="s">(</span>   <span class="i">$pagename</span> =~ <span class="q">/yellowpages/</span>
        &amp;&amp; <span class="k">length</span><span class="s">(</span> <span class="i">$cookieref</span>-&gt;{<span class="q">&#39;registry&#39;</span>} <span class="s">)</span>
        &amp;&amp; <span class="i">$configuration</span>{<span class="q">&#39;usetags&#39;</span>} <span class="k">ne</span> <span class="q">&#39;yes&#39;</span> <span class="s">)</span>
    <span class="s">{</span>

        <span class="c"># collect categories for yellow pages</span>
        <span class="k">my</span> <span class="s">(</span> <span class="i">$option_string</span><span class="cm">,</span> <span class="i">$count</span> <span class="s">)</span> =
          <span class="i">Cclite::collect_items</span><span class="s">(</span> <span class="q">&#39;local&#39;</span><span class="cm">,</span> <span class="i">$fieldsref</span>-&gt;{<span class="w">registry</span>}<span class="cm">,</span>
            <span class="q">&#39;om_categories&#39;</span><span class="cm">,</span> <span class="i">$fieldsref</span><span class="cm">,</span> <span class="q">&#39;description&#39;</span><span class="cm">,</span> <span class="q">&#39;select&#39;</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span><span class="sc">;</span>
        <span class="i">$fieldsref</span>-&gt;{<span class="w">selectclassification</span>} = <span class="h">&lt;&lt;EOT</span> <span class="sc">;</span>
<span class="hh"> &lt;select type=&quot;required&quot; name=&quot;classification&quot;&gt;$blank_option$option_string&lt;/select&gt;\n    </span>
<span class="h">EOT</span>

    <span class="s">}</span> <span class="k">else</span> <span class="s">{</span>

        <span class="i">$fieldsref</span>-&gt;{<span class="q">&#39;selectclassification&#39;</span>} = <span class="i">$messages</span>{<span class="q">&#39;usetags&#39;</span>}<span class="sc">;</span>
    <span class="s">}</span>

    <span class="k">if</span> <span class="s">(</span> <span class="i">$pagename</span> =~ <span class="q">/category/</span> &amp;&amp; <span class="k">length</span><span class="s">(</span> <span class="i">$cookieref</span>-&gt;{<span class="w">registry</span>} <span class="s">)</span> <span class="s">)</span> <span class="s">{</span>

        <span class="c"># collect major, if a category operation</span>
        <span class="c">#</span>
        <span class="k">my</span> <span class="s">(</span> <span class="i">$option_string</span><span class="cm">,</span> <span class="i">$count</span> <span class="s">)</span> =
          <span class="i">Cclite::collect_items</span><span class="s">(</span> <span class="q">&#39;local&#39;</span><span class="cm">,</span> <span class="i">$fieldsref</span>-&gt;{<span class="w">registry</span>}<span class="cm">,</span>
            <span class="q">&#39;om_categories&#39;</span><span class="cm">,</span> <span class="i">$fieldsref</span><span class="cm">,</span> <span class="q">&#39;parent&#39;</span><span class="cm">,</span> <span class="q">&#39;select&#39;</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span><span class="sc">;</span>
        <span class="i">$fieldsref</span>-&gt;{<span class="w">selectparent</span>} = <span class="h">&lt;&lt;EOT</span> <span class="sc">;</span>
<span class="hh"> &lt;select class=&quot;required&quot; name=&quot;parent&quot;&gt;$blank_option$option_string&lt;/select&gt;\n    </span>
<span class="h">EOT</span>

    <span class="s">}</span>

    <span class="k">print</span> <span class="h">&lt;&lt;EOT</span><span class="sc">;</span>
<span class="hh">Content-type: text/html</span>
<span class="hh">$cookies</span>
<span class="h">EOT</span>

<span class="c"># index is the default template page</span>
<span class="c"># added logic 8/2009 to return untemplated html, for &#39;foreign&#39; systems</span>
<span class="c"># this is the beginning of &#39;return for various representations, rss, json, csv etc.</span>

    <span class="k">if</span> <span class="s">(</span> !<span class="k">length</span><span class="s">(</span> <span class="i">$fieldsref</span>-&gt;{<span class="q">&#39;mode&#39;</span>} <span class="s">)</span> || <span class="i">$fieldsref</span>-&gt;{<span class="q">&#39;mode&#39;</span>} <span class="k">eq</span> <span class="q">&#39;html&#39;</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">if</span> <span class="s">(</span> !<span class="k">length</span><span class="s">(</span> <span class="i">$fieldsref</span>-&gt;{<span class="w">templatename</span>} <span class="s">)</span> <span class="s">)</span> <span class="s">{</span>
            <span class="i">$pages</span><span class="i">-&gt;Display</span><span class="s">(</span> <span class="q">&quot;index.html&quot;</span><span class="cm">,</span> <span class="i">$fieldsref</span> <span class="s">)</span><span class="sc">;</span>
        <span class="s">}</span> <span class="k">else</span> <span class="s">{</span>
            <span class="i">$pages</span><span class="i">-&gt;Display</span><span class="s">(</span> <span class="i">$fieldsref</span>-&gt;{<span class="w">templatename</span>}<span class="cm">,</span> <span class="i">$fieldsref</span> <span class="s">)</span><span class="sc">;</span>
        <span class="s">}</span>
    <span class="s">}</span> <span class="k">else</span> <span class="s">{</span>
        <span class="k">print</span> <span class="i">$fieldsref</span>-&gt;{<span class="w">html</span>}<span class="sc">;</span>
    <span class="s">}</span>

    <span class="k">exit</span> <span class="n">0</span><span class="sc">;</span>
<span class="s">}</span>

</pre><p></p>
<h3><a name="getdateandtime">getdateandtime</a></h3>
<p>Return the print formatted date and time of an input time, used by logging
and date stamping subroutines.</p>
<p>There's a scope or duplicate problem with this currently 08/2005</p>
<pre>
<a name="getdateandtime-"></a><span class="k">sub </span><span class="m">getdateandtime</span> <span class="s">{</span>
    <span class="k">my</span> <span class="s">(</span><span class="i">$input_time</span><span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>

    <span class="c"># get today from the system and make a yyyymmdd (Y2k compliant!) date</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$sec</span><span class="cm">,</span> <span class="i">$min</span><span class="cm">,</span> <span class="i">$hour</span><span class="cm">,</span> <span class="i">$mday</span><span class="cm">,</span> <span class="i">$lmon</span><span class="cm">,</span> <span class="i">$lyear</span><span class="cm">,</span> <span class="i">$wday</span><span class="cm">,</span> <span class="i">$yday</span><span class="cm">,</span> <span class="i">$isdst</span> <span class="s">)</span> =
      <span class="k">localtime</span><span class="s">(</span><span class="i">$input_time</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$time</span> = <span class="k">sprintf</span><span class="s">(</span> <span class="q">&quot;%.2d%.2d%.2d&quot;</span><span class="cm">,</span> <span class="i">$hour</span><span class="cm">,</span> <span class="i">$min</span><span class="cm">,</span> <span class="i">$sec</span> <span class="s">)</span><span class="sc">;</span>
    <span class="i">$lmon</span>++<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$numeric_day</span> =
      <span class="k">sprintf</span><span class="s">(</span> <span class="q">&quot;%.4d%.2d%.2d&quot;</span><span class="cm">,</span> <span class="s">(</span> <span class="i">$lyear</span> + <span class="n">1900</span> <span class="s">)</span><span class="cm">,</span> <span class="i">$lmon</span><span class="cm">,</span> <span class="i">$mday</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$literal_date</span> =
      <span class="k">sprintf</span><span class="s">(</span> <span class="q">&quot;%.2d/%.2d/%.4d&quot;</span><span class="cm">,</span> <span class="i">$mday</span><span class="cm">,</span> <span class="i">$lmon</span><span class="cm">,</span> <span class="s">(</span> <span class="i">$lyear</span> + <span class="n">1900</span> <span class="s">)</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">return</span> <span class="s">(</span> <span class="i">$numeric_day</span><span class="cm">,</span> <span class="i">$time</span> <span class="s">)</span><span class="sc">;</span>
<span class="s">}</span>

</pre><p></p>
<h3><a name="error">error</a></h3>
<p>Deal with unexpected errors
Should be used with try catch that is eval type constructs</p>
<pre>
<a name="error-"></a><span class="k">sub </span><span class="m">error</span> <span class="s">{</span>

    <span class="k">my</span> <span class="s">(</span> <span class="i">$language</span><span class="cm">,</span> <span class="i">$description</span><span class="cm">,</span> <span class="i">$support_mail</span><span class="cm">,</span> <span class="i">$support_literal</span> <span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$problem_literal</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$mailto</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$tellwebmaster_literal</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$bgcolour</span><span class="sc">;</span>

    <span class="i">printhead</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>

    <span class="k">print</span> <span class="h">&lt;&lt;EOT</span><span class="sc">;</span>
<span class="hh">  &lt;html&gt;</span>
<span class="hh">  &lt;head&gt;</span>
<span class="hh">   &lt;title&gt;Problem $description&lt;/title&gt;</span>
<span class="hh">  &lt;/head&gt;</span>
<span class="hh">  &lt;body bgcolor=$bgcolour&gt;</span>
<span class="hh">   &lt;H2&gt;$description &lt;/H2&gt;\n&lt;PRE&gt;</span>
<span class="hh">   $@</span>
<span class="hh">   &lt;/PRE&gt;</span>
<span class="hh">   &lt;a href=\&quot;mailto:$support_mail?subject=$_[1]\&quot;&gt;$support_literal&lt;/a&gt;</span>
<span class="hh">  &lt;/body&gt;</span>
<span class="hh">  &lt;/html&gt;</span>
<span class="h">EOT</span>
    <span class="k">exit</span> <span class="n">0</span><span class="sc">;</span>
<span class="s">}</span>

</pre><p></p>
<h3><a name="make_page_links">make_page_links</a></h3>
<p>Make multi-page links at top of page for 'many' records</p>
<pre>
<a name="make_page_links-"></a><span class="k">sub </span><span class="m">make_page_links</span> <span class="s">{</span>

    <span class="k">my</span> <span class="s">(</span> <span class="i">$count</span><span class="cm">,</span> <span class="i">$offset</span><span class="cm">,</span> <span class="i">$limit</span> <span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>

    <span class="c"># routine to make links for each page</span>
    <span class="k">my</span> <span class="i">$true_count</span> = <span class="i">$count</span> / <span class="i">$limit</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$page_count</span> = <span class="k">int</span><span class="s">(</span> <span class="i">$count</span> / <span class="i">$limit</span> <span class="s">)</span><span class="sc">;</span>

    <span class="c"># don&#39;t paginate single pages..</span>
    <span class="i">$page_count</span>++ <span class="k">if</span> <span class="s">(</span> <span class="s">(</span> <span class="i">$count</span> / <span class="i">$limit</span> <span class="s">)</span> &gt; <span class="i">$page_count</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">return</span> <span class="k">undef</span> <span class="k">if</span> <span class="s">(</span> <span class="i">$page_count</span> &lt;= <span class="n">1</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$x</span>      = <span class="i">$count</span> / <span class="i">$limit</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$script</span> = <span class="q">&quot;$ENV{SCRIPT_NAME}?$ENV{QUERY_STRING}&quot;</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$i</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$paging_html</span><span class="sc">;</span>

    <span class="k">for</span> <span class="s">(</span> <span class="i">$i</span> = <span class="n">0</span> <span class="sc">;</span> <span class="i">$i</span> &lt; <span class="i">$page_count</span> <span class="sc">;</span> <span class="i">$i</span>++ <span class="s">)</span> <span class="s">{</span>
        <span class="k">my</span> <span class="i">$new_offset</span>  = <span class="i">$i</span> * <span class="i">$limit</span><span class="sc">;</span>
        <span class="k">my</span> <span class="i">$page_number</span> = <span class="i">$i</span> + <span class="n">1</span><span class="sc">;</span>
        <span class="k">my</span> <span class="i">$link</span><span class="sc">;</span>
        <span class="k">if</span> <span class="s">(</span> <span class="i">$new_offset</span> != <span class="i">$offset</span> <span class="s">)</span> <span class="s">{</span>
            <span class="i">$link</span> = <span class="h">&lt;&lt;EOT</span><span class="sc">;</span>
<span class="hh">   &amp;nbsp;&lt;a class=\&quot;pagelink\&quot; href=&quot;$script\&amp;offset=$new_offset\&amp;limit=$limit&quot;&gt;$page_number&lt;/a&gt;</span>
<span class="h">EOT</span>

        <span class="s">}</span> <span class="k">else</span> <span class="s">{</span>
            <span class="i">$link</span> = <span class="q">&quot;&lt;span class=\&quot;currentlink\&quot;&gt;$page_number&lt;/span&gt;&quot;</span><span class="sc">;</span>
        <span class="s">}</span>

        <span class="i">$paging_html</span> .= <span class="i">$link</span><span class="sc">;</span>
        <span class="k">undef</span> <span class="i">$link</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="k">return</span> <span class="i">$paging_html</span><span class="sc">;</span>
<span class="s">}</span>

</pre><p></p>
<h3><a name="printhead">printhead</a></h3>
<p>Just print a content header
This is also probably dead code</p>
<pre>
<a name="printhead-"></a><span class="k">sub </span><span class="m">printhead</span> <span class="s">{</span>
    <span class="k">print</span> <span class="h">&lt;&lt;EOT</span><span class="sc">;</span>
<span class="hh">Content-type: text/html</span>

<span class="h">EOT</span>
    <span class="k">return</span><span class="sc">;</span>
<span class="s">}</span>

</pre><p></p>
<h3><a name="readmessages">readmessages</a></h3>
<p>Read the messages file for the given language</p>
<p>This has always been somewhat problematic, now finds file,
depending on the package or installation type:</p>
<p>0: linux commodity hosting, home directory
1: windows
2: debian or ubuntu packaged</p>
<pre>
<a name="readmessages-"></a><span class="k">sub </span><span class="m">readmessages</span> <span class="s">{</span>

    <span class="k">my</span> <span class="s">(</span><span class="i">$language</span><span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>

    <span class="c">#FIXME: this is called in several places....</span>
    <span class="i">$language</span> = <span class="i">decide_language</span><span class="s">(</span><span class="s">)</span> <span class="k">if</span> <span class="s">(</span> !<span class="k">length</span><span class="s">(</span><span class="i">$language</span><span class="s">)</span> <span class="s">)</span><span class="sc">;</span>

    <span class="c"># deals with various directory structures</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$os</span><span class="cm">,</span> <span class="i">$distribution</span><span class="cm">,</span> <span class="i">$package_type</span> <span class="s">)</span> =
      <span class="i">get_os_and_distribution</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>    <span class="c"># see package type above</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$error</span><span class="cm">,</span> <span class="i">$dir</span><span class="cm">,</span> <span class="i">$libpath</span> <span class="s">)</span> =
      <span class="i">check_paths</span><span class="s">(</span><span class="i">$package_type</span><span class="s">)</span><span class="sc">;</span>    <span class="c"># check libraries exist/make base path</span>

    <span class="k">my</span> <span class="s">(</span> <span class="i">$package</span><span class="cm">,</span> <span class="i">$filename</span><span class="cm">,</span> <span class="i">$line</span> <span class="s">)</span> = <span class="k">caller</span><span class="sc">;</span>

    <span class="c">#FIXME: small kludge for debian</span>
    <span class="i">$dir</span> .= <span class="q">&#39;/&#39;</span> <span class="k">if</span> <span class="s">(</span> <span class="i">$dir</span> !~ <span class="q">/\/$/</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$messfile</span> = <span class="q">&quot;${dir}literals/literals\056$language&quot;</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">%messages</span><span class="sc">;</span>

    <span class="k">if</span> <span class="s">(</span> <span class="k">-e</span> <span class="i">$messfile</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">open</span><span class="s">(</span> <span class="w">MESS</span><span class="cm">,</span> <span class="i">$messfile</span> <span class="s">)</span><span class="sc">;</span>
        <span class="k">while</span> <span class="s">(</span><span class="q">&lt;MESS&gt;</span><span class="s">)</span> <span class="s">{</span>
            <span class="q">s/\s$//g</span><span class="sc">;</span>
            <span class="k">next</span> <span class="k">if</span> <span class="q">/^#/</span><span class="sc">;</span>
            <span class="k">my</span> <span class="s">(</span> <span class="i">$key</span><span class="cm">,</span> <span class="i">$value</span> <span class="s">)</span> = <span class="k">split</span><span class="s">(</span> <span class="q">/\=/</span><span class="cm">,</span> <span class="i">$_</span> <span class="s">)</span><span class="sc">;</span>
            <span class="k">if</span> <span class="s">(</span><span class="i">$value</span><span class="s">)</span> <span class="s">{</span>
                <span class="i">$key</span> =~ <span class="k">lc</span><span class="s">(</span><span class="i">$key</span><span class="s">)</span><span class="sc">;</span>    <span class="c">#- make key canonic, all lower</span>
                <span class="i">$messages</span>{<span class="i">$key</span>} = <span class="i">$value</span> <span class="k">if</span> <span class="s">(</span> <span class="k">length</span><span class="s">(</span><span class="i">$value</span><span class="s">)</span> <span class="s">)</span><span class="sc">;</span>
            <span class="s">}</span>
            <span class="i">$key</span>   = <span class="q">&quot;&quot;</span><span class="sc">;</span>
            <span class="i">$value</span> = <span class="q">&quot;&quot;</span><span class="sc">;</span>
        <span class="s">}</span>
    <span class="s">}</span> <span class="k">else</span> <span class="s">{</span>
        <span class="i">pretty_caller</span><span class="s">(</span><span class="n">3</span><span class="s">)</span><span class="sc">;</span>
        <span class="i">error</span><span class="s">(</span>
            <span class="i">$language</span><span class="cm">,</span>
<span class="q">&quot;Cannot find messages file:$error $messfile for $language may be missing?&quot;</span><span class="cm">,</span>
            <span class="q">&quot;&quot;</span><span class="cm">,</span>
            <span class="q">&quot;&quot;</span>
        <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">return</span> <span class="i">%messages</span><span class="sc">;</span>
<span class="s">}</span>

</pre><p></p>
<h3><a name="format_for_uk_mobile">format_for_uk_mobile</a></h3>
<p>Make sure everything is in a consistent format
for smsgateway, both gateway and database records</p>
<p>Implies 1 country and may need to be changed for non UK...</p>
<pre>
<a name="format_for_uk_mobile-"></a><span class="k">sub </span><span class="m">format_for_uk_mobile</span> <span class="s">{</span>

    <span class="k">my</span> <span class="s">(</span><span class="i">$input</span><span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>

    <span class="c"># numbers are stored in database as 7855 667524 for example, no zero, no 44</span>
    <span class="i">$input</span> =~ <span class="q">s/^44//</span><span class="sc">;</span>
    <span class="i">$input</span> =~ <span class="q">s/^0//</span><span class="sc">;</span>
    <span class="i">$input</span> =~ <span class="q">s/(\d{4})(\d{5})/$1 $2/</span><span class="sc">;</span>
    <span class="i">$input</span> =~ <span class="q">s/\s+$//</span><span class="sc">;</span>
    <span class="k">return</span> <span class="i">$input</span><span class="sc">;</span>

<span class="s">}</span>

</pre><p></p>
<h3><a name="format_for_standard_mobile">format_for_standard_mobile</a></h3>
<p>Make sure everything is in a consistent format
for smsgateway, both gateway and database records</p>
<p>Numbers are just run together, no spaces, international
format should be used</p>
<p>44 7779 45678 becomes 44777945678, for example</p>
<pre>
<a name="format_for_standard_mobile-"></a><span class="k">sub </span><span class="m">format_for_standard_mobile</span> <span class="s">{</span>

    <span class="k">my</span> <span class="s">(</span><span class="i">$input</span><span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>

    <span class="c"># numbers are stored in database as 447855667524 for example</span>
    <span class="i">$input</span> =~ <span class="q">s/\s+//g</span><span class="sc">;</span>
    <span class="i">$input</span> =~ <span class="q">s/\s+$//</span><span class="sc">;</span>

    <span class="k">return</span> <span class="i">$input</span>

<span class="s">}</span>

</pre><p></p>
<h3><a name="get_os_and_distribution">get_os_and_distribution</a></h3>
<p>FIXME: Duplicated in ccinstall.cgi</p>
<p>Now that the package is widening in application
Need a little precision about the platform
This is not infallible, btw...</p>
<p>If the package flag is set, then the supplied default
configuration should work...</p>
<p>package types
0 unpackaged *nix
1 windows
2 debian
3 probable cpanel guessed via public html</p>
<pre>
<a name="get_os_and_distribution-"></a><span class="k">sub </span><span class="m">get_os_and_distribution</span> <span class="s">{</span>

    <span class="k">my</span> <span class="s">(</span> <span class="i">$os</span><span class="cm">,</span> <span class="i">$distribution</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$checkdir</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$package_type</span> = <span class="n">0</span><span class="sc">;</span>    <span class="c"># 0 is unpackaged *nix, default tarball</span>
    <span class="k">if</span> <span class="s">(</span> <span class="i">$^O</span> =~ <span class="q">/^ms/i</span> <span class="s">)</span> <span class="s">{</span>
        <span class="i">$os</span>           = <span class="q">&#39;windows&#39;</span><span class="sc">;</span>
        <span class="i">$package_type</span> = <span class="n">1</span><span class="sc">;</span>           <span class="c"># 1 is windows</span>
    <span class="s">}</span> <span class="k">elsif</span> <span class="s">(</span> <span class="i">$^O</span> =~ <span class="q">/^linux/i</span> <span class="s">)</span> <span class="s">{</span>
        <span class="i">$os</span> = <span class="q">&#39;linux&#39;</span><span class="sc">;</span>
    <span class="s">}</span> <span class="k">elsif</span> <span class="s">(</span> <span class="i">$^O</span> =~ <span class="q">/^openbsd/i</span> <span class="s">)</span> <span class="s">{</span>
        <span class="i">$os</span> = <span class="q">&#39;openbsd&#39;</span><span class="sc">;</span>
    <span class="s">}</span> <span class="k">else</span> <span class="s">{</span>
        <span class="i">$os</span> = <span class="q">&#39;nocurrentsupport&#39;</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="c"># try and find out distribution</span>
    <span class="k">if</span> <span class="s">(</span> <span class="i">$os</span> <span class="k">eq</span> <span class="q">&#39;linux&#39;</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">my</span> <span class="i">$dist_string</span> = <span class="q">`cat /proc/version`</span><span class="sc">;</span>
        <span class="i">$dist_string</span> =~ <span class="q">m/(fedora|ubuntu|debian|red hat)/i</span><span class="sc">;</span>
        <span class="i">$distribution</span> = <span class="k">lc</span><span class="s">(</span><span class="i">$1</span><span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="c"># if ubuntu or debian, test whether packaged by looking</span>
    <span class="c"># in /usr/share/cclite</span>
    <span class="c">#FIXME: Not quite right because can be debian/ubuntu and in /home</span>
    <span class="c"># if ubuntu or debian, test whether packaged by looking</span>
    <span class="c"># in /usr/share/cclite</span>

    <span class="k">if</span> <span class="s">(</span> <span class="i">$distribution</span> <span class="k">eq</span> <span class="q">&#39;ubuntu&#39;</span> || <span class="i">$distribution</span> <span class="k">eq</span> <span class="q">&#39;debian&#39;</span> <span class="s">)</span> <span class="s">{</span>
        <span class="i">$checkdir</span> = <span class="q">&#39;/usr/share/cclite&#39;</span><span class="sc">;</span>
        <span class="k">if</span> <span class="s">(</span> <span class="k">-e</span> <span class="i">$checkdir</span> <span class="s">)</span> <span class="s">{</span>
            <span class="i">$package_type</span> = <span class="n">2</span><span class="sc">;</span>    <span class="c"># 2 is debian and derivatives</span>
        <span class="s">}</span> <span class="k">else</span> <span class="s">{</span>
            <span class="i">$package_type</span> = <span class="n">3</span><span class="sc">;</span>    <span class="c"># debian/ubuntu but unpackaged</span>
        <span class="s">}</span>
    <span class="s">}</span>

    <span class="c"># guessing at cpanel because the whole thing is under the document root</span>
    <span class="k">my</span> <span class="i">$path</span> = <span class="s">(</span> <span class="i">getcwd</span><span class="s">(</span><span class="s">)</span> || <span class="q">`pwd`</span> <span class="s">)</span> <span class="k">if</span> <span class="s">(</span> <span class="i">$os</span> <span class="k">eq</span> <span class="q">&#39;linux&#39;</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">if</span> <span class="s">(</span> <span class="i">$path</span> =~ <span class="q">/public_html/i</span> &amp;&amp; <span class="i">$os</span> <span class="k">eq</span> <span class="q">&#39;linux&#39;</span> <span class="s">)</span> <span class="s">{</span>
        <span class="i">$distribution</span> .= <span class="q">&#39; probably cpanel&#39;</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">return</span> <span class="s">(</span> <span class="i">$os</span><span class="cm">,</span> <span class="i">$distribution</span><span class="cm">,</span> <span class="i">$package_type</span> <span class="s">)</span><span class="sc">;</span>
<span class="s">}</span>

</pre><p></p>
<h3><a name="check_paths">check_paths</a></h3>
<p>Checks that the path to the cclite libraries
exists and is readable. Returns message, if not.</p>
<p>FIXME: libpath is probably not used now...</p>
<pre>
<a name="check_paths-"></a><span class="k">sub </span><span class="m">check_paths</span> <span class="s">{</span>

    <span class="k">my</span> <span class="s">(</span><span class="i">$package_type</span><span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$message</span><span class="cm">,</span> <span class="i">$libpath</span><span class="cm">,</span> <span class="i">$dir</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$os</span> = <span class="i">$^O</span><span class="sc">;</span>

    <span class="c"># if it&#39;s windows use cd to find the directory</span>
    <span class="k">if</span> <span class="s">(</span> <span class="i">$os</span> =~ <span class="q">/^ms/i</span> <span class="s">)</span> <span class="s">{</span>
        <span class="i">$dir</span> = <span class="i">getcwd</span><span class="s">(</span><span class="s">)</span> || <span class="q">`cd`</span><span class="sc">;</span>
    <span class="s">}</span> <span class="k">else</span> <span class="s">{</span>
        <span class="i">$dir</span> = <span class="i">getcwd</span><span class="s">(</span><span class="s">)</span> || <span class="q">`pwd`</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="c">###print &quot;os is $os dir is $dir&quot; ;</span>
    <span class="k">chomp</span> <span class="i">$dir</span><span class="sc">;</span>
    <span class="i">$dir</span> =~ <span class="q">s/\bcgi-bin.*//</span><span class="sc">;</span>

    <span class="c"># in standard place, so package is -very probably- being used</span>
    <span class="k">if</span> <span class="s">(</span> <span class="i">$dir</span> =~ <span class="q">/^\/usr/</span> &amp;&amp; <span class="i">$package_type</span> == <span class="n">2</span> <span class="s">)</span> <span class="s">{</span>
        <span class="i">$dir</span> = <span class="q">&#39;/usr/share/cclite&#39;</span><span class="sc">;</span>

 <span class="c"># but, if not in standard place, for example in /home, path is preserved 7/2010</span>
    <span class="s">}</span>

    <span class="k">if</span> <span class="s">(</span> !<span class="k">length</span><span class="s">(</span><span class="i">$dir</span><span class="s">)</span> <span class="s">)</span> <span class="s">{</span>
        <span class="i">$message</span> = <span class="h">&lt;&lt;EOT</span><span class="sc">;</span>
<span class="hh"> &lt;h5&gt;Error  in Ccu::check_paths&lt;/h5&gt;</span>
<span class="hh"> Can&#39;t find base dir $dir  does not exist or unreadable?</span>
<span class="hh"> Please fix manually</span>
<span class="h">EOT</span>

    <span class="s">}</span>

    <span class="k">return</span> <span class="s">(</span> <span class="i">$message</span><span class="cm">,</span> <span class="i">$dir</span><span class="cm">,</span> <span class="q">&quot;${dir}lib&quot;</span> <span class="s">)</span><span class="sc">;</span>

<span class="s">}</span>

</pre><p></p>
<h3><a name="make_html_row_contents">make_html_row_contents</a></h3>
<p>Factored out of find_record and get many items in Cclite.pm
Another reason for factoring out, gradual separation of html
part</p>
<p>FIXME: This still contains programmatic hacking around of style sheet...</p>
<p>Since there's no guarantee of order when iterating $tablefields is used to 'steer'</p>
<pre>
<a name="make_html_row_contents-"></a><span class="k">sub </span><span class="m">make_html_row_contents</span> <span class="s">{</span>

    <span class="k">my</span> <span class="s">(</span> <span class="i">$record_counter</span><span class="cm">,</span> <span class="i">$buttons</span><span class="cm">,</span> <span class="i">$tablefields</span><span class="cm">,</span> <span class="i">$hash_ref</span> <span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$row_contents</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">@field_names</span> = <span class="k">split</span><span class="s">(</span> <span class="q">/,/</span><span class="cm">,</span> <span class="i">$tablefields</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">foreach</span> <span class="k">my</span> <span class="i">$field_name</span> <span class="s">(</span><span class="i">@field_names</span><span class="s">)</span> <span class="s">{</span>
        <span class="k">if</span> <span class="s">(</span> <span class="k">length</span><span class="s">(</span> <span class="i">$hash_ref</span>-&gt;{<span class="i">$field_name</span>} <span class="s">)</span> <span class="s">)</span> <span class="s">{</span>
            <span class="i">$row_contents</span> .=
<span class="q">&quot;&lt;td align=\&quot;right\&quot; class=\&quot;pme-key-1\&quot;&gt;$hash_ref-&gt;{$field_name}&lt;/td&gt;&quot;</span><span class="sc">;</span>
        <span class="s">}</span>
    <span class="s">}</span>    <span class="c"># end of pack up row contents</span>

    <span class="c"># push the buttons onto the row...</span>
    <span class="i">$row_contents</span> = <span class="i">$buttons</span> . <span class="i">$row_contents</span><span class="sc">;</span>

    <span class="c"># make stripey styles</span>
    <span class="k">my</span> <span class="i">$row_style</span><span class="sc">;</span>
    <span class="s">(</span> <span class="i">$record_counter</span> % <span class="n">2</span> <span class="s">)</span> ? <span class="s">(</span> <span class="i">$row_style</span> = <span class="q">&quot;odd&quot;</span> <span class="s">)</span> <span class="co">:</span> <span class="s">(</span> <span class="i">$row_style</span> = <span class="q">&quot;even&quot;</span> <span class="s">)</span><span class="sc">;</span>

    <span class="i">$row_contents</span> = <span class="q">&quot;&lt;tr class=\&quot;$row_style\&quot;&gt;$row_contents&lt;/tr&gt;\n&quot;</span><span class="sc">;</span>

    <span class="c"># kludge for debits class in row#</span>
    <span class="c"># this is monolingual and needs to be revisited</span>
    <span class="i">$row_contents</span> =~ <span class="q">s/key-1/key-rejected/g</span>
      <span class="k">if</span> <span class="s">(</span> <span class="i">$row_contents</span> =~ <span class="q">/rejected|declined/</span> <span class="s">)</span><span class="sc">;</span>
    <span class="i">$row_contents</span> =~ <span class="q">s/key-1/key-debit/g</span> <span class="k">if</span> <span class="s">(</span> <span class="i">$row_contents</span> =~ <span class="q">/debit/</span> <span class="s">)</span><span class="sc">;</span>

    <span class="c"># splits that are not declined in orange</span>
    <span class="i">$row_contents</span> =~ <span class="q">s/key-\w+/key-split/g</span>
      <span class="k">if</span> <span class="s">(</span> <span class="i">$row_contents</span> =~ <span class="q">/split/</span> &amp;&amp; <span class="i">$row_contents</span> !~ <span class="q">/declined/</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">return</span> <span class="i">$row_contents</span>

<span class="s">}</span>

</pre><p></p>
<h3><a name="make_html_transaction_totals">make_html_transaction_totals</a></h3>
<pre>
<a name="make_html_transaction_totals-"></a><span class="k">sub </span><span class="m">make_html_transaction_totals</span> <span class="s">{</span>

    <span class="k">my</span> <span class="s">(</span> <span class="i">$total_balance_ref</span><span class="cm">,</span> <span class="i">$total_volume_ref</span><span class="cm">,</span> <span class="i">$messages_ref</span><span class="cm">,</span> <span class="i">$template</span> <span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>

    <span class="k">my</span> <span class="s">(</span> <span class="i">$html</span><span class="cm">,</span> <span class="i">$row_style</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$record_counter</span> = <span class="n">1</span><span class="sc">;</span>

    <span class="c"># keys in both these hashes are currency names</span>
    <span class="k">foreach</span> <span class="k">my</span> <span class="i">$key</span> <span class="s">(</span> <span class="k">keys</span> <span class="i">%$total_balance_ref</span> <span class="s">)</span> <span class="s">{</span>
        <span class="s">(</span> <span class="i">$record_counter</span> % <span class="n">2</span> <span class="s">)</span>
          ? <span class="s">(</span> <span class="i">$row_style</span> = <span class="q">&quot;odd&quot;</span> <span class="s">)</span>
          <span class="co">:</span> <span class="s">(</span> <span class="i">$row_style</span> = <span class="q">&quot;even&quot;</span> <span class="s">)</span><span class="sc">;</span>
        <span class="i">$html</span> .= <span class="h">&lt;&lt;EOT</span><span class="sc">;</span>
<span class="hh">        &lt;tr class=&quot;$row_style&quot;&gt;&lt;td align=\&quot;right\&quot; class=\&quot;pme-key-1\&quot;&gt;\u$key&lt;/td&gt;</span>
<span class="hh">            &lt;td align=\&quot;right\&quot; class=\&quot;pme-key-1\&quot;&gt;$total_balance_ref-&gt;{$key}&lt;/td&gt;</span>
<span class="hh">        &lt;/tr&gt;</span>
<span class="h">EOT</span>
        <span class="i">$record_counter</span>++<span class="sc">;</span>

    <span class="s">}</span>

    <span class="i">$html</span> = <span class="h">&lt;&lt;EOT</span><span class="sc">;</span>
    
<span class="hh">    &lt;table&gt;</span>
<span class="hh">    &lt;tr&gt;&lt;td&gt;$messages_ref-&gt;{&#39;currency&#39;}&lt;/td&gt;&lt;td&gt;$messages_ref-&gt;{&#39;balance&#39;}&lt;/td&gt;&lt;/tr&gt;</span>
<span class="hh">    $html&lt;/table&gt;</span>
<span class="h">EOT</span>

    <span class="i">$template</span> ||= <span class="q">&quot;result.html&quot;</span><span class="sc">;</span>

    <span class="k">return</span> <span class="s">(</span> <span class="i">$html</span><span class="cm">,</span> <span class="i">$template</span> <span class="s">)</span><span class="sc">;</span>

<span class="s">}</span>

</pre><p></p>
<h3><a name="deliver_remote_data">deliver_remote_data</a></h3>
<p>Since, Cclite.pm 'assumes' in most cases that it is dealing
with the traditional html front end, this is an experimental
palliative to deliver self describing hashes and messages
to remote gateways such as Drupal, Elgg, Joomla,Tiki-Wiki and Openclass</p>
<p>It's not a particularly elegant solution but [hopefully] it's
a pragmatic one that preserves some consistency of access and
delivery and doesn't break a lot of fairly useful things in the legacy part...</p>
<p>It does need to distinguish between multdimensional and flat</p>
<p>FIXME: This probably needs replacing by the JSON modules in the medium term,
however this will require non-core modules, something that's avoided so far.</p>
<p>Also, we're probably going introduce a detailed 'status' part with an array
of status objects as of 11/2011. This is in response to complaints by tiki-wiki
that there's no much diagnostic etc. information flowing back in the json
This is also related to improvements in pretty_caller which now becomes pretty_status
and returns an array, as above.</p>
<p>For example, transactions:</p>
<p>{&quot;registry&quot;:&quot;ccliekh_dalston&quot;,&quot;table&quot;: &quot;om_trades&quot;, &quot;message&quot;:&quot;OK&quot;,
&quot;data&quot;: [
{&quot;id&quot;: &quot;95&quot;,
 &quot;tradeSource&quot;:&quot;test2&quot;,
&quot;tradeDestination&quot;:&quot;test1&quot;,
&quot;tradeType&quot;:&quot;debit&quot;,
&quot;tradeDate&quot;:&quot;2011-02-20&quot;,
&quot;tradeId&quot;:&quot;95&quot;,
&quot;tradeMirror&quot;:&quot;ccliekh_dalston&quot;,
&quot;tradeStatus&quot;:&quot;waiting&quot;,
&quot;tradeCurrency&quot;:&quot;dally&quot;,
&quot;tradeAmount&quot;:&quot;23&quot;
},</p>
<p>{&quot;id&quot;: &quot;97&quot;,
 &quot;tradeSource&quot;:&quot;test2&quot;,
&quot;tradeDestination&quot;:&quot;test1&quot;,
&quot;tradeType&quot;:&quot;debit&quot;,
&quot;tradeDate&quot;:&quot;2011-02-20&quot;,
&quot;tradeId&quot;:&quot;97&quot;,
&quot;tradeMirror&quot;:&quot;ccliekh_dalston&quot;,
&quot;tradeStatus&quot;:&quot;waiting&quot;,
&quot;tradeCurrency&quot;:&quot;dally&quot;,
&quot;tradeAmount&quot;:&quot;23&quot;
}]</p>
<p>}</p>
<pre>
<a name="deliver_remote_data-"></a><span class="k">sub </span><span class="m">deliver_remote_data</span> <span class="s">{</span>

    <span class="k">my</span> <span class="s">(</span> <span class="i">$db</span><span class="cm">,</span> <span class="i">$table</span><span class="cm">,</span> <span class="i">$message</span><span class="cm">,</span> <span class="i">$hash_ref</span><span class="cm">,</span> <span class="i">$status</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>    <span class="c">#</span>

    <span class="i">$message</span> ||= <span class="q">&#39;OK&#39;</span><span class="sc">;</span>  <span class="c"># used for status messages to remote, $registry_error...</span>
    <span class="k">my</span> <span class="i">$count</span> = <span class="n">0</span><span class="sc">;</span>      <span class="c"># row counter...</span>

    <span class="k">my</span> <span class="i">$json</span><span class="sc">;</span>           <span class="c">#data delivered to the remote</span>

    <span class="k">my</span> <span class="i">$is_multi_dimensional</span> = <span class="n">0</span><span class="sc">;</span>

    <span class="c"># find whether it&#39;s multidimensional or &#39;flat&#39;</span>
    <span class="k">for</span> <span class="k">my</span> <span class="i">$value</span> <span class="s">(</span> <span class="k">values</span> <span class="i">%$hash_ref</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">if</span> <span class="s">(</span> <span class="q">&#39;HASH&#39;</span> <span class="k">eq</span> <span class="k">ref</span> <span class="i">$value</span> <span class="s">)</span> <span class="s">{</span>
            <span class="i">$is_multi_dimensional</span> = <span class="n">1</span><span class="sc">;</span>
            <span class="k">last</span><span class="sc">;</span>
        <span class="s">}</span>
    <span class="s">}</span>

    <span class="c"># pack up as simple json...</span>
    <span class="k">if</span> <span class="s">(</span><span class="i">$is_multi_dimensional</span><span class="s">)</span> <span class="s">{</span>

        <span class="k">for</span> <span class="k">my</span> <span class="i">$id</span> <span class="s">(</span> <span class="k">keys</span> <span class="i">%$hash_ref</span> <span class="s">)</span> <span class="s">{</span>
            <span class="i">$json</span> .= <span class="q">&quot;\n{\&quot;id\&quot;: \&quot;$id\&quot;,\n &quot;</span><span class="sc">;</span>
            <span class="k">for</span> <span class="k">my</span> <span class="i">$field_name</span> <span class="s">(</span> <span class="k">keys</span> <span class="i">%</span>{ <span class="i">$hash_ref</span>-&gt;{<span class="i">$id</span>} } <span class="s">)</span> <span class="s">{</span>
                <span class="i">$json</span> .=
                  <span class="q">&quot;\&quot;$field_name\&quot;:\&quot;$hash_ref-&gt;{$id}-&gt;{$field_name}\&quot;,\n&quot;</span><span class="sc">;</span>
            <span class="s">}</span>
            <span class="i">$json</span> =~ <span class="q">s/\,\s*$//</span>
              <span class="sc">;</span>    <span class="c"># snip off the last comma in the record, ugly but simple...</span>
            <span class="i">$json</span> .= <span class="q">&quot;},\n&quot;</span><span class="sc">;</span>
        <span class="s">}</span>
        <span class="i">$json</span> =~ <span class="q">s/\,\s*$//</span>
          <span class="sc">;</span>        <span class="c"># snip off the last comma in the record, ugly but simple...</span>
    <span class="s">}</span> <span class="k">else</span> <span class="s">{</span>
        <span class="k">for</span> <span class="k">my</span> <span class="i">$id</span> <span class="s">(</span> <span class="k">keys</span> <span class="i">%$hash_ref</span> <span class="s">)</span> <span class="s">{</span>

            <span class="c"># remove tags, mainly &lt;br&gt;</span>
            <span class="i">$hash_ref</span>-&gt;{<span class="i">$id</span>} =~ <span class="q">s/&lt;[^&gt;]+&gt;/ /g</span><span class="sc">;</span>
            <span class="i">$hash_ref</span>-&gt;{<span class="i">$id</span>} =~ <span class="q">s/[^\w^\s]+/ /g</span><span class="sc">;</span>

            <span class="c"># misteak corrected 20.05.2011, was $id, for the value as well</span>
            <span class="i">$json</span> .= <span class="q">&quot;\n{\&quot;$id\&quot;: \&quot;$hash_ref-&gt;{$id}\&quot;,\n &quot;</span><span class="sc">;</span>

            <span class="i">$json</span> =~ <span class="q">s/\,\s*$//</span>
              <span class="sc">;</span>    <span class="c"># snip off the last comma in the record, ugly but simple...</span>
            <span class="i">$json</span> .= <span class="q">&quot;},\n&quot;</span><span class="sc">;</span>
        <span class="s">}</span>
        <span class="i">$json</span> =~ <span class="q">s/\,\s*$//</span>
          <span class="sc">;</span>        <span class="c"># snip off the last comma in the record, ugly but simple...</span>
    <span class="s">}</span>

<span class="c"># FIXME: status is delivered full-cooked into json via pretty_status, this means</span>
<span class="c"># two places produce json, but they&#39;re both in this module.</span>

    <span class="k">if</span> <span class="s">(</span> !<span class="k">length</span><span class="s">(</span><span class="i">$status</span><span class="s">)</span> <span class="s">)</span> <span class="s">{</span>

        <span class="i">$json</span> = <span class="h">&lt;&lt;EOT</span><span class="sc">;</span>
<span class="hh">  {\&quot;registry&quot;\:\&quot;$db\&quot;,\&quot;table\&quot;: \&quot;$table\&quot;, \&quot;message&quot;:\&quot;$message\&quot;,\n\&quot;data\&quot;: [$json]} </span>
<span class="h">EOT</span>

    <span class="s">}</span> <span class="k">else</span> <span class="s">{</span>

        <span class="i">$json</span> = <span class="h">&lt;&lt;EOT</span><span class="sc">;</span>
<span class="hh">  {\&quot;registry&quot;\:\&quot;$db\&quot;,\&quot;table\&quot;: \&quot;$table\&quot;, \&quot;message&quot;:\&quot;$message\&quot;,$status,\n\&quot;data\&quot;: [$json]} </span>
<span class="h">EOT</span>

    <span class="s">}</span>
    <span class="k">return</span> <span class="i">$json</span><span class="sc">;</span>

<span class="s">}</span>

</pre><p></p>
<h3><a name="sql_timestamp">sql_timestamp</a></h3>
<p>mysql compatible timestamp</p>
<pre>
<a name="sql_timestamp-"></a><span class="k">sub </span><span class="m">sql_timestamp</span> <span class="s">{</span>

    <span class="k">my</span> <span class="s">(</span> <span class="i">$sec</span><span class="cm">,</span> <span class="i">$min</span><span class="cm">,</span> <span class="i">$hour</span><span class="cm">,</span> <span class="i">$mday</span><span class="cm">,</span> <span class="i">$mon</span><span class="cm">,</span> <span class="i">$year</span><span class="cm">,</span> <span class="i">$wday</span><span class="cm">,</span> <span class="i">$yday</span><span class="cm">,</span> <span class="i">$isdst</span> <span class="s">)</span> =
      <span class="k">localtime</span><span class="s">(</span><span class="k">time</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$timestamp</span> = <span class="k">sprintf</span> <span class="q">&quot;%4d-%02d-%02d %02d:%02d:%02d\n&quot;</span><span class="cm">,</span> <span class="i">$year</span> + <span class="n">1900</span><span class="cm">,</span>
      <span class="i">$mon</span> + <span class="n">1</span><span class="cm">,</span> <span class="i">$mday</span><span class="cm">,</span> <span class="i">$hour</span><span class="cm">,</span> <span class="i">$min</span><span class="cm">,</span> <span class="i">$sec</span><span class="sc">;</span>
    <span class="k">return</span> <span class="i">$timestamp</span><span class="sc">;</span>
<span class="s">}</span>

</pre><p></p>
<h3><a name="decide_language">decide_language</a></h3>
<p>Now we're going multilingual need to deal with this in a non-hardcoded fashion
This decides the language:
1. Via cookie, if set
2. fieldsref-&gt;{'language'} if not cookie
3. base cclite.cf language if not 1 and 2, because single country based, usually
4. engleesh if not 1,2,3</p>
<pre>
<a name="decide_language-"></a><span class="k">sub </span><span class="m">decide_language</span> <span class="s">{</span>

    <span class="k">my</span> <span class="s">(</span><span class="i">$fieldsref</span><span class="s">)</span>   = <span class="i">@_</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$cookieref</span>     = <span class="i">get_cookie</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">%configuration</span> = <span class="i">Ccconfiguration::readconfiguration</span><span class="s">(</span><span class="s">)</span>
      <span class="k">if</span> <span class="s">(</span> <span class="i">$0</span> !~ <span class="q">/ccinstall/</span> <span class="s">)</span><span class="sc">;</span>

    <span class="c">#</span>
    <span class="c">#---------------------------------------------------------------------------</span>
    <span class="c"># change the language default here, languages should be ISO 639 lower case</span>
    <span class="c">#</span>
    <span class="k">my</span> <span class="i">$language</span> =
         <span class="i">$cookieref</span>-&gt;{<span class="q">&#39;language&#39;</span>}
      || <span class="i">$fieldsref</span>-&gt;{<span class="q">&#39;language&#39;</span>}
      || <span class="i">$configuration</span>{<span class="q">&#39;language&#39;</span>}
      || <span class="q">&#39;en&#39;</span><span class="sc">;</span>

    <span class="c">#FIXME: remove garbage at end of cookie, probably OK 08/2011&quot;en&quot;</span>
    <span class="i">$language</span> =~ <span class="q">s/[^\w]+$//</span><span class="sc">;</span>

    <span class="k">return</span> <span class="i">$language</span><span class="sc">;</span>

<span class="s">}</span>

</pre><p></p>
<h3><a name="debug_hash_contents">debug_hash_contents</a></h3>
<p>debug the contents of a hash, with stamp for calling routine
Probably should use data dumper, but that's 'yam', yet another module</p>
<pre>
<a name="debug_hash_contents-"></a><span class="k">sub </span><span class="m">debug_hash_contents</span> <span class="s">{</span>

    <span class="k">my</span> <span class="s">(</span><span class="i">$fieldsref</span><span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$x</span><span class="sc">;</span>

    <span class="k">foreach</span> <span class="k">my</span> <span class="i">$hash_key</span> <span class="s">(</span> <span class="k">keys</span> <span class="i">%$fieldsref</span> <span class="s">)</span> <span class="s">{</span>
        <span class="i">$x</span> .= <span class="q">&quot;$hash_key: $fieldsref-&gt;{$hash_key}\n&quot;</span><span class="sc">;</span>

    <span class="s">}</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$package</span><span class="cm">,</span> <span class="i">$filename</span><span class="cm">,</span> <span class="i">$line</span> <span class="s">)</span> = <span class="k">caller</span><span class="sc">;</span>
    <span class="k">return</span><span class="sc">;</span>
<span class="s">}</span>

</pre><p></p>
<h3><a name="debug_message">debug_message</a></h3>
<p>debug the contents of a hash, with stamp for calling routine
Probably should use data dumper, but that's 'yam', yet another module</p>
<pre>
<a name="debug_message-"></a><span class="k">sub </span><span class="m">debug_message</span> <span class="s">{</span>

    <span class="k">my</span> <span class="s">(</span> <span class="i">$message</span><span class="cm">,</span> <span class="i">$dumper</span> <span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$package</span><span class="cm">,</span> <span class="i">$filename</span><span class="cm">,</span> <span class="i">$line</span> <span class="s">)</span> = <span class="k">caller</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">%configuration</span><span class="sc">;</span>

    <span class="k">if</span> <span class="s">(</span> <span class="i">$0</span> !~ <span class="q">/ccinstall/</span> <span class="s">)</span> <span class="s">{</span>
        <span class="i">%configuration</span> = <span class="i">Ccconfiguration::readconfiguration</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="q">`touch $configuration{&#39;debugpath&#39;}`</span> <span class="k">if</span> <span class="s">(</span> !<span class="k">-e</span> <span class="i">$configuration</span>{<span class="q">&#39;debugpath&#39;</span>} <span class="s">)</span><span class="sc">;</span>

    <span class="k">open</span><span class="s">(</span> <span class="k">my</span> <span class="i">$fh</span><span class="cm">,</span> <span class="q">&#39;&gt;&gt;&#39;</span><span class="cm">,</span> <span class="i">$configuration</span>{<span class="q">&#39;debugpath&#39;</span>} <span class="s">)</span> <span class="k">or</span> <span class="k">die</span> <span class="q">&#39;no debug log&#39;</span><span class="sc">;</span>

    <span class="k">if</span> <span class="s">(</span><span class="i">$dumper</span><span class="s">)</span> <span class="s">{</span>
        <span class="k">print</span> <span class="i">$fh</span> <span class="q">&quot;$package $filename $line&quot;</span> . <span class="i">Dumper</span><span class="s">(</span><span class="i">$message</span><span class="s">)</span> . <span class="q">&quot;\n&quot;</span><span class="sc">;</span>
    <span class="s">}</span> <span class="k">else</span> <span class="s">{</span>
        <span class="k">print</span> <span class="i">$fh</span> <span class="q">&quot;$package $filename $line $message\n&quot;</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">close</span> <span class="i">$fh</span><span class="sc">;</span>
    <span class="k">return</span><span class="sc">;</span>
<span class="s">}</span>

</pre><p></p>
<h3><a name="deliver_datatables_data">deliver_datatables_data</a></h3>
<p>Handle returns to datatables via deliver_remote_data, this will deal
with lists of transactions, small ads etc. etc.</p>
<p>Should do anything that is an array of json
objects representing table rows....may not do anything useful with
something that is not organised like this...
=cut</p>
<pre>
<a name="deliver_datatables_data-"></a><span class="k">sub </span><span class="m">deliver_datatables_data</span> <span class="s">{</span>

    <span class="k">my</span> <span class="s">(</span> <span class="i">$hash_ref</span><span class="cm">,</span> <span class="i">$fieldsref</span><span class="cm">,</span> <span class="i">$registry_error</span><span class="cm">,</span> <span class="i">$total</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>

    <span class="c"># turn the database lookup into json..., last one should be $token</span>
    <span class="c"># FIXME: force status from registry error, shouldn&#39;t work that way</span>
    <span class="k">my</span> <span class="i">$status</span> = <span class="n">1</span> <span class="k">if</span> <span class="s">(</span> <span class="k">length</span><span class="s">(</span><span class="i">$registry_error</span><span class="s">)</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$json_array_ref</span> = <span class="i">deliver_remote_data</span><span class="s">(</span>
        <span class="i">$fieldsref</span>-&gt;{<span class="q">&#39;registry&#39;</span>}<span class="cm">,</span>
        <span class="i">$fieldsref</span>-&gt;{<span class="q">&#39;subaction&#39;</span>}<span class="cm">,</span>
        <span class="i">$registry_error</span><span class="cm">,</span> <span class="i">$hash_ref</span><span class="cm">,</span> <span class="i">$status</span><span class="cm">,</span> <span class="i">$token</span>
    <span class="s">)</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$end_array_slice</span> =
      <span class="s">(</span> <span class="i">$fieldsref</span>-&gt;{<span class="q">&#39;iDisplayStart&#39;</span>} + <span class="i">$fieldsref</span>-&gt;{<span class="q">&#39;iDisplayLength&#39;</span>} <span class="s">)</span> - <span class="n">1</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">@slice</span><span class="sc">;</span>
    <span class="k">if</span> <span class="s">(</span> <span class="i">$total</span> &gt;= <span class="i">$end_array_slice</span> <span class="s">)</span> <span class="s">{</span>
        <span class="i">@slice</span> =
          <span class="i">@$json_array_ref</span>[ <span class="i">$fieldsref</span>-&gt;{<span class="q">&#39;iDisplayStart&#39;</span>} .. <span class="i">$end_array_slice</span> ]<span class="sc">;</span>
    <span class="s">}</span> <span class="k">elsif</span> <span class="s">(</span> <span class="i">$total</span> == <span class="n">0</span> <span class="s">)</span> <span class="s">{</span>
        <span class="i">@slice</span> = <span class="s">(</span><span class="s">)</span><span class="sc">;</span>    <span class="c"># this will make datatables display &#39;no data in table&#39;</span>
    <span class="s">}</span> <span class="k">elsif</span> <span class="s">(</span> <span class="i">$total</span> &lt; <span class="i">$end_array_slice</span> <span class="s">)</span> <span class="s">{</span>
        <span class="i">@slice</span> =
          <span class="i">@$json_array_ref</span>[ <span class="i">$fieldsref</span>-&gt;{<span class="q">&#39;iDisplayStart&#39;</span>} .. <span class="s">(</span> <span class="i">$total</span> - <span class="n">1</span> <span class="s">)</span> ]<span class="sc">;</span>
    <span class="s">}</span> <span class="k">else</span> <span class="s">{</span>
        <span class="i">@slice</span> = <span class="i">@$json_array_ref</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="c">#FIXME: This shouldn&#39;t happen but...</span>
    <span class="i">@slice</span> = <span class="k">grep</span> <span class="k">defined</span><span class="cm">,</span> <span class="i">@slice</span><span class="sc">;</span>

    <span class="c"># in the datatables context, give &#39;frosting&#39; otherwise give back raw array</span>
    <span class="c"># to be done raw.html, raw.rss etc...</span>

    <span class="k">my</span> <span class="i">@json</span><span class="sc">;</span>
    <span class="k">if</span> <span class="s">(</span><span class="n">1</span><span class="s">)</span> <span class="s">{</span>
        <span class="i">@json</span> = <span class="i">@$json_array_ref</span><span class="sc">;</span>
    <span class="s">}</span> <span class="k">else</span> <span class="s">{</span>
        <span class="i">@json</span> = <span class="s">[</span>
            <span class="s">{</span>
                <span class="q">&quot;sEcho&quot;</span>                <span class="cm">=&gt;</span> <span class="i">$fieldsref</span>-&gt;{<span class="q">&#39;sEcho&#39;</span>}<span class="cm">,</span>
                <span class="q">&quot;iTotalRecords&quot;</span>        <span class="cm">=&gt;</span> <span class="i">$total</span><span class="cm">,</span>
                <span class="q">&quot;iTotalDisplayRecords&quot;</span> <span class="cm">=&gt;</span> <span class="i">$total</span><span class="cm">,</span>
                <span class="q">&#39;aaData&#39;</span>               <span class="cm">=&gt;</span> \<span class="i">@slice</span>
            <span class="s">}</span>
        <span class="s">]</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="k">return</span> <span class="i">@json</span><span class="sc">;</span>
<span class="s">}</span>

</pre><p></p>
<h3><a name="pretty_status">pretty_status</a></h3>
<p>delivers a json object reporting exactly where the status came from
and the text message. Logs, if required, extended from pretty_caller
which it replaces</p>

<pre>
<a name="pretty_status-"></a><span class="k">sub </span><span class="m">pretty_status</span> <span class="s">{</span>

    <span class="k">my</span> <span class="s">(</span> <span class="i">$i</span><span class="cm">,</span> <span class="i">$status</span><span class="cm">,</span> <span class="i">$do_log</span> <span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>

    <span class="i">$do_log</span> ||= <span class="n">0</span><span class="sc">;</span>

    <span class="k">my</span> <span class="s">(</span>
        <span class="i">$package</span><span class="cm">,</span>   <span class="i">$filename</span><span class="cm">,</span> <span class="i">$line</span><span class="cm">,</span>       <span class="i">$subroutine</span><span class="cm">,</span> <span class="i">$hasargs</span><span class="cm">,</span>
        <span class="i">$wantarray</span><span class="cm">,</span> <span class="i">$evaltext</span><span class="cm">,</span> <span class="i">$is_require</span><span class="cm">,</span> <span class="i">$hints</span><span class="cm">,</span>      <span class="i">$bitmask</span>
    <span class="s">)</span> = <span class="k">caller</span><span class="s">(</span><span class="i">$i</span><span class="s">)</span><span class="sc">;</span>

    <span class="k">return</span>
<span class="q">&quot;{\&quot;p\&quot;:\&quot;$package\&quot;, \&quot;l\&quot;:\&quot;$line\&quot; \&quot;f\&quot;:\&quot;$subroutine\&quot; \&quot;s\&quot;:\&quot;$status\&quot;}&quot;</span><span class="sc">;</span>
<span class="s">}</span>

<span class="n">1</span><span class="sc">;</span>

<a name="EOF-"></a></pre></body>

</html>
