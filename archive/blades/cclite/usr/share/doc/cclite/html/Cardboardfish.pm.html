<?xml version="1.0" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>Cardboardfish.pm</title>
<meta http-equiv="content-type" content="text/html; charset=utf-8" />
<link rev="made" href="mailto:root@localhost" />
</head>

<style type="text/css">
<!--
/* default style sheet generated by perltidy */
body {background: #FFFFFF; color: #000000}
pre { color: #000000; 
      background: #F0F0F0;
      font-family: courier;
    } 

.c  { color: #228B22;} /* comment */
.cm { color: #000000;} /* comma */
.co { color: #000000;} /* colon */
.h  { color: #CD5555; font-weight:bold;} /* here-doc-target */
.hh { color: #CD5555; font-style:italic;} /* here-doc-text */
.i  { color: #00688B;} /* identifier */
.j  { color: #CD5555; font-weight:bold;} /* label */
.k  { color: #8B008B; font-weight:bold;} /* keyword */
.m  { color: #FF0000; font-weight:bold;} /* subroutine */
.n  { color: #B452CD;} /* numeric */
.p  { color: #000000;} /* paren */
.pd { color: #228B22; font-style:italic;} /* pod-text */
.pu { color: #000000;} /* punctuation */
.q  { color: #CD5555;} /* quote */
.s  { color: #000000;} /* structure */
.sc { color: #000000;} /* semicolon */
.v  { color: #B452CD;} /* v-string */
.w  { color: #000000;} /* bareword */
-->
</style>
<body style="background-color: white">
<a name="-top-"></a>
<h1>Cardboardfish.pm</h1>


<!-- INDEX BEGIN -->
<div name="index">
<p><a name="__index__"></a></p>

<ul>

	<li><a href="#name">NAME</a></li>
	<li><a href="#synopsis">SYNOPSIS</a></li>
	<li><a href="#description">DESCRIPTION</a></li>
	<li><a href="#author">AUTHOR</a></li>
	<li><a href="#see_also">SEE ALSO</a></li>
	<li><a href="#copyright">COPYRIGHT</a></li>
	<ul>

		<ul>

			<li><a href="#messagehash">messagehash</a></li>
			<li><a href="#debug_hash_contents">debug_hash_contents</a></li>
			<li><a href="#gateway_sms_transaction">gateway_sms_transaction</a></li>
			<li><a href="#_gateway_sms_pin_change">_gateway_sms_pin_change</a></li>
			<li><a href="#_gateway_sms_pay">_gateway_sms_pay</a></li>
			<li><a href="#_gateway_sms_send_balance">_gateway_sms_send_balance</a></li>
			<li><a href="#sms_message_parse">sms_message_parse</a></li>
			<li><a href="#_check_pin">_check_pin</a></li>
			<li><a href="#_send_sms_mail_message">_send_sms_mail_message</a></li>
			<li><a href="#convert_cardboardfish">convert_cardboardfish</a></li>
			<li><a href="#_send_cardboardfish_sms_receipt">_send_cardboardfish_sms_receipt</a></li>
			<li><a href="#__outbound_cardboardfish_http_sms">__outbound_cardboardfish_http_sms</a></li>
			<li><a href="#_charge_one_sms_unit">_charge_one_sms_unit</a></li>
		</ul>

	</ul>

</ul>

<hr name="index" />
</div>
<!-- INDEX END -->
<h2>Code Index:</h2>
<!-- BEGIN CODE INDEX --><a name="code-index"></a>
<ul>
<li><a href="#package-Ccsms::Cardboardfish-">package Ccsms::Cardboardfish</a>
<ul>
<li><a href="#debug_hash_contents-">debug_hash_contents</a></li>
<li><a href="#gateway_sms_transaction-">gateway_sms_transaction</a></li>
<li><a href="#_gateway_sms_pin_change-">_gateway_sms_pin_change</a></li>
<li><a href="#_gateway_sms_pay-">_gateway_sms_pay</a></li>
<li><a href="#_gateway_sms_send_balance-">_gateway_sms_send_balance</a></li>
<li><a href="#_sms_message_parse-">_sms_message_parse</a></li>
<li><a href="#_check_pin-">_check_pin</a></li>
<li><a href="#_send_sms_mail_message-">_send_sms_mail_message</a></li>
<li><a href="#convert_cardboardfish-">convert_cardboardfish</a></li>
<li><a href="#_send_cardboardfish_sms_receipt-">_send_cardboardfish_sms_receipt</a></li>
<li><a href="#__outbound_cardboardfish_http_sms-">__outbound_cardboardfish_http_sms</a></li>
<li><a href="#_charge_one_sms_unit-">_charge_one_sms_unit</a></li>
<li><a href="#_ascii_to_hex-">_ascii_to_hex</a></li>
<li><a href="#_hex_to_ascii-">_hex_to_ascii</a></li>
</ul>
</li>
<li><a href="#EOF-">EOF</a></li>
</ul>
<!-- END CODE INDEX -->

<p>
</p>
<h1><a name="name">NAME</a></h1>
<p>Cardboardfish.pm</p>
<p>
</p>
<hr />
<h1><a name="synopsis">SYNOPSIS</a></h1>
<p>Transaction conversion interfaces inwards for sms, mail etc.
via commercial sms gateway this will have to be modified
for any new gateway supplier</p>
<p>
</p>
<hr />
<h1><a name="description">DESCRIPTION</a></h1>
<p>This contains the interface for a complete sms based payment
system with pins supplied in the sms messages. The allowed messages are:</p>
<p>This does a small parse of the incoming message:</p>
<p><table cellspacing="0" cellpadding="0"><tr><td>gwNumber  <td>The destination number
<tr><td>originator <td>The sender's number in format 447779159452
<tr><td>message <td>The message body
<tr><td>smsTime <td>Time when the sms was sent
<tr><td><td>Format: YYYY-MM-DD HH:MM:SS
<tr><td>timeZone <td>An integer, indicating time zone
<tr><td><td>(eg: if timeZone is 1 then it means smsTime is GMT + 1)
<tr><td>network <td>Name of the originating network.
<tr><td><td>Will be replaced with an SMSC reference number if the network is not recognised
<tr><td>id <td>A unique identifier for the message
<tr><td>time <td>Time the message received by gateway (UK time)
<tr><td><td>Format: YYYY-MM-DD HH:MM:SS
<tr><td>coding <td>Message coding 7 (normal), 8 (binary) or 16 (unicode)
<tr><td>status <td>0 - Normal Message
<tr><td><td>1 - Concatenated message, sent unconcatenated
<tr><td><td>2 - Indecipherable UDH (possibly corrupt message)</table></p>
<p>status added for error messages</p>
<p>and dispatches to the appropriate internal function</p>
<p>Pin number is always first thing...</p>
<p>SMS Transactions
-&gt; Confirm pin         p123456 confirm
-&gt; Change pin          p123456 change p345678
-&gt; Pay                 p123456 pay 5 to 07855 524667 for stuff (note need to change strip regex)
                       p123456 pay 5 to 07855524667 for other stuff
                       p123456 pay 5 to 4407855 524667 for stuff</p>
<p>-&gt; Query Balance       p123456 balance (not implemented yet will use one credit!)</p>
<p>
</p>
<hr />
<h1><a name="author">AUTHOR</a></h1>
<p>Hugh Barnard</p>
<p>
</p>
<hr />
<h1><a name="see_also">SEE ALSO</a></h1>
<p>Cchooks.pm</p>
<p>
</p>
<hr />
<h1><a name="copyright">COPYRIGHT</a></h1>
<p>(c) Hugh Barnard 2005 - 2008 GPL Licenced</p>
<pre>

=cut</pre>
<pre>
<a name="package-Ccsms::Cardboardfish-"></a><span class="k">package </span><span class="i">Ccsms::Cardboardfish</span><span class="sc">;</span>

<span class="k">use</span> <span class="w">strict</span><span class="sc">;</span>

<span class="c">###use re &#39;debug&#39;;  # debugging for regular expressions, useful for problematic SMS messages</span>

<span class="k">use</span> <span class="w">vars</span> <span class="q">qw(@ISA @EXPORT)</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">Exporter</span><span class="sc">;</span>
<span class="k">my</span> <span class="i">$VERSION</span> = <span class="n">1.00</span><span class="sc">;</span>

<span class="i">@ISA</span> = <span class="q">qw(Exporter)</span><span class="sc">;</span>

<span class="k">use</span> <span class="w">LWP::UserAgent</span><span class="sc">;</span>

<span class="k">use</span> <span class="w">Cclite</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">Cclitedb</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">Ccu</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">Ccsecure</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">Ccconfiguration</span><span class="sc">;</span>    <span class="c"># new style configuration method</span>

<span class="c">###open (STDERR, &quot;&gt;&amp;STDOUT&quot;); # send STDERR out to page, then view source when debugging regular expressions</span>

<span class="i">@EXPORT</span> = <span class="q">qw(</span>
  <span class="q">gateway_sms_transaction</span>
  <span class="q">debug_hash_contents</span>
  <span class="q">convert_cardboardfish</span>
<span class="q">)</span><span class="sc">;</span>

</pre><p></p>
<h3><a name="messagehash">messagehash</a></h3>
<p>this is the provisional solution to the multilingual message fragments
later, it will go somewhere neater
to change these, just substitute a translated hash</p>
<pre>

=cut</pre>
<pre>
<span class="c">#============== change the configuration to your registry and currency for sms</span>

<span class="c"># messages will now use decide_language to get language, in Ccu.pm 08/2011</span>
<span class="k">our</span> <span class="i">%messages</span> = <span class="i">readmessages</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
<span class="k">my</span> <span class="i">%configuration</span>     = <span class="i">readconfiguration</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
<span class="k">my</span> <span class="i">%sms_configuration</span> = <span class="i">readconfiguration</span><span class="s">(</span><span class="q">&#39;../../config/readsms.cf&#39;</span><span class="s">)</span><span class="sc">;</span>

<span class="c"># this is a little unnecessary, but can stay for a while</span>
<span class="k">our</span> <span class="i">$registry</span>     = <span class="i">$sms_configuration</span>{<span class="q">&#39;registry&#39;</span>}<span class="sc">;</span>
<span class="k">our</span> <span class="i">$currency</span>     = <span class="i">$sms_configuration</span>{<span class="q">&#39;currency&#39;</span>}<span class="sc">;</span>
<span class="k">our</span> <span class="i">$sms_user</span>     = <span class="i">$sms_configuration</span>{<span class="q">&#39;sms_user&#39;</span>}<span class="sc">;</span>
<span class="k">our</span> <span class="i">$sms_password</span> = <span class="i">$sms_configuration</span>{<span class="q">&#39;sms_password&#39;</span>}<span class="sc">;</span>

<span class="c"># this is the literal for source address SA in Cardboardfish protocol</span>
<span class="k">our</span> <span class="i">$sms_SA</span>              = <span class="i">$sms_configuration</span>{<span class="q">&#39;sms_SA&#39;</span>}<span class="sc">;</span>
<span class="k">our</span> <span class="i">$sms_sponsor_message</span> = <span class="i">$sms_configuration</span>{<span class="q">&#39;sms_sponsor_message&#39;</span>}<span class="sc">;</span>

<span class="c"># FIXME: need this because the transaction return needs it</span>
<span class="k">my</span> <span class="i">$pages</span> = <span class="w">new</span> <span class="i">HTML::SimpleTemplate</span><span class="s">(</span><span class="q">&quot;$configuration{&#39;templates&#39;}/$language&quot;</span><span class="s">)</span><span class="sc">;</span>

<span class="c">#=============================================================</span>

</pre><p></p>
<h3><a name="debug_hash_contents">debug_hash_contents</a></h3>
<p>debug the contents of a hash, with stamp for calling routine</p>
<pre>
<a name="debug_hash_contents-"></a><span class="k">sub </span><span class="m">debug_hash_contents</span> <span class="s">{</span>

    <span class="k">my</span> <span class="s">(</span><span class="i">$fields_ref</span><span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$x</span><span class="sc">;</span>

    <span class="k">foreach</span> <span class="k">my</span> <span class="i">$hash_key</span> <span class="s">(</span> <span class="k">keys</span> <span class="i">%$fields_ref</span> <span class="s">)</span> <span class="s">{</span>
        <span class="i">$x</span> .= <span class="q">&quot;$hash_key: $fields_ref-&gt;{$hash_key}\n&quot;</span><span class="sc">;</span>

    <span class="s">}</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$package</span><span class="cm">,</span> <span class="i">$filename</span><span class="cm">,</span> <span class="i">$line</span> <span class="s">)</span> = <span class="k">caller</span><span class="sc">;</span>
    <span class="k">return</span><span class="sc">;</span>
<span class="s">}</span>

</pre><p></p>
<h3><a name="gateway_sms_transaction">gateway_sms_transaction</a></h3>
<p>This does a validation (could move to ccvalidate) and
an initial parse of the incoming message and
then dispatches to the appropriate internal function</p>
<pre>
<a name="gateway_sms_transaction-"></a><span class="k">sub </span><span class="m">gateway_sms_transaction</span> <span class="s">{</span>

    <span class="k">my</span> <span class="s">(</span> <span class="i">$class</span><span class="cm">,</span> <span class="i">$configurationref</span><span class="cm">,</span> <span class="i">$fields_ref</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>

    <span class="k">my</span> <span class="s">(</span> <span class="i">$offset</span><span class="cm">,</span> <span class="i">$limit</span><span class="cm">,</span> <span class="i">$pin</span><span class="cm">,</span> <span class="i">$transaction_type</span> <span class="s">)</span><span class="sc">;</span>

    <span class="c"># no originator, so no lookup or no message...reject</span>

    <span class="k">if</span> <span class="s">(</span> !<span class="k">length</span><span class="s">(</span> <span class="i">$fields_ref</span>-&gt;{<span class="q">&#39;originator&#39;</span>} <span class="s">)</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">my</span> <span class="i">$message</span> =
<span class="q">&quot;$fields_ref-&gt;{&#39;message&#39;} from $fields_ref-&gt;{&#39;originator&#39;} $messages{&#39;smsoriginblank&#39;}&quot;</span><span class="sc">;</span>
        <span class="i">log_entry</span><span class="s">(</span> <span class="q">&#39;local&#39;</span><span class="cm">,</span> <span class="i">$registry</span><span class="cm">,</span> <span class="q">&#39;error&#39;</span><span class="cm">,</span> <span class="i">$message</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span><span class="sc">;</span>
        <span class="k">return</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="c"># numbers are stored in database as 447855667524 for example</span>
    <span class="i">$fields_ref</span>-&gt;{<span class="q">&#39;originator&#39;</span>} =
      <span class="i">format_for_standard_mobile</span><span class="s">(</span> <span class="i">$fields_ref</span>-&gt;{<span class="q">&#39;originator&#39;</span>} <span class="s">)</span><span class="sc">;</span>

    <span class="k">my</span> <span class="s">(</span> <span class="i">$error</span><span class="cm">,</span> <span class="i">$from_user_ref</span> <span class="s">)</span> =
      <span class="i">get_where</span><span class="s">(</span> <span class="q">&#39;local&#39;</span><span class="cm">,</span> <span class="i">$registry</span><span class="cm">,</span> <span class="q">&#39;om_users&#39;</span><span class="cm">,</span> <span class="q">&#39;*&#39;</span><span class="cm">,</span> <span class="q">&#39;userMobile&#39;</span><span class="cm">,</span>
        <span class="i">$fields_ref</span>-&gt;{<span class="q">&#39;originator&#39;</span>}<span class="cm">,</span>
        <span class="i">$token</span><span class="cm">,</span> <span class="i">$offset</span><span class="cm">,</span> <span class="i">$limit</span> <span class="s">)</span><span class="sc">;</span>

    <span class="c"># no originator, so no lookup or no message...reject</span>
    <span class="k">if</span> <span class="s">(</span> !<span class="k">length</span><span class="s">(</span> <span class="i">$fields_ref</span>-&gt;{<span class="q">&#39;message&#39;</span>} <span class="s">)</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">my</span> <span class="i">$message</span> =
          <span class="q">&quot;$fields_ref-&gt;{&#39;originator&#39;} $messages{&#39;smsmessageblank&#39;}&quot;</span><span class="sc">;</span>
        <span class="i">log_entry</span><span class="s">(</span> <span class="q">&#39;local&#39;</span><span class="cm">,</span> <span class="i">$registry</span><span class="cm">,</span> <span class="q">&#39;error&#39;</span><span class="cm">,</span> <span class="i">$message</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span><span class="sc">;</span>
        <span class="k">return</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="c"># no one with this number , so no lookup or no message...reject</span>
    <span class="k">if</span> <span class="s">(</span> !<span class="k">length</span><span class="s">(</span> <span class="i">$from_user_ref</span>-&gt;{<span class="q">&#39;userLogin&#39;</span>} <span class="s">)</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">my</span> <span class="i">$message</span> =
          <span class="q">&quot;$fields_ref-&gt;{&#39;originator&#39;} $messages{&#39;smsnumbernotfound&#39;}&quot;</span><span class="sc">;</span>
        <span class="i">log_entry</span><span class="s">(</span> <span class="q">&#39;local&#39;</span><span class="cm">,</span> <span class="i">$registry</span><span class="cm">,</span> <span class="q">&#39;error&#39;</span><span class="cm">,</span> <span class="i">$message</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span><span class="sc">;</span>
        <span class="k">return</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="c"># initial parse to get transaction type</span>
    <span class="k">my</span> <span class="i">$input</span> = <span class="k">lc</span><span class="s">(</span> <span class="i">$fields_ref</span>-&gt;{<span class="q">&#39;message&#39;</span>} <span class="s">)</span><span class="sc">;</span>    <span class="c"># canonical is lower case</span>

    <span class="c"># if it hasn&#39;t got a pin, not worth carrying on, tell user</span>
    <span class="k">if</span> <span class="s">(</span> <span class="i">$input</span> =~ <span class="q">m/^p?(\d+)\s+(\w+)/</span> <span class="s">)</span> <span class="s">{</span>
        <span class="i">$pin</span>              = <span class="i">$1</span><span class="sc">;</span>
        <span class="i">$transaction_type</span> = <span class="i">$2</span><span class="sc">;</span>
    <span class="s">}</span> <span class="k">else</span> <span class="s">{</span>
        <span class="k">my</span> <span class="i">$message</span> =
          <span class="q">&quot;from: $fields_ref-&gt;{&#39;originator&#39;} $input -malformed transaction&quot;</span><span class="sc">;</span>
        <span class="i">log_entry</span><span class="s">(</span> <span class="q">&#39;local&#39;</span><span class="cm">,</span> <span class="i">$registry</span><span class="cm">,</span> <span class="q">&#39;error&#39;</span><span class="cm">,</span> <span class="i">$message</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span><span class="sc">;</span>
        <span class="k">my</span> <span class="s">(</span><span class="i">$mail_error</span><span class="s">)</span> = <span class="i">_send_sms_mail_message</span><span class="s">(</span>
            <span class="q">&#39;local&#39;</span><span class="cm">,</span>
            <span class="i">$registry</span><span class="cm">,</span>
<span class="q">&quot;from: $fields_ref-&gt;{&#39;originator&#39;} $input $messages{smsnopindetected}&quot;</span><span class="cm">,</span>
            <span class="i">$from_user_ref</span>
        <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="c"># can be ok, locked, waiting, fail</span>
    <span class="k">my</span> <span class="i">$pin_status</span> = <span class="i">_check_pin</span><span class="s">(</span> <span class="i">$pin</span><span class="cm">,</span> <span class="i">$transaction_type</span><span class="cm">,</span> <span class="i">$fields_ref</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">return</span> <span class="k">if</span> <span class="s">(</span> <span class="i">$pin_status</span> <span class="k">ne</span> <span class="q">&#39;ok&#39;</span> <span class="s">)</span><span class="sc">;</span>

    <span class="c"># activation is done in _check_pin, these are the allowed operations</span>
    <span class="k">if</span> <span class="s">(</span> <span class="i">$transaction_type</span> <span class="k">eq</span> <span class="q">&#39;confirm&#39;</span> <span class="s">)</span> <span class="s">{</span>    <span class="c">#  p123456 confirm</span>
        <span class="k">return</span> <span class="i">$pin_status</span><span class="sc">;</span>
    <span class="s">}</span> <span class="k">elsif</span> <span class="s">(</span> <span class="i">$transaction_type</span> <span class="k">eq</span> <span class="q">&#39;change&#39;</span> <span class="s">)</span> <span class="s">{</span>    <span class="c"># change pin</span>
        <span class="i">_gateway_sms_pin_change</span><span class="s">(</span> <span class="i">$fields_ref</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span><span class="sc">;</span>

        <span class="c"># allow pay or send as keyword to line up with email style...</span>
    <span class="s">}</span> <span class="k">elsif</span> <span class="s">(</span> <span class="i">$transaction_type</span> <span class="k">eq</span> <span class="q">&#39;pay&#39;</span> || <span class="i">$transaction_type</span> <span class="k">eq</span> <span class="q">&#39;send&#39;</span> <span class="s">)</span>
    <span class="s">{</span>                                              <span class="c"># payment transaction</span>
        <span class="i">_gateway_sms_pay</span><span class="s">(</span> <span class="i">$configurationref</span><span class="cm">,</span> <span class="i">$fields_ref</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span> <span class="k">elsif</span> <span class="s">(</span> <span class="i">$transaction_type</span> <span class="k">eq</span> <span class="q">&#39;balance&#39;</span> <span class="s">)</span> <span class="s">{</span>
        <span class="i">_gateway_sms_send_balance</span><span class="s">(</span> <span class="i">$fields_ref</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span> <span class="k">else</span> <span class="s">{</span>
        <span class="k">my</span> <span class="i">$message</span> =
          <span class="q">&quot;from: $fields_ref-&gt;{&#39;originator&#39;} $input -unrecognised transaction&quot;</span><span class="sc">;</span>
        <span class="i">log_entry</span><span class="s">(</span> <span class="q">&#39;local&#39;</span><span class="cm">,</span> <span class="i">$registry</span><span class="cm">,</span> <span class="q">&#39;error&#39;</span><span class="cm">,</span> <span class="i">$message</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span><span class="sc">;</span>
        <span class="k">return</span> <span class="q">&#39;unrecognisable transaction&#39;</span><span class="sc">;</span>

        <span class="c"># this is a &#39;bad&#39; transaction of some kind...</span>
    <span class="s">}</span>

    <span class="k">return</span><span class="sc">;</span>
<span class="s">}</span>

</pre><p></p>
<h3><a name="_gateway_sms_pin_change_change_pin__same_rules__three_tries__about_pin_locking__cut">_gateway_sms_pin_change
Change pin, same rules (three tries) about pin locking
=cut</a></h3>
<pre>
<a name="_gateway_sms_pin_change-"></a><span class="k">sub </span><span class="m">_gateway_sms_pin_change</span> <span class="s">{</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$fields_ref</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$offset</span><span class="cm">,</span> <span class="i">$limit</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$input</span> = <span class="k">lc</span><span class="s">(</span> <span class="i">$fields_ref</span>-&gt;{<span class="q">&#39;message&#39;</span>} <span class="s">)</span><span class="sc">;</span>    <span class="c"># canonical is lower case</span>
    <span class="i">$input</span> =~ <span class="q">m/^p?(\d+)\s+change\s+p?(\d+)\s*$/</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$new_pin</span>    = <span class="i">$2</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$hashed_pin</span> = <span class="i">text_to_hash</span><span class="s">(</span><span class="i">$new_pin</span><span class="s">)</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$message</span> = <span class="i">$messages</span>{<span class="q">&#39;smspinchanged&#39;</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$error</span><span class="cm">,</span> <span class="i">$from_user_ref</span> <span class="s">)</span> =
      <span class="i">get_where</span><span class="s">(</span> <span class="q">&#39;local&#39;</span><span class="cm">,</span> <span class="i">$registry</span><span class="cm">,</span> <span class="q">&#39;om_users&#39;</span><span class="cm">,</span> <span class="q">&#39;*&#39;</span><span class="cm">,</span> <span class="q">&#39;userMobile&#39;</span><span class="cm">,</span>
        <span class="i">$fields_ref</span>-&gt;{<span class="q">&#39;originator&#39;</span>}<span class="cm">,</span>
        <span class="i">$token</span><span class="cm">,</span> <span class="i">$offset</span><span class="cm">,</span> <span class="i">$limit</span> <span class="s">)</span><span class="sc">;</span>

    <span class="i">$from_user_ref</span>-&gt;{<span class="q">&#39;userPin&#39;</span>}      = <span class="i">$hashed_pin</span><span class="sc">;</span>
    <span class="i">$from_user_ref</span>-&gt;{<span class="q">&#39;userPinTries&#39;</span>} = <span class="n">3</span><span class="sc">;</span>

    <span class="k">my</span> <span class="s">(</span> <span class="i">$dummy</span><span class="cm">,</span> <span class="i">$home_ref</span><span class="cm">,</span> <span class="i">$dummy1</span><span class="cm">,</span> <span class="i">$html</span><span class="cm">,</span> <span class="i">$template</span><span class="cm">,</span> <span class="i">$dummy2</span> <span class="s">)</span> =
      <span class="i">update_database_record</span><span class="s">(</span> <span class="q">&#39;local&#39;</span><span class="cm">,</span> <span class="i">$registry</span><span class="cm">,</span> <span class="q">&#39;om_users&#39;</span><span class="cm">,</span> <span class="n">1</span><span class="cm">,</span> <span class="i">$from_user_ref</span><span class="cm">,</span>
        <span class="i">$token</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">my</span> <span class="s">(</span><span class="i">$mail_error</span><span class="s">)</span> =
      <span class="i">_send_sms_mail_message</span><span class="s">(</span> <span class="q">&#39;local&#39;</span><span class="cm">,</span> <span class="i">$registry</span><span class="cm">,</span> <span class="i">$message</span><span class="cm">,</span> <span class="i">$from_user_ref</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">return</span><span class="sc">;</span>
<span class="s">}</span>

</pre><p></p>
<h3><a name="_gateway_sms_pay">_gateway_sms_pay</a></h3>
<p>Specific transaction written for the tpound
using the gateway messaging gateway, may need modification for other gateways</p>
<pre>
<a name="_gateway_sms_pay-"></a><span class="k">sub </span><span class="m">_gateway_sms_pay</span> <span class="s">{</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$configurationref</span><span class="cm">,</span> <span class="i">$fields_ref</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">%fields</span><span class="cm">,</span> <span class="i">%transaction</span><span class="cm">,</span> <span class="i">$offset</span><span class="cm">,</span> <span class="i">$limit</span><span class="cm">,</span> <span class="i">$class</span><span class="cm">,</span> <span class="i">$pages</span><span class="cm">,</span> <span class="i">@status</span> <span class="s">)</span><span class="sc">;</span>
    <span class="i">%fields</span> = <span class="i">%$fields_ref</span><span class="sc">;</span>

    <span class="k">my</span> <span class="s">(</span> <span class="i">$error</span><span class="cm">,</span> <span class="i">$from_user_ref</span> <span class="s">)</span> =
      <span class="i">get_where</span><span class="s">(</span> <span class="i">$class</span><span class="cm">,</span> <span class="i">$registry</span><span class="cm">,</span> <span class="q">&#39;om_users&#39;</span><span class="cm">,</span> <span class="q">&#39;*&#39;</span><span class="cm">,</span> <span class="q">&#39;userMobile&#39;</span><span class="cm">,</span>
        <span class="i">$fields</span>{<span class="q">&#39;originator&#39;</span>}<span class="cm">,</span> <span class="i">$token</span><span class="cm">,</span> <span class="i">$offset</span><span class="cm">,</span> <span class="i">$limit</span> <span class="s">)</span><span class="sc">;</span>

    <span class="c"># begin parse on whitespace</span>
    <span class="k">my</span> <span class="i">$input</span> = <span class="k">lc</span><span class="s">(</span> <span class="i">$fields</span>{<span class="q">&#39;message&#39;</span>} <span class="s">)</span><span class="sc">;</span>    <span class="c"># canonical is lower case</span>

    <span class="k">my</span> <span class="s">(</span> <span class="i">$parse_type</span><span class="cm">,</span> <span class="i">$transaction_description_ref</span> <span class="s">)</span> =
      <span class="i">_sms_message_parse</span><span class="s">(</span><span class="i">$input</span><span class="s">)</span><span class="sc">;</span>

    <span class="c"># sms pay message didn&#39;t parse, not worth proceeding</span>
    <span class="k">if</span> <span class="s">(</span> <span class="i">$parse_type</span> == <span class="n">0</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">my</span> <span class="i">$message</span> =
<span class="q">&quot;pay attempt from $fields{&#39;originator&#39;} to $transaction_description_ref-&gt;{&#39;tomobilenumber&#39;} : $messages{&#39;smsinvalidsyntax&#39;}&quot;</span><span class="sc">;</span>
        <span class="i">log_entry</span><span class="s">(</span> <span class="q">&#39;local&#39;</span><span class="cm">,</span> <span class="i">$registry</span><span class="cm">,</span> <span class="q">&#39;error&#39;</span><span class="cm">,</span> <span class="i">$message</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span><span class="sc">;</span>
        <span class="k">my</span> <span class="s">(</span><span class="i">$mail_error</span><span class="s">)</span> = <span class="i">_send_sms_mail_message</span><span class="s">(</span> <span class="q">&#39;local&#39;</span><span class="cm">,</span> <span class="i">$registry</span><span class="cm">,</span> <span class="i">$message</span><span class="cm">,</span>
            <span class="i">$from_user_ref</span> <span class="s">)</span><span class="sc">;</span>
        <span class="k">return</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="c"># numbers are stored as 447855667524 for example</span>
    <span class="i">$transaction_description_ref</span>-&gt;{<span class="q">&#39;tomobilenumber&#39;</span>} =
      <span class="i">format_for_standard_mobile</span><span class="s">(</span>
        <span class="i">$transaction_description_ref</span>-&gt;{<span class="q">&#39;tomobilenumber&#39;</span>} <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$error1</span><span class="cm">,</span> <span class="i">$to_user_ref</span> <span class="s">)</span><span class="sc">;</span>

    <span class="c"># contains only figures so it&#39;s a mobile number</span>
    <span class="k">if</span> <span class="s">(</span> <span class="i">$transaction_description_ref</span>-&gt;{<span class="q">&#39;touserormobile&#39;</span>} =~ <span class="q">/^\d+\z/</span> <span class="s">)</span> <span class="s">{</span>
        <span class="s">(</span> <span class="i">$error1</span><span class="cm">,</span> <span class="i">$to_user_ref</span> <span class="s">)</span> =
          <span class="i">get_where</span><span class="s">(</span> <span class="i">$class</span><span class="cm">,</span> <span class="i">$registry</span><span class="cm">,</span> <span class="q">&#39;om_users&#39;</span><span class="cm">,</span> <span class="q">&#39;*&#39;</span><span class="cm">,</span> <span class="q">&#39;userMobile&#39;</span><span class="cm">,</span>
            <span class="i">$transaction_description_ref</span>-&gt;{<span class="q">&#39;touserormobile&#39;</span>}<span class="cm">,</span>
            <span class="i">$token</span><span class="cm">,</span> <span class="i">$offset</span><span class="cm">,</span> <span class="i">$limit</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span> <span class="k">else</span> <span class="s">{</span>

        <span class="c"># else it&#39;s a userLogin ...</span>
        <span class="s">(</span> <span class="i">$error1</span><span class="cm">,</span> <span class="i">$to_user_ref</span> <span class="s">)</span> =
          <span class="i">get_where</span><span class="s">(</span> <span class="i">$class</span><span class="cm">,</span> <span class="i">$registry</span><span class="cm">,</span> <span class="q">&#39;om_users&#39;</span><span class="cm">,</span> <span class="q">&#39;*&#39;</span><span class="cm">,</span> <span class="q">&#39;userLogin&#39;</span><span class="cm">,</span>
            <span class="i">$transaction_description_ref</span>-&gt;{<span class="q">&#39;touserormobile&#39;</span>}<span class="cm">,</span>
            <span class="i">$token</span><span class="cm">,</span> <span class="i">$offset</span><span class="cm">,</span> <span class="i">$limit</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="c"># one of the above lookups fails, reject the whole transaction</span>
    <span class="k">push</span> <span class="i">@status</span><span class="cm">,</span> <span class="i">$messages</span>{<span class="q">&#39;smsnoorigin&#39;</span>}      <span class="k">if</span> <span class="s">(</span> !<span class="k">length</span><span class="s">(</span><span class="i">$from_user_ref</span><span class="s">)</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">push</span> <span class="i">@status</span><span class="cm">,</span> <span class="i">$messages</span>{<span class="q">&#39;smsnodestination&#39;</span>} <span class="k">if</span> <span class="s">(</span> !<span class="k">length</span><span class="s">(</span><span class="i">$to_user_ref</span><span class="s">)</span> <span class="s">)</span><span class="sc">;</span>

    <span class="c"># recipient didn&#39;t confirm pin yet, transaction invalid</span>
    <span class="k">if</span> <span class="s">(</span> <span class="k">length</span><span class="s">(</span> <span class="i">$to_user_ref</span>-&gt;{<span class="q">&#39;userPinStatus&#39;</span>} <span class="s">)</span>
        &amp;&amp; <span class="i">$to_user_ref</span>-&gt;{<span class="q">&#39;userPinStatus&#39;</span>} <span class="k">ne</span> <span class="q">&#39;active&#39;</span> <span class="s">)</span>
    <span class="s">{</span>
        <span class="k">push</span> <span class="i">@status</span><span class="cm">,</span> <span class="i">$messages</span>{<span class="w">smsunconfirmedpin</span>}<span class="sc">;</span>

    <span class="s">}</span>

    <span class="k">my</span> <span class="i">$errors</span> = <span class="k">join</span><span class="s">(</span> <span class="q">&#39;:&#39;</span><span class="cm">,</span> <span class="i">@status</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">if</span> <span class="s">(</span> <span class="k">scalar</span><span class="s">(</span><span class="i">@status</span><span class="s">)</span> &gt; <span class="n">0</span> <span class="s">)</span> <span class="s">{</span>
        <span class="i">_send_sms_mail_message</span><span class="s">(</span> <span class="q">&#39;local&#39;</span><span class="cm">,</span> <span class="i">$registry</span><span class="cm">,</span> <span class="q">&quot;$errors $input&quot;</span><span class="cm">,</span>
            <span class="i">$from_user_ref</span> <span class="s">)</span><span class="sc">;</span>
        <span class="k">my</span> <span class="i">$message</span> =
<span class="q">&quot;pay attempt from $fields{&#39;originator&#39;} to $transaction_description_ref-&gt;{&#39;tomobilenumber&#39;} : $errors&quot;</span><span class="sc">;</span>
        <span class="i">log_entry</span><span class="s">(</span> <span class="q">&#39;local&#39;</span><span class="cm">,</span> <span class="i">$registry</span><span class="cm">,</span> <span class="q">&#39;error&#39;</span><span class="cm">,</span> <span class="i">$message</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span><span class="sc">;</span>
        <span class="k">return</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="c"># convert to standard transaction input format, fields etc.</span>
    <span class="c">#fromregistry : chelsea</span>
    <span class="i">$transaction</span>{<span class="w">fromregistry</span>} = <span class="i">$registry</span><span class="sc">;</span>

    <span class="c"># no home, not a web transaction</span>
    <span class="i">$transaction</span>{<span class="w">home</span>} = <span class="q">&quot;&quot;</span><span class="sc">;</span>

    <span class="c">#subaction : om_trades</span>
    <span class="i">$transaction</span>{<span class="w">subaction</span>} = <span class="q">&#39;om_trades&#39;</span><span class="sc">;</span>

    <span class="c">#toregistry : dalston</span>
    <span class="i">$transaction</span>{<span class="w">toregistry</span>} = <span class="i">$registry</span><span class="sc">;</span>

    <span class="c">#tradeAmount : 23</span>
    <span class="i">$transaction</span>{<span class="w">tradeAmount</span>} = <span class="i">$transaction_description_ref</span>-&gt;{<span class="q">&#39;quantity&#39;</span>}<span class="sc">;</span>

<span class="c">#FIXME: tradeCurrency : if mentioned in sms overrides default: may not be a good idea?</span>
    <span class="i">$transaction</span>{<span class="w">tradeCurrency</span>} = <span class="i">$transaction_description_ref</span>-&gt;{<span class="q">&#39;currency&#39;</span>}
      || <span class="i">$currency</span><span class="sc">;</span>

    <span class="c">#tradeDate : this is date of reception and processing, in fact</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$date</span><span class="cm">,</span> <span class="i">$time</span> <span class="s">)</span> = <span class="i">Ccu::getdateandtime</span><span class="s">(</span> <span class="k">time</span><span class="s">(</span><span class="s">)</span> <span class="s">)</span><span class="sc">;</span>
    <span class="i">$transaction</span>{<span class="w">tradeDate</span>} = <span class="i">$date</span><span class="sc">;</span>

    <span class="c">#tradeTitle : added by this routine: now improved 12/2008</span>
    <span class="i">$transaction</span>{<span class="w">tradeTitle</span>} =
<span class="q">&quot;$messages{&#39;smstransactiontitle&#39;} $from_user_ref-&gt;{&#39;userLogin&#39;} -&gt; $to_user_ref-&gt;{&#39;userLogin&#39;}&quot;</span><span class="sc">;</span>

    <span class="c">#tradeDescription</span>
    <span class="i">$transaction</span>{<span class="w">tradeDescription</span>} =
      <span class="i">$transaction_description_ref</span>-&gt;{<span class="q">&#39;description&#39;</span>}<span class="sc">;</span>

    <span class="c">#tradeDestination : ddawg</span>
    <span class="i">$transaction</span>{<span class="w">tradeDestination</span>} = <span class="i">$to_user_ref</span>-&gt;{<span class="w">userLogin</span>}<span class="sc">;</span>

    <span class="c">#tradeSource : manager</span>
    <span class="i">$transaction</span>{<span class="w">tradeSource</span>} = <span class="i">$from_user_ref</span>-&gt;{<span class="w">userLogin</span>}<span class="sc">;</span>

    <span class="c"># tradestatus from configured initial status</span>
    <span class="i">$transaction</span>{<span class="w">tradeStatus</span>} = <span class="i">$fields</span>{<span class="w">initialPaymentStatus</span>}<span class="sc">;</span>

<span class="c">#FIXME: tradeItem not really identifiable from sms message/possible tax problem too!</span>
    <span class="i">$transaction</span>{<span class="w">tradeItem</span>} = <span class="q">&#39;other&#39;</span><span class="sc">;</span>

 <span class="c">#FIXME: mode for this is csv, this is part of a general format upgrade later...</span>
    <span class="i">$transaction</span>{<span class="w">mode</span>} = <span class="q">&#39;csv&#39;</span><span class="sc">;</span>

    <span class="c"># call ordinary transaction</span>
    <span class="k">my</span> <span class="i">$transaction_ref</span> = \<span class="i">%transaction</span><span class="sc">;</span>

    <span class="k">my</span> <span class="s">(</span> <span class="i">$metarefresh</span><span class="cm">,</span> <span class="i">$home</span><span class="cm">,</span> <span class="i">$error3</span><span class="cm">,</span> <span class="i">$output_message</span><span class="cm">,</span> <span class="i">$page</span><span class="cm">,</span> <span class="i">$c</span> <span class="s">)</span> =
      <span class="i">transaction</span><span class="s">(</span> <span class="q">&#39;sms&#39;</span><span class="cm">,</span> <span class="i">$transaction</span>{<span class="w">fromregistry</span>}<span class="cm">,</span>
        <span class="q">&#39;om_trades&#39;</span><span class="cm">,</span> <span class="i">$transaction_ref</span><span class="cm">,</span> <span class="i">$pages</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span><span class="sc">;</span>

    <span class="c">#build explicative message, transaction can fall at last hurdle</span>
    <span class="c">#</span>
    <span class="k">my</span> <span class="i">$message</span><span class="sc">;</span>

    <span class="k">if</span> <span class="s">(</span> !<span class="k">length</span><span class="s">(</span><span class="i">$error3</span><span class="s">)</span> <span class="s">)</span> <span class="s">{</span>
        <span class="i">$message</span> = <span class="h">&lt;&lt;EOT</span><span class="sc">;</span>
<span class="hh">SMS $messages{&#39;transactionaccepted&#39;} $messages{&#39;to&#39;} $transaction{tradeDestination} $messages{&#39;forvalue&#39;} $transaction{tradeAmount} $transaction{tradeCurrency}</span>
<span class="h">EOT</span>

    <span class="s">}</span> <span class="k">else</span> <span class="s">{</span>

        <span class="i">$message</span> = <span class="h">&lt;&lt;EOT</span><span class="sc">;</span>
<span class="hh">$error3    SMS $messages{&#39;transactionrejected&#39;} $messages{&#39;to&#39;} $transaction{tradeDestination} $messages{&#39;forvalue&#39;} $transaction{tradeAmount} $transaction{tradeCurrency}</span>
<span class="h">EOT</span>

    <span class="s">}</span>

    <span class="i">_send_sms_mail_message</span><span class="s">(</span> <span class="q">&#39;local&#39;</span><span class="cm">,</span> <span class="i">$registry</span><span class="cm">,</span> <span class="i">$message</span><span class="cm">,</span> <span class="i">$from_user_ref</span> <span class="s">)</span><span class="sc">;</span>

   <span class="c"># send SMS receipt, only if turned on for the user...</span>
   <span class="c">#FIXME: doesn&#39;t deal with SMS for failed transactions, does it to be defined!</span>
    <span class="k">if</span> <span class="s">(</span> <span class="i">$to_user_ref</span>-&gt;{<span class="q">&#39;userSmsreceipt&#39;</span>} &amp;&amp; <span class="s">(</span> !<span class="k">length</span><span class="s">(</span><span class="i">$error3</span><span class="s">)</span> <span class="s">)</span> <span class="s">)</span> <span class="s">{</span>

        <span class="i">_send_cardboardfish_sms_receipt</span><span class="s">(</span> <span class="i">$class</span><span class="cm">,</span> <span class="i">$registry</span><span class="cm">,</span> <span class="q">&#39;credit&#39;</span><span class="cm">,</span> <span class="i">$message</span><span class="cm">,</span>
            <span class="i">$from_user_ref</span><span class="cm">,</span> <span class="i">$to_user_ref</span><span class="cm">,</span> <span class="i">$transaction_ref</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="k">return</span><span class="sc">;</span>
<span class="s">}</span>

</pre><p></p>
<h3><a name="_gateway_sms_send_balance">_gateway_sms_send_balance</a></h3>
<p>Send balance, via email at present, sms later...
To be done...</p>
<pre>
<a name="_gateway_sms_send_balance-"></a><span class="k">sub </span><span class="m">_gateway_sms_send_balance</span> <span class="s">{</span>

    <span class="k">my</span> <span class="s">(</span> <span class="i">$fields_ref</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$offset</span><span class="cm">,</span> <span class="i">$limit</span><span class="cm">,</span> <span class="i">$balance_ref</span><span class="cm">,</span> <span class="i">$volume_ref</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">my</span> <span class="s">(</span> <span class="i">$error</span><span class="cm">,</span> <span class="i">$from_user_ref</span> <span class="s">)</span> =
      <span class="i">get_where</span><span class="s">(</span> <span class="q">&#39;local&#39;</span><span class="cm">,</span> <span class="i">$registry</span><span class="cm">,</span> <span class="q">&#39;om_users&#39;</span><span class="cm">,</span> <span class="q">&#39;*&#39;</span><span class="cm">,</span> <span class="q">&#39;userMobile&#39;</span><span class="cm">,</span>
        <span class="i">$fields_ref</span>-&gt;{<span class="q">&#39;originator&#39;</span>}<span class="cm">,</span>
        <span class="i">$token</span><span class="cm">,</span> <span class="i">$offset</span><span class="cm">,</span> <span class="i">$limit</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">%fields</span> = <span class="s">(</span> <span class="q">&#39;userLogin&#39;</span><span class="cm">,</span> <span class="i">$from_user_ref</span>-&gt;{<span class="q">&#39;userLogin&#39;</span>} <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$fields_ref</span> = \<span class="i">%fields</span><span class="sc">;</span>

<span class="c"># html to return html, values to return raw balances and volumes for each currency</span>

    <span class="s">(</span> <span class="i">$balance_ref</span><span class="cm">,</span> <span class="i">$volume_ref</span> <span class="s">)</span> =
      <span class="i">show_balance_and_volume</span><span class="s">(</span> <span class="q">&#39;local&#39;</span><span class="cm">,</span> <span class="i">$registry</span><span class="cm">,</span>
        <span class="i">$from_user_ref</span>-&gt;{<span class="q">&#39;userLogin&#39;</span>}<span class="cm">,</span>
        <span class="q">&#39;values&#39;</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span><span class="sc">;</span>

    <span class="c">###debug_hash_contents($balance_ref) ;</span>
    <span class="c">###debug_hash_contents($volume_ref) ;</span>

    <span class="c"># current balance for this particular currency</span>
    <span class="k">my</span> <span class="i">$balance</span> = <span class="i">$balance_ref</span>-&gt;{<span class="i">$currency</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$balance_message</span> =
<span class="q">&quot;$messages{smsthebalancefor} $from_user_ref-&gt;{userLogin} $messages{at} $registry $messages{is} $balance $currency&quot;</span>
      . <span class="q">&quot;s&quot;</span><span class="sc">;</span>
    <span class="k">my</span> <span class="s">(</span><span class="i">$mail_error</span><span class="s">)</span> =
      <span class="i">_send_sms_mail_message</span><span class="s">(</span> <span class="q">&#39;local&#39;</span><span class="cm">,</span> <span class="i">$registry</span><span class="cm">,</span> <span class="i">$balance_message</span><span class="cm">,</span>
        <span class="i">$from_user_ref</span> <span class="s">)</span><span class="sc">;</span>

    <span class="c"># send SMS balance, only if turned on for the user...new 16.08.2010</span>
    <span class="c"># blank transaction ref, need to make 1 unit sms currency transaction</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">%transaction</span><span class="cm">,</span> <span class="i">$class</span><span class="cm">,</span> <span class="i">$to_user_ref</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">if</span> <span class="s">(</span> <span class="i">$from_user_ref</span>-&gt;{<span class="q">&#39;userSmsreceipt&#39;</span>} <span class="s">)</span> <span class="s">{</span>
        <span class="i">_send_cardboardfish_sms_receipt</span><span class="s">(</span> <span class="i">$class</span><span class="cm">,</span> <span class="i">$registry</span><span class="cm">,</span> <span class="q">&#39;balance&#39;</span><span class="cm">,</span>
            <span class="i">$balance_message</span><span class="cm">,</span> <span class="i">$from_user_ref</span><span class="cm">,</span> <span class="i">$to_user_ref</span><span class="cm">,</span> \<span class="i">%transaction</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="k">return</span><span class="sc">;</span>
<span class="s">}</span>

</pre><p></p>
<h3><a name="sms_message_parse">sms_message_parse</a></h3>
<p>This is now distinct from the transaction preparation etc.</p>
<p>Also, it returns a status, if the parse doesn't contain one
of the necessary elements for a successful transaction. In that
case the transaction -must- fail and it's not worth continuing</p>
<pre>
<a name="_sms_message_parse-"></a><span class="k">sub </span><span class="m">_sms_message_parse</span> <span class="s">{</span>

    <span class="k">my</span> <span class="s">(</span><span class="i">$input</span><span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$save_input</span> = <span class="i">$input</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">%transaction_description</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$parse_type</span> = <span class="n">0</span><span class="sc">;</span>

    <span class="c"># make the parse simpler by stripping pin and keyword</span>
    <span class="i">$input</span> =~ <span class="q">s/^p?(\d+)\s+(send|pay)\s+//</span><span class="sc">;</span>

  <span class="c"># currently allowed sms pay formats, some flexiblity, people won&#39;t remember...</span>
  <span class="c"># 10 to 447779159453|test2</span>

    <span class="i">$parse_type</span> = <span class="n">1</span> <span class="k">if</span> <span class="s">(</span> <span class="i">$input</span> =~ <span class="q">/^(\d+)\s+to\s+(\d{10,12}|\w+)\s*\z/xmis</span> <span class="s">)</span><span class="sc">;</span>

    <span class="c"># 10 limes to 447779159453|test2</span>
    <span class="i">$parse_type</span> = <span class="n">2</span>
      <span class="k">if</span> <span class="s">(</span> <span class="i">$input</span> =~ <span class="q">/^(\d+)\s+(\w+)\s+to\s+(\d{10,12}|\w+)\s*\z/xmis</span> <span class="s">)</span><span class="sc">;</span>

    <span class="c"># 10 to 447779159453|test2 for numbering</span>
    <span class="i">$parse_type</span> = <span class="n">3</span>
      <span class="k">if</span> <span class="s">(</span> <span class="i">$input</span> =~ <span class="q">/^(\d+)\s+to\s+(\d{10,12}|\w+)\s+for\s+(.*)\z/xmis</span> <span class="s">)</span><span class="sc">;</span>

    <span class="c"># 10 limes to 447779159453|test2 for numbering</span>
    <span class="i">$parse_type</span> = <span class="n">4</span>
      <span class="k">if</span> <span class="s">(</span>
        <span class="i">$input</span> =~ <span class="q">/^(\d+)\s+(\w+)\s+to\s+(\d{10,12}|\w+)\s+for\s+(.*)\z/xmis</span> <span class="s">)</span><span class="sc">;</span>

<span class="c"># 10 limes to 447779159453|test2 at dalston for numbering : registry is thrown away, compatiblity with email</span>
    <span class="i">$parse_type</span> = <span class="n">5</span>
      <span class="k">if</span> <span class="s">(</span> <span class="i">$input</span> =~
        <span class="q">/^(\d+)\s+(\w+)\s+to\s+(\d{10,12}|\w+)\s+at\s+(\w+)\s+for\s+(.*)\z/xmis</span>
      <span class="s">)</span><span class="sc">;</span>

    <span class="c"># touserormobile is resolved above when looking up om_users...</span>
    <span class="k">if</span> <span class="s">(</span> <span class="i">$parse_type</span> == <span class="n">1</span> <span class="s">)</span> <span class="s">{</span>
        <span class="i">$transaction_description</span>{<span class="q">&#39;quantity&#39;</span>} = <span class="i">$1</span><span class="sc">;</span>
        <span class="i">$transaction_description</span>{<span class="q">&#39;currency&#39;</span>} =
          <span class="i">$currency</span><span class="sc">;</span>    <span class="c"># taken from top of package</span>
        <span class="i">$transaction_description</span>{<span class="q">&#39;touserormobile&#39;</span>} = <span class="i">$2</span><span class="sc">;</span>

    <span class="s">}</span> <span class="k">elsif</span> <span class="s">(</span> <span class="i">$parse_type</span> == <span class="n">2</span> <span class="s">)</span> <span class="s">{</span>

        <span class="i">$transaction_description</span>{<span class="q">&#39;quantity&#39;</span>} = <span class="i">$1</span><span class="sc">;</span>
        <span class="i">$transaction_description</span>{<span class="q">&#39;currency&#39;</span>} =
          <span class="i">$2</span><span class="sc">;</span>           <span class="c"># FIXME: dangerous, override with $currency?</span>
        <span class="i">$transaction_description</span>{<span class="q">&#39;touserormobile&#39;</span>} = <span class="i">$3</span><span class="sc">;</span>

    <span class="s">}</span> <span class="k">elsif</span> <span class="s">(</span> <span class="i">$parse_type</span> == <span class="n">3</span> <span class="s">)</span> <span class="s">{</span>

        <span class="i">$transaction_description</span>{<span class="q">&#39;quantity&#39;</span>}       = <span class="i">$1</span><span class="sc">;</span>
        <span class="i">$transaction_description</span>{<span class="q">&#39;currency&#39;</span>}       = <span class="i">$currency</span><span class="sc">;</span>
        <span class="i">$transaction_description</span>{<span class="q">&#39;touserormobile&#39;</span>} = <span class="i">$2</span><span class="sc">;</span>
        <span class="i">$transaction_description</span>{<span class="q">&#39;description&#39;</span>}    = <span class="i">$3</span><span class="sc">;</span>

    <span class="s">}</span> <span class="k">elsif</span> <span class="s">(</span> <span class="i">$parse_type</span> == <span class="n">4</span> <span class="s">)</span> <span class="s">{</span>

        <span class="i">$transaction_description</span>{<span class="q">&#39;quantity&#39;</span>} = <span class="i">$1</span><span class="sc">;</span>
        <span class="i">$transaction_description</span>{<span class="q">&#39;currency&#39;</span>} =
          <span class="i">$2</span><span class="sc">;</span>    <span class="c"># FIXME: dangerous, override with $currency?</span>
        <span class="i">$transaction_description</span>{<span class="q">&#39;touserormobile&#39;</span>} = <span class="i">$3</span><span class="sc">;</span>
        <span class="i">$transaction_description</span>{<span class="q">&#39;description&#39;</span>}    = <span class="i">$4</span><span class="sc">;</span>

    <span class="s">}</span> <span class="k">elsif</span> <span class="s">(</span> <span class="i">$parse_type</span> == <span class="n">5</span> <span class="s">)</span> <span class="s">{</span>

        <span class="i">$transaction_description</span>{<span class="q">&#39;quantity&#39;</span>} = <span class="i">$1</span><span class="sc">;</span>
        <span class="i">$transaction_description</span>{<span class="q">&#39;currency&#39;</span>} =
          <span class="i">$2</span><span class="sc">;</span>    <span class="c"># FIXME: dangerous, override with $currency?</span>
        <span class="i">$transaction_description</span>{<span class="q">&#39;touserormobile&#39;</span>} = <span class="i">$3</span><span class="sc">;</span>
        <span class="i">$transaction_description</span>{<span class="q">&#39;registryunused&#39;</span>} =
          <span class="i">$4</span><span class="sc">;</span>    <span class="c"># this is the registry unused at present</span>
        <span class="i">$transaction_description</span>{<span class="q">&#39;description&#39;</span>} = <span class="i">$5</span><span class="sc">;</span>

    <span class="s">}</span> <span class="k">else</span> <span class="s">{</span>

        <span class="k">my</span> <span class="i">$message</span> = <span class="q">&quot;unparsed pay transaction is:$save_input  $input&quot;</span><span class="sc">;</span>
        <span class="i">log_entry</span><span class="s">(</span> <span class="q">&#39;local&#39;</span><span class="cm">,</span> <span class="i">$registry</span><span class="cm">,</span> <span class="q">&#39;error&#39;</span><span class="cm">,</span> <span class="i">$message</span><span class="cm">,</span> <span class="q">&#39;&#39;</span> <span class="s">)</span><span class="sc">;</span>

    <span class="s">}</span>

    <span class="c"># make english language plurals singular for currency, if found...</span>
    <span class="i">$transaction_description</span>{<span class="q">&#39;currency&#39;</span>} =~ <span class="q">s/ies$/y/i</span><span class="sc">;</span>
    <span class="i">$transaction_description</span>{<span class="q">&#39;currency&#39;</span>} =~ <span class="q">s/s$//i</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$x</span> = <span class="k">join</span><span class="s">(</span> <span class="q">&quot;|&quot;</span><span class="cm">,</span> <span class="i">%transaction_description</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">return</span> <span class="s">(</span> <span class="i">$parse_type</span><span class="cm">,</span> \<span class="i">%transaction_description</span> <span class="s">)</span><span class="sc">;</span>

<span class="s">}</span>

</pre><p></p>
<h3><a name="_check_pin">_check_pin</a></h3>
<p>put the pin checking and locking processing into one place
used by every transansaction</p>
<p>returns:
ok 	- pin checks
locked 	- account is locked
waiting - account is not activated/transaction attempt
fail	- pin fail, counts down one off counter/locks if zero</p>
<p>less than 1 is test for try count, just-in-case</p>
<pre>
<a name="_check_pin-"></a><span class="k">sub </span><span class="m">_check_pin</span> <span class="s">{</span>

    <span class="k">my</span> <span class="s">(</span> <span class="i">$pin</span><span class="cm">,</span> <span class="i">$transaction_type</span><span class="cm">,</span> <span class="i">$fields_ref</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$offset</span><span class="cm">,</span> <span class="i">$limit</span><span class="cm">,</span> <span class="i">$mail_error</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$pin_status</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$message</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$hashed_pin</span> = <span class="i">text_to_hash</span><span class="s">(</span><span class="i">$pin</span><span class="s">)</span><span class="sc">;</span>

    <span class="k">my</span> <span class="s">(</span> <span class="i">$error</span><span class="cm">,</span> <span class="i">$from_user_ref</span> <span class="s">)</span> =
      <span class="i">get_where</span><span class="s">(</span> <span class="q">&#39;local&#39;</span><span class="cm">,</span> <span class="i">$registry</span><span class="cm">,</span> <span class="q">&#39;om_users&#39;</span><span class="cm">,</span> <span class="q">&#39;*&#39;</span><span class="cm">,</span> <span class="q">&#39;userMobile&#39;</span><span class="cm">,</span>
        <span class="i">$fields_ref</span>-&gt;{<span class="q">&#39;originator&#39;</span>}<span class="cm">,</span>
        <span class="i">$token</span><span class="cm">,</span> <span class="i">$offset</span><span class="cm">,</span> <span class="i">$limit</span> <span class="s">)</span><span class="sc">;</span>

    <span class="c"># already locked</span>
    <span class="k">if</span> <span class="s">(</span> <span class="i">$from_user_ref</span>-&gt;{<span class="q">&#39;userPinStatus&#39;</span>} <span class="k">eq</span> <span class="q">&#39;locked&#39;</span> <span class="s">)</span> <span class="s">{</span>
        <span class="i">$message</span> = <span class="i">$messages</span>{<span class="q">&#39;smslocked&#39;</span>}<span class="sc">;</span>
        <span class="i">$mail_error</span> = <span class="i">_send_sms_mail_message</span><span class="s">(</span> <span class="q">&#39;local&#39;</span><span class="cm">,</span> <span class="i">$registry</span><span class="cm">,</span> <span class="i">$message</span><span class="cm">,</span>
            <span class="i">$from_user_ref</span> <span class="s">)</span><span class="sc">;</span>
        <span class="k">return</span> <span class="q">&#39;locked&#39;</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="c"># ok, maybe need to reset pin tries though</span>
    <span class="k">if</span> <span class="s">(</span> <span class="i">$transaction_type</span> <span class="k">ne</span> <span class="q">&#39;confirm&#39;</span> <span class="s">)</span> <span class="s">{</span>

        <span class="k">if</span> <span class="s">(</span> <span class="i">$from_user_ref</span>-&gt;{<span class="q">&#39;userPin&#39;</span>} <span class="k">eq</span> <span class="i">$hashed_pin</span> <span class="s">)</span> <span class="s">{</span>
            <span class="i">$pin_status</span> = <span class="q">&#39;ok&#39;</span><span class="sc">;</span>

            <span class="k">return</span> <span class="i">$pin_status</span>
              <span class="k">if</span> <span class="s">(</span> <span class="i">$from_user_ref</span>-&gt;{<span class="q">&#39;userPinTries&#39;</span>} == <span class="n">3</span> <span class="s">)</span>
              <span class="sc">;</span>    <span class="c"># this is the main case</span>
            <span class="i">$from_user_ref</span>-&gt;{<span class="q">&#39;userPinTries&#39;</span>} = <span class="n">3</span><span class="sc">;</span>    <span class="c"># reset to three otherwise</span>

        <span class="s">}</span> <span class="k">elsif</span> <span class="s">(</span> <span class="i">$from_user_ref</span>-&gt;{<span class="q">&#39;userPinTries&#39;</span>} &gt; <span class="n">1</span> <span class="s">)</span> <span class="s">{</span>
            <span class="i">$pin_status</span> = <span class="q">&#39;fail&#39;</span><span class="sc">;</span>
            <span class="i">$message</span>    = <span class="i">$messages</span>{<span class="q">&#39;smspinfail&#39;</span>}<span class="sc">;</span>
            <span class="i">$from_user_ref</span>-&gt;{<span class="q">&#39;userPinTries&#39;</span>}--<span class="sc">;</span>      <span class="c"># used one pin attempt</span>
        <span class="s">}</span> <span class="k">elsif</span> <span class="s">(</span> <span class="i">$from_user_ref</span>-&gt;{<span class="q">&#39;userPinTries&#39;</span>} &lt;= <span class="n">1</span> <span class="s">)</span> <span class="s">{</span>
            <span class="i">$pin_status</span> = <span class="q">&#39;locked&#39;</span><span class="sc">;</span>
            <span class="i">$message</span>    = <span class="q">&quot;$registry: $messages{&#39;smslocked&#39;}&quot;</span><span class="sc">;</span>
            <span class="i">$from_user_ref</span>-&gt;{<span class="q">&#39;userPinStatus&#39;</span>} = <span class="q">&#39;locked&#39;</span><span class="sc">;</span>
            <span class="i">$from_user_ref</span>-&gt;{<span class="q">&#39;userPinTries&#39;</span>}  = <span class="n">0</span><span class="sc">;</span>
        <span class="s">}</span>
    <span class="s">}</span>

    <span class="c"># waiting and confirm</span>
    <span class="k">if</span> <span class="s">(</span>   <span class="s">(</span> <span class="i">$from_user_ref</span>-&gt;{<span class="q">&#39;userPinStatus&#39;</span>} <span class="k">ne</span> <span class="q">&#39;locked&#39;</span> <span class="s">)</span>
        &amp;&amp; <span class="s">(</span> <span class="i">$transaction_type</span> <span class="k">eq</span> <span class="q">&#39;confirm&#39;</span> <span class="s">)</span> <span class="s">)</span>
    <span class="s">{</span>

        <span class="k">if</span> <span class="s">(</span> <span class="i">$from_user_ref</span>-&gt;{<span class="q">&#39;userPin&#39;</span>} <span class="k">eq</span> <span class="i">$hashed_pin</span> <span class="s">)</span> <span class="s">{</span>
            <span class="i">$pin_status</span> = <span class="q">&#39;ok&#39;</span><span class="sc">;</span>
            <span class="i">$message</span>    = <span class="i">$messages</span>{<span class="w">smspinactive</span>}<span class="sc">;</span>
            <span class="i">$from_user_ref</span>-&gt;{<span class="q">&#39;userPinTries&#39;</span>} = <span class="n">3</span><span class="sc">;</span>  <span class="c"># reset or set pin tries to 3</span>
            <span class="i">$from_user_ref</span>-&gt;{<span class="q">&#39;userPinStatus&#39;</span>} = <span class="q">&#39;active&#39;</span><span class="sc">;</span>
        <span class="s">}</span> <span class="k">elsif</span> <span class="s">(</span> <span class="i">$from_user_ref</span>-&gt;{<span class="q">&#39;userPinTries&#39;</span>} &gt; <span class="n">1</span> <span class="s">)</span> <span class="s">{</span>
            <span class="i">$pin_status</span> = <span class="q">&#39;fail&#39;</span><span class="sc">;</span>
            <span class="i">$message</span>    = <span class="i">$messages</span>{<span class="q">&#39;smspinfail&#39;</span>}<span class="sc">;</span>
            <span class="i">$from_user_ref</span>-&gt;{<span class="q">&#39;userPinTries&#39;</span>}--<span class="sc">;</span>    <span class="c"># used one pin attempt</span>
        <span class="s">}</span> <span class="k">elsif</span> <span class="s">(</span> <span class="i">$from_user_ref</span>-&gt;{<span class="q">&#39;userPinTries&#39;</span>} &lt;= <span class="n">1</span> <span class="s">)</span> <span class="s">{</span>
            <span class="i">$pin_status</span>                       = <span class="q">&#39;locked&#39;</span><span class="sc">;</span>
            <span class="i">$from_user_ref</span>-&gt;{<span class="q">&#39;userPinTries&#39;</span>}  = <span class="n">0</span><span class="sc">;</span>
            <span class="i">$message</span>                          = <span class="i">$messages</span>{<span class="q">&#39;smslocked&#39;</span>}<span class="sc">;</span>
            <span class="i">$from_user_ref</span>-&gt;{<span class="q">&#39;userPinStatus&#39;</span>} = <span class="q">&#39;locked&#39;</span><span class="sc">;</span>
        <span class="s">}</span>
    <span class="s">}</span>

    <span class="c"># anything getting to here, needs to update the user record</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$dummy</span><span class="cm">,</span> <span class="i">$home_ref</span><span class="cm">,</span> <span class="i">$dummy1</span><span class="cm">,</span> <span class="i">$html</span><span class="cm">,</span> <span class="i">$template</span><span class="cm">,</span> <span class="i">$dummy2</span> <span class="s">)</span> =
      <span class="i">update_database_record</span><span class="s">(</span> <span class="q">&#39;local&#39;</span><span class="cm">,</span> <span class="i">$registry</span><span class="cm">,</span> <span class="q">&#39;om_users&#39;</span><span class="cm">,</span> <span class="n">1</span><span class="cm">,</span> <span class="i">$from_user_ref</span><span class="cm">,</span>
        <span class="i">$token</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">if</span> <span class="s">(</span> <span class="k">length</span><span class="s">(</span><span class="i">$message</span><span class="s">)</span> <span class="s">)</span> <span class="s">{</span>
        <span class="i">$mail_error</span> = <span class="i">_send_sms_mail_message</span><span class="s">(</span> <span class="q">&#39;local&#39;</span><span class="cm">,</span> <span class="i">$registry</span><span class="cm">,</span> <span class="i">$message</span><span class="cm">,</span>
            <span class="i">$from_user_ref</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="k">return</span> <span class="i">$pin_status</span><span class="sc">;</span>
<span class="s">}</span>

</pre><p></p>
<h3><a name="_send_sms_mail_message">_send_sms_mail_message</a></h3>
<p>wrapper for notify_by_mail in package Cclite
with notification type 4</p>
<p>Within notify_by_mail, if net_smtp is switched on, the registry account rather
than the cclite.cf account is used for the mailout, this is preferred because
it separates 'business' between registries 11/2009</p>
<pre>
<a name="_send_sms_mail_message-"></a><span class="k">sub </span><span class="m">_send_sms_mail_message</span> <span class="s">{</span>

    <span class="k">my</span> <span class="s">(</span> <span class="i">$class</span><span class="cm">,</span> <span class="i">$registry</span><span class="cm">,</span> <span class="i">$message</span><span class="cm">,</span> <span class="i">$from_user_ref</span> <span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$mail_error</span><span class="cm">,</span> <span class="i">$urlstring</span><span class="cm">,</span> <span class="i">$hash</span><span class="cm">,</span> <span class="i">$smtp</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$mail_error</span> = <span class="i">notify_by_mail</span><span class="s">(</span>
        <span class="i">$class</span><span class="cm">,</span>
        <span class="i">$registry</span><span class="cm">,</span>
        <span class="i">$from_user_ref</span>-&gt;{<span class="q">&#39;userName&#39;</span>}<span class="cm">,</span>
        <span class="i">$from_user_ref</span>-&gt;{<span class="q">&#39;userEmail&#39;</span>}<span class="cm">,</span>
        <span class="i">$configuration</span>{<span class="q">&#39;systemmailaddress&#39;</span>}<span class="cm">,</span>
        <span class="i">$configuration</span>{<span class="q">&#39;systemmailreplyaddress&#39;</span>}<span class="cm">,</span>
        <span class="i">$from_user_ref</span>-&gt;{<span class="q">&#39;userLogin&#39;</span>}<span class="cm">,</span>
        <span class="i">$smtp</span><span class="cm">,</span>
        <span class="i">$urlstring</span><span class="cm">,</span>
        <span class="i">$message</span><span class="cm">,</span>
        <span class="n">4</span><span class="cm">,</span>
        <span class="i">$hash</span>
    <span class="s">)</span><span class="sc">;</span>

    <span class="k">return</span> <span class="i">$mail_error</span><span class="sc">;</span>

<span class="s">}</span>

</pre><p></p>
<h3><a name="convert_cardboardfish">convert_cardboardfish</a></h3>
<p>Convert incoming fields as per cardboardfish specification
Now deals with multiple messages parts and more stable data formats...</p>
<p># cardboardfish plugin for this message format
# -1:[SOURCE]:DESTINATION:DCS::DATETIME:[UDH]:[MESSAGE]
#  1#-1:447779159452:447624804344:1::1274627205::53656E6420352020746F20746573743220666F72206261726B696E67</p>
<pre>
<a name="convert_cardboardfish-"></a><span class="k">sub </span><span class="m">convert_cardboardfish</span> <span class="s">{</span>
    <span class="k">my</span> <span class="s">(</span><span class="i">$input</span><span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>

    <span class="i">$input</span> =~ <span class="q">/^(\d+)/</span><span class="sc">;</span>    <span class="c"># this is the count for messages</span>
    <span class="k">my</span> <span class="i">$count</span> = <span class="i">$1</span><span class="sc">;</span>
    <span class="i">$input</span> =~ <span class="q">s/^(\d+)//</span><span class="sc">;</span>    <span class="c"># remove the count</span>

    <span class="k">my</span> <span class="i">@raw_messages</span> = <span class="k">split</span><span class="s">(</span> <span class="q">/\#/</span><span class="cm">,</span> <span class="i">$input</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">@message_hash_refs</span><span class="sc">;</span>

    <span class="k">foreach</span> <span class="k">my</span> <span class="i">$raw_message</span> <span class="s">(</span><span class="i">@raw_messages</span><span class="s">)</span> <span class="s">{</span>
        <span class="k">my</span> <span class="i">%message_hash</span><span class="sc">;</span>
        <span class="s">(</span>
            <span class="i">$message_hash</span>{<span class="q">&#39;status&#39;</span>}<span class="cm">,</span>      <span class="i">$message_hash</span>{<span class="q">&#39;originator&#39;</span>}<span class="cm">,</span>
            <span class="i">$message_hash</span>{<span class="q">&#39;destination&#39;</span>}<span class="cm">,</span> <span class="i">$message_hash</span>{<span class="q">&#39;dcs&#39;</span>}<span class="cm">,</span>
            <span class="i">$message_hash</span>{<span class="q">&#39;notused&#39;</span>}<span class="cm">,</span>     <span class="i">$message_hash</span>{<span class="q">&#39;datetime&#39;</span>}<span class="cm">,</span>
            <span class="i">$message_hash</span>{<span class="q">&#39;udh&#39;</span>}<span class="cm">,</span>         <span class="i">$message_hash</span>{<span class="q">&#39;message&#39;</span>}
        <span class="s">)</span> = <span class="k">split</span><span class="s">(</span> <span class="q">/:/</span><span class="cm">,</span> <span class="i">$raw_message</span> <span class="s">)</span><span class="sc">;</span>

        <span class="i">$message_hash</span>{<span class="q">&#39;message&#39;</span>} = <span class="i">_hex_to_ascii</span><span class="s">(</span> <span class="i">$message_hash</span>{<span class="q">&#39;message&#39;</span>} <span class="s">)</span><span class="sc">;</span>

        <span class="c"># push a reference to this onto a list to be returned</span>
        <span class="k">push</span> <span class="i">@message_hash_refs</span><span class="cm">,</span> \<span class="i">%message_hash</span><span class="sc">;</span>

    <span class="s">}</span>    <span class="c"># endof foreach</span>

    <span class="k">return</span> <span class="s">(</span><span class="i">@message_hash_refs</span><span class="s">)</span><span class="sc">;</span>

<span class="s">}</span>

</pre><p></p>
<h3><a name="_send_cardboardfish_sms_receipt">_send_cardboardfish_sms_receipt</a></h3>
<p>This is specific to cardboardfish and is therefore marked as such
Sends an sms message to confirm payment and send back balances</p>
<pre>
<a name="_send_cardboardfish_sms_receipt-"></a><span class="k">sub </span><span class="m">_send_cardboardfish_sms_receipt</span> <span class="s">{</span>

    <span class="k">my</span> <span class="s">(</span> <span class="i">$class</span><span class="cm">,</span> <span class="i">$registry</span><span class="cm">,</span> <span class="i">$type</span><span class="cm">,</span> <span class="i">$message</span><span class="cm">,</span> <span class="i">$from_user_ref</span><span class="cm">,</span> <span class="i">$to_user_ref</span><span class="cm">,</span>
        <span class="i">$transaction_ref</span> <span class="s">)</span>
      = <span class="i">@_</span><span class="sc">;</span>

    <span class="c">#FIXME: add on sponsor message, if present, need rotating etc. etc.</span>
    <span class="i">$message</span> .= <span class="q">&quot; $sms_configuration{&#39;sms_sponsor_message&#39;}&quot;</span>
      <span class="k">if</span> <span class="s">(</span> <span class="k">length</span><span class="s">(</span> <span class="i">$sms_configuration</span>{<span class="q">&#39;sms_sponsor_message&#39;</span>} <span class="s">)</span> <span class="s">)</span><span class="sc">;</span>

<span class="c">#FIXME: note that SA source address is cclite for balance, maybe same for credit?</span>

    <span class="k">my</span> <span class="i">$urlstring</span><span class="sc">;</span>

    <span class="c">#FIXME: not read properly from the configuration file...</span>
    <span class="i">$sms_configuration</span>{<span class="q">&#39;sms_DR&#39;</span>} ||= <span class="n">0</span><span class="sc">;</span>

<span class="c">#FIXME: note that ST=5 for alphanumeric sender probably needs to be &#39;cclite&#39; for all originating SMSes that needs to be linked to help-desk</span>

    <span class="k">if</span> <span class="s">(</span> <span class="i">$type</span> <span class="k">eq</span> <span class="q">&#39;credit&#39;</span> <span class="s">)</span> <span class="s">{</span>
        <span class="i">$urlstring</span> = <span class="h">&lt;&lt;EOT</span><span class="sc">;</span>
<span class="hh">http://sms2.cardboardfish.com:9001/HTTPSMS?S=H&amp;UN=$sms_user&amp;P=$sms_password&amp;DA=$to_user_ref-&gt;{&#39;userMobile&#39;}&amp;SA=$sms_configuration{&#39;sms_SA&#39;}&amp;M=$message&amp;ST=5&amp;DC=$sms_configuration{&#39;sms_DC&#39;}</span>

<span class="h">EOT</span>

    <span class="s">}</span> <span class="k">elsif</span> <span class="s">(</span> <span class="i">$type</span> = <span class="q">&#39;balance&#39;</span> <span class="s">)</span> <span class="s">{</span>

        <span class="i">$urlstring</span> = <span class="h">&lt;&lt;EOT</span><span class="sc">;</span>
<span class="hh">http://sms2.cardboardfish.com:9001/HTTPSMS?S=H&amp;UN=$sms_user&amp;P=$sms_password&amp;DA=$from_user_ref-&gt;{&#39;userMobile&#39;}&amp;SA=$sms_configuration{&#39;sms_SA&#39;}&amp;M=$message&amp;ST=5&amp;DC=$sms_configuration{&#39;sms_DC&#39;}</span>

<span class="h">EOT</span>

    <span class="s">}</span> <span class="k">else</span> <span class="s">{</span>
        <span class="k">my</span> <span class="i">$message</span> = <span class="q">&quot;unknown or unimplemented sms type: $type&quot;</span><span class="sc">;</span>
        <span class="i">log_entry</span><span class="s">(</span> <span class="q">&#39;local&#39;</span><span class="cm">,</span> <span class="i">$registry</span><span class="cm">,</span> <span class="q">&#39;error&#39;</span><span class="cm">,</span> <span class="i">$message</span><span class="cm">,</span> <span class="q">&#39;&#39;</span> <span class="s">)</span><span class="sc">;</span>
        <span class="k">return</span> <span class="q">&quot;$messages{smserror} $type&quot;</span><span class="sc">;</span>

    <span class="s">}</span>

    <span class="c"># use LWP to send an SMS message via the cardborardfish gateway...</span>
    <span class="k">my</span> <span class="s">(</span><span class="i">$http_response</span><span class="s">)</span> = <span class="i">__outbound_cardboardfish_http_sms</span><span class="s">(</span><span class="i">$urlstring</span><span class="s">)</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$ret</span> = <span class="i">$http_response</span><span class="i">-&gt;code</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>

    <span class="k">if</span> <span class="s">(</span> <span class="i">$http_response</span><span class="i">-&gt;code</span> == <span class="n">200</span> <span class="s">)</span> <span class="s">{</span>
        <span class="i">_charge_one_sms_unit</span><span class="s">(</span> <span class="i">$class</span><span class="cm">,</span> <span class="i">$registry</span><span class="cm">,</span> <span class="i">$type</span><span class="cm">,</span> <span class="i">$from_user_ref</span><span class="cm">,</span>
            <span class="i">$transaction_ref</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span> <span class="k">else</span> <span class="s">{</span>
        <span class="k">my</span> <span class="i">$message</span> = <span class="q">&quot;$messages{smserror} $http_response-&gt;code&quot;</span><span class="sc">;</span>
        <span class="i">log_entry</span><span class="s">(</span> <span class="q">&#39;local&#39;</span><span class="cm">,</span> <span class="i">$registry</span><span class="cm">,</span> <span class="q">&#39;error&#39;</span><span class="cm">,</span> <span class="i">$message</span><span class="cm">,</span> <span class="q">&#39;&#39;</span> <span class="s">)</span><span class="sc">;</span>
        <span class="k">return</span> <span class="q">&quot;$messages{smserror} $http_response-&gt;code&quot;</span><span class="sc">;</span>
    <span class="s">}</span>
<span class="s">}</span>

</pre><p></p>
<h3><a name="__outbound_cardboardfish_http_sms">__outbound_cardboardfish_http_sms</a></h3>
<p>Send the SMS message via a web transaction at carboardfish</p>
<pre>
<a name="__outbound_cardboardfish_http_sms-"></a><span class="k">sub </span><span class="m">__outbound_cardboardfish_http_sms</span> <span class="s">{</span>

    <span class="k">my</span> <span class="s">(</span><span class="i">$sms_url</span><span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$ua</span> = <span class="w">LWP::UserAgent</span><span class="w">-&gt;new</span><span class="sc">;</span>
    <span class="i">$ua</span><span class="i">-&gt;agent</span><span class="s">(</span><span class="q">&quot;cclite\/$configuration{&#39;version&#39;}&quot;</span><span class="s">)</span><span class="sc">;</span>
    <span class="i">$ua</span><span class="i">-&gt;timeout</span><span class="s">(</span><span class="n">10</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$response</span> = <span class="i">$ua</span><span class="i">-&gt;get</span><span class="s">(</span><span class="i">$sms_url</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">return</span> <span class="s">(</span><span class="i">$response</span><span class="s">)</span><span class="sc">;</span>
<span class="s">}</span>

</pre><p></p>
<h3><a name="_charge_one_sms_unit">_charge_one_sms_unit</a></h3>
<p>Transfer an SMS unit from the transaction originator to sysaccount
to account for the sent SMS</p>
<p>$type is 'credit' or 'balance' at present. In the case of balance
need to build up a few transaction fields to charge it..always charged
to originator and monies put into sysaccount...</p>

<pre>
<a name="_charge_one_sms_unit-"></a><span class="k">sub </span><span class="m">_charge_one_sms_unit</span> <span class="s">{</span>

    <span class="k">my</span> <span class="s">(</span> <span class="i">$class</span><span class="cm">,</span> <span class="i">$registry</span><span class="cm">,</span> <span class="i">$type</span><span class="cm">,</span> <span class="i">$from_user_ref</span><span class="cm">,</span> <span class="i">$transaction_ref</span> <span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>

    <span class="c"># for balances, extra fields to fill in are filled anyway by a credit</span>
    <span class="k">if</span> <span class="s">(</span> <span class="i">$type</span> <span class="k">eq</span> <span class="q">&#39;balance&#39;</span> <span class="s">)</span> <span class="s">{</span>

        <span class="c">#subaction : om_trades</span>
        <span class="i">$transaction_ref</span>-&gt;{<span class="q">&#39;subaction&#39;</span>} = <span class="q">&#39;om_trades&#39;</span><span class="sc">;</span>

        <span class="c">#toregistry : dalston</span>
        <span class="i">$transaction_ref</span>-&gt;{<span class="q">&#39;fromregistry&#39;</span>} = <span class="i">$registry</span><span class="sc">;</span>

        <span class="c">#toregistry : dalston</span>
        <span class="i">$transaction_ref</span>-&gt;{<span class="q">&#39;toregistry&#39;</span>} = <span class="i">$registry</span><span class="sc">;</span>

        <span class="i">$transaction_ref</span>-&gt;{<span class="q">&#39;tradeDescription&#39;</span>} =
          <span class="q">&quot;$messages{&#39;smsdebitfor&#39;} $type&quot;</span><span class="sc">;</span>

        <span class="c">#tradeSource : manager</span>
        <span class="i">$transaction_ref</span>-&gt;{<span class="q">&#39;tradeSource&#39;</span>} = <span class="i">$from_user_ref</span>-&gt;{<span class="q">&#39;userLogin&#39;</span>}<span class="sc">;</span>

    <span class="s">}</span>

<span class="c">#FIXME: tradeItem not really identifiable from sms message/possible tax problem too!</span>
    <span class="i">$transaction_ref</span>-&gt;{<span class="q">&#39;tradeItem&#39;</span>} = <span class="q">&#39;other&#39;</span><span class="sc">;</span>

 <span class="c">#FIXME: mode for this is csv, this is part of a general format upgrade later...</span>
    <span class="i">$transaction_ref</span>-&gt;{<span class="q">&#39;mode&#39;</span>} = <span class="q">&#39;csv&#39;</span><span class="sc">;</span>

    <span class="c">#FIXME: tradestatus is always accepted for sms-debit</span>
    <span class="i">$transaction_ref</span>-&gt;{<span class="q">&#39;tradeStatus&#39;</span>} = <span class="q">&#39;accepted&#39;</span><span class="sc">;</span>

    <span class="c"># if HTTP 200, sent OK charge receipt to one unit of sms currency...</span>
    <span class="i">$transaction_ref</span>-&gt;{<span class="q">&#39;tradeAmount&#39;</span>}   = <span class="q">&#39;1&#39;</span><span class="sc">;</span>
    <span class="i">$transaction_ref</span>-&gt;{<span class="q">&#39;tradeCurrency&#39;</span>} = <span class="q">&#39;sms&#39;</span><span class="sc">;</span>

    <span class="c">#tradeDate : this is date of reception and processing, in fact</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$date</span><span class="cm">,</span> <span class="i">$time</span> <span class="s">)</span> = <span class="i">Ccu::getdateandtime</span><span class="s">(</span> <span class="k">time</span><span class="s">(</span><span class="s">)</span> <span class="s">)</span><span class="sc">;</span>
    <span class="i">$transaction_ref</span>-&gt;{<span class="q">&#39;tradeDate&#39;</span>} = <span class="i">$date</span><span class="sc">;</span>

    <span class="c">#tradeTitle : sms debit for sms receipt</span>
    <span class="i">$transaction_ref</span>-&gt;{<span class="q">&#39;tradeTitle&#39;</span>} =
      <span class="q">&quot;$messages{&#39;smsdebitfor&#39;} $messages{&#39;smstransactiontitle&#39;}&quot;</span><span class="sc">;</span>

    <span class="c">#tradeDestination : sysadmin is credited in sms currency</span>
    <span class="i">$transaction_ref</span>-&gt;{<span class="q">&#39;tradeDestination&#39;</span>} = <span class="q">&#39;sysaccount&#39;</span><span class="sc">;</span>

    <span class="c">#FIXME: this should be passed into this subsystem, really...</span>
    <span class="k">my</span> <span class="i">$token</span><span class="sc">;</span>

    <span class="k">my</span> <span class="s">(</span> <span class="i">$metarefresh</span><span class="cm">,</span> <span class="i">$home</span><span class="cm">,</span> <span class="i">$trans_error</span><span class="cm">,</span> <span class="i">$output_message</span><span class="cm">,</span> <span class="i">$page</span><span class="cm">,</span> <span class="i">$c</span> <span class="s">)</span> =
      <span class="i">transaction</span><span class="s">(</span> <span class="q">&#39;sms&#39;</span><span class="cm">,</span> <span class="i">$transaction_ref</span>-&gt;{<span class="q">&#39;fromregistry&#39;</span>}<span class="cm">,</span>
        <span class="q">&#39;om_trades&#39;</span><span class="cm">,</span> <span class="i">$transaction_ref</span><span class="cm">,</span> <span class="i">$pages</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">return</span><span class="sc">;</span>
<span class="s">}</span>

<a name="_ascii_to_hex-"></a><span class="k">sub </span><span class="m">_ascii_to_hex ($)</span> <span class="s">{</span>
    <span class="c">## Convert each ASCII character to a two-digit hex number.</span>
    <span class="s">(</span> <span class="k">my</span> <span class="i">$str</span> = <span class="k">shift</span> <span class="s">)</span> =~ <span class="q">s/(.|\n)/sprintf(&quot;%02lx&quot;, ord $1)/eg</span><span class="sc">;</span>
    <span class="k">return</span> <span class="i">$str</span><span class="sc">;</span>
<span class="s">}</span>

<a name="_hex_to_ascii-"></a><span class="k">sub </span><span class="m">_hex_to_ascii ($)</span> <span class="s">{</span>
    <span class="c">## Convert each two-digit hex number back to an ASCII character.</span>
    <span class="s">(</span> <span class="k">my</span> <span class="i">$str</span> = <span class="k">shift</span> <span class="s">)</span> =~ <span class="q">s/([a-fA-F0-9]{2})/chr(hex $1)/eg</span><span class="sc">;</span>
    <span class="k">return</span> <span class="i">$str</span><span class="sc">;</span>
<span class="s">}</span>

<span class="n">1</span><span class="sc">;</span>

<a name="EOF-"></a></pre></body>

</html>
