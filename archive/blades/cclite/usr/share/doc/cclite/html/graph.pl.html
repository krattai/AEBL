<?xml version="1.0" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>graph.pl</title>
<meta http-equiv="content-type" content="text/html; charset=utf-8" />
<link rev="made" href="mailto:root@localhost" />
</head>

<style type="text/css">
<!--
/* default style sheet generated by perltidy */
body {background: #FFFFFF; color: #000000}
pre { color: #000000; 
      background: #F0F0F0;
      font-family: courier;
    } 

.c  { color: #228B22;} /* comment */
.cm { color: #000000;} /* comma */
.co { color: #000000;} /* colon */
.h  { color: #CD5555; font-weight:bold;} /* here-doc-target */
.hh { color: #CD5555; font-style:italic;} /* here-doc-text */
.i  { color: #00688B;} /* identifier */
.j  { color: #CD5555; font-weight:bold;} /* label */
.k  { color: #8B008B; font-weight:bold;} /* keyword */
.m  { color: #FF0000; font-weight:bold;} /* subroutine */
.n  { color: #B452CD;} /* numeric */
.p  { color: #000000;} /* paren */
.pd { color: #228B22; font-style:italic;} /* pod-text */
.pu { color: #000000;} /* punctuation */
.q  { color: #CD5555;} /* quote */
.s  { color: #000000;} /* structure */
.sc { color: #000000;} /* semicolon */
.v  { color: #B452CD;} /* v-string */
.w  { color: #000000;} /* bareword */
-->
</style>
<body style="background-color: white">
<a name="-top-"></a>
<h1>graph.pl</h1>


<!-- INDEX BEGIN -->
<div name="index">
<p><a name="__index__"></a></p>

<ul>

	<li><a href="#graph_pl">graph.pl</a></li>
	<li><a href="#synopsis">SYNOPSIS</a></li>
	<li><a href="#description">DESCRIPTION</a></li>
	<li><a href="#copyright">COPYRIGHT</a></li>
	<ul>

		<ul>

			<li><a href="#save_chart">save_chart</a></li>
			<li><a href="#make_graph">make_graph</a></li>
		</ul>

	</ul>

</ul>

<hr name="index" />
</div>
<!-- INDEX END -->
<h2>Code Index:</h2>
<!-- BEGIN CODE INDEX --><a name="code-index"></a>
<ul>
<li><a href="#__END__-">__END__</a></li>
<li><a href="#EOF-">EOF</a></li>
</ul>
<!-- END CODE INDEX -->

<pre>#!/usr/bin/perl 

<span class="i">$test</span> = <span class="n">1</span><span class="sc">;</span>
<span class="k">if</span> <span class="s">(</span><span class="i">$test</span><span class="s">)</span> <span class="s">{</span>
    <span class="k">print</span> <span class="i">STDOUT</span> <span class="q">&quot;Content-type: text/html\n\n&quot;</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$data</span> = <span class="k">join</span><span class="s">(</span> <span class="q">&#39;&#39;</span><span class="cm">,</span> <span class="q">&lt;DATA&gt;</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">eval</span> <span class="i">$data</span><span class="sc">;</span>
    <span class="k">if</span> <span class="s">(</span><span class="i">$@</span><span class="s">)</span> <span class="s">{</span>
        <span class="k">print</span> <span class="i">$@</span><span class="sc">;</span>
        <span class="k">exit</span> <span class="n">1</span><span class="sc">;</span>
    <span class="s">}</span>
<span class="s">}</span>

<a name="__END__-"></a><span class="k">__END__</span>


</pre><p></p>
<hr />
<h1><a name="graph_pl">graph.pl</a></h1>
<p>Simple graphing for cclite</p>
<p>---------------------------------------------------------------------------
THE cclite SOFTWARE IS PROVIDED TO YOU &quot;AS IS,&quot; AND WE MAKE NO EXPRESS
OR IMPLIED WARRANTIES WHATSOEVER WITH RESPECT TO ITS FUNCTIONALITY,
OPERABILITY, OR USE, INCLUDING, WITHOUT LIMITATION,
ANY IMPLIED WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE, OR INFRINGEMENT.
WE EXPRESSLY DISCLAIM ANY LIABILITY WHATSOEVER FOR ANY DIRECT,
INDIRECT, CONSEQUENTIAL, INCIDENTAL OR SPECIAL DAMAGES,
INCLUDING, WITHOUT LIMITATION, LOST REVENUES, LOST PROFITS,
LOSSES RESULTING FROM BUSINESS INTERRUPTION OR LOSS OF DATA,
REGARDLESS OF THE FORM OF ACTION OR LEGAL THEORY UNDER
WHICH THE LIABILITY MAY BE ASSERTED,
EVEN IF ADVISED OF THE POSSIBILITY OR LIKELIHOOD OF SUCH DAMAGES.
---------------------------------------------------------------------------</p>
<p>these batch scripts are kept as eval &lt;whole-of-script&gt;, if they fail they print their problems
onto the status web page</p>
<p>
</p>
<hr />
<h1><a name="synopsis">SYNOPSIS</a></h1>
<p>
</p>
<hr />
<h1><a name="description">DESCRIPTION</a></h1>
<p>This is a simple graph of transaction size an volumes for a given
registry, it is run as a time job within the admin menu</p>
<p>This is still a work in progress, may go to gnuplot, flot dygraph
or rrdtool</p>
<p>
</p>
<hr />
<h1><a name="copyright">COPYRIGHT</a></h1>
<p>Copyright 2005 -2011 Hugh Barnard.</p>
<p>Permission is granted to copy, distribute and/or modify this 
document under the terms of the GNU Free Documentation 
License, Version 1.2 or any later version published by the 
Free Software Foundation; with no Invariant Sections, with 
no Front-Cover Texts, and with no Back-Cover Texts.</p>
<p>
</p>
<h3><a name="save_chart">save_chart</a></h3>
<p>Writes the file, should die and complain on the
management page, if something goes wrong</p>
<pre>

<span class="q">sub save_chart</span>
<span class="q">{</span>
<span class="q">	my ($chart,$name,$ext) = @_ ;</span>
	
<span class="q">	local(*OUT);</span>
<span class="q">	open(OUT, &quot;&gt;$name.$ext&quot;) or </span>
<span class="q">		die &quot;Cannot open $name.$ext for write: $!&quot;;</span>
<span class="q">	binmode OUT;</span>
<span class="q">	print OUT $chart-&gt;$ext();;</span>
<span class="q">	close OUT;</span>
<span class="q">}</span>


</pre><p></p>
<h3><a name="make_graph">make_graph</a></h3>
<p>width
height
title
x_label
y_label
draw_grid
draw_border
draw_tic_labels
draw_data_labels
transparent
grid_on_top
binary
data_label_style
thickness
skip_undefined
boxwidth</p>

<pre>

<span class="q">sub make_graph {</span>

<span class="q">  my ($x_label,$array_ref, $y_label,$xskip) = @_ ;</span>
<span class="q">  my $timestamp = sql_timestamp() ;</span>
<span class="q">  my $graph ;</span>
<span class="q">  my $title = &quot;Last updated at $timestamp&quot; ;</span>
  
<span class="q">  my $ch = Chart::Strip-&gt;new(</span>
<span class="q">                 title   =&gt; $title,</span>
<span class="q">                 &#39;x_label&#39; =&gt; $x_label,</span>
<span class="q">                 &#39;y_label&#39; =&gt; $y_label,</span>
<span class="q">                 &#39;skip_undefined&#39; =&gt; $xskip,</span>
<span class="q">                 &#39;transparent&#39; =&gt; 0,</span>
<span class="q">             );</span>

<span class="q">    $ch-&gt;add_data( $array_ref, { style =&gt; &#39;line&#39;,</span>
<span class="q">                                  color =&gt; &#39;000000&#39;,</span>
<span class="q">                                  label =&gt; &#39;&#39; } );</span>

<span class="q">    return $ch ;</span>
<span class="q">}</span>

<span class="q">#=============================================================================================</span>
<span class="q"># Main part of script....this will need  which chart strip uses GD</span>
<span class="q">#=============================================================================================</span>

<span class="q">use strict ;</span>
<span class="q">use lib &#39;../../../lib&#39;;</span>

<span class="q">use Cccookie ;</span>
<span class="q">use Ccu ;</span>
<span class="q">use Ccconfiguration ;</span>
				
<span class="q">use strict ;</span>
<span class="q">use Cclitedb;</span>

<span class="q">use Chart::Strip;</span>
<span class="q">use Data::Dumper ;</span>


<span class="q">our %configuration = readconfiguration();</span>

<span class="q">my $cookieref = get_cookie();</span>
<span class="q">my %fields    = cgiparse();</span>

<span class="q"># message language now decided by decide_language 08/2011</span>
<span class="q">our %messages = readmessages();</span>

<span class="q"># you&#39;ll have to hardwire this, if running from cron</span>
<span class="q">my $registry = $cookieref-&gt;{registry} || &#39;dalston&#39; ;</span>

<span class="q"># charts are kept per registry in public html....</span>
<span class="q">my $chartdir = &quot;$configuration{htmlpath}/images/charts/$registry&quot; ;</span>

<span class="q">if (-e $chartdir &amp;&amp; -w $chartdir) {</span>
<span class="q">} else {</span>
<span class="q">  print &quot;$chartdir does not exist or is not writable\n&quot;;</span>
<span class="q">  exit 1 ;</span>
<span class="q">}</span>

<span class="q"># name is chart name</span>
<span class="q">my $name  ;</span>
<span class="q"># value before token is how many hours back to go...</span>
<span class="q">my $hours_back = 168; # how many hours back to go</span>
<span class="q"># type is minutes, hours, days.</span>
<span class="q">my $type = &#39;minutes&#39; ;</span>

<span class="q"> my $averages_array_ref = get_raw_stats_data ( &#39;local&#39;, $registry, $hours_back, &#39;average&#39;, $type, &#39;&#39; );</span>
<span class="q"> my $volumes_array_ref = get_raw_stats_data ( &#39;local&#39;, $registry, $hours_back, &#39;volume&#39;, $type, &#39;&#39; );</span>
 
<span class="q"> #print &quot;a then v&quot; ;</span>
<span class="q"> # print Dumper($volumes_array_ref);</span>

 
<span class="q"> $name = &quot;$chartdir/transactions&quot; ; </span>
<span class="q"> my $chart = make_graph  (&#39;time&#39;,$averages_array_ref, &#39;average transaction value&#39;,1) ;</span>
<span class="q"> save_chart ($chart,$name,&#39;png&#39;);</span>
<span class="q"> $name = &quot;$chartdir/volumes&quot; ;</span>
<span class="q"> my $chart = make_graph  (&#39;time&#39;,$volumes_array_ref, &#39;trade volume&#39;,1) ;</span>
<span class="q"> save_chart ($chart,$name,&#39;png&#39;);</span>

<span class="q">my $updated = sql_timestamp() ;</span>
<span class="q">#print &quot;$messages{statsupdate} $updated&quot; ;</span>
<span class="q">exit 0 ;</span>




<a name="EOF-"></a></pre></body>

</html>
